#"F:\OneDrive - NTNU\R-4.3.2\bin\Rscript.exe" C:\Users\animeshs\OneDrive\Desktop\Scripts\diffExprSeq.r L:\promec\Animesh\TK\hg38lall\star_salmon\
args = commandArgs(trailingOnly=TRUE)
print(paste("supplied argument(s):", length(args)))
print(args)
#setup####
#install.packages("BiocManager")
#install.packages("pheatmap")
#BiocManager::install("limma")
#BiocManager::install("edgeR")
library(limma)
library(edgeR)
#data####
inpD <- args[1]
inpD<-"L:/promec/Animesh/TK/hg38lall/star_salmon/"
inpF<-"salmon.merged.gene_counts_length_scaled.tsv"
countTable = read.table(paste0(inpD,inpF),header=TRUE,row.names=1)
colnames(countTable)
summary(countTable)
pdf(paste(inpD,inpF,"plots","pdf",sep = "."))
#select####
countTableSel=countTable[,grep("TK",colnames(countTable))]
summary(countTableSel)
colnames(countTableSel)
colnames(countTableSel)=gsub("TK9","TK9_",colnames(countTableSel))
colnames(countTableSel)
colnames(countTableSel)=gsub("TK10","TK10_",colnames(countTableSel))
colnames(countTableSel)
colnames(countTableSel)=gsub("TK12","TK12_",colnames(countTableSel))
colnames(countTableSel)
colnames(countTableSel)=gsub("TK13","TK13_",colnames(countTableSel))
colnames(countTableSel)
colnames(countTableSel)=gsub("TK14","TK14_",colnames(countTableSel))
colnames(countTableSel)
colnames(countTableSel)=gsub("TK16","TK16_",colnames(countTableSel))
colnames(countTableSel)
colnames(countTableSel)=gsub("TK18","TK18_",colnames(countTableSel))
colnames(countTableSel)
summary(countTableSel)
hist(sapply(countTableSel,as.numeric))
par(mar=c(12,3,1,1))
boxplot(countTableSel,las=2,main="countTableSel")
#sampleSlog2####
log2countTableSel=log2(countTableSel)
log2countTableSel[log2countTableSel==-Inf]<-NA
summary(log2countTableSel)
boxplot(log2countTableSel,las=2,main="log2countTableSel")
hist(log2countTableSel[,1])
hist(sapply(log2countTableSel,as.numeric))
#sampleSmedian####
label<-data.frame(Bio=sapply(strsplit(colnames(countTableSel),"_",fixed=T),'[[',1))
label$Group<-colnames(countTableSel)
table(label$Bio)
table(label$Group)
repColLFQ <- data.frame(matrix(ncol=length(names(table(label$Bio))),nrow=nrow(countTableSel)))
colnames(repColLFQ) <- names(table(label$Bio))
rownames(repColLFQ)<-rownames(countTableSel)
for(i in names(table(label$Bio))){
  print(i)
  valsLFQ<-data.frame(countTableSel[,label[label$Bio==i,"Group"]])
  print(summary(valsLFQ))
  repColLFQ[i]<-apply(valsLFQ,1, function(x) sum(x,na.rm=T))
  print(summary(repColLFQ[i]))
  hist(as.matrix(repColLFQ[i]))
}
summary(repColLFQ)
write.csv(repColLFQ,paste0(inpD,inpF,".repColLFQ.csv"))
colnames(repColLFQ)
repColLFQ$TK9<-NULL
condition = factor( c("NS","NS","S","S","S","NS"))
#condition = factor( c("NS","NS","S","S","S","NS","NS"))
print(condition)
des = model.matrix(~-1+condition)
colnames(des) = levels(condition)
cmat <- makeContrasts(S - NS, levels=des)
dge <- DGEList(counts=repColLFQ)
dge <- calcNormFactors(dge)
v <- voom(dge,design=des, normalize.method = "quantile",plot=TRUE)
#v <- voom(dge,design=des, plot=TRUE)
heatmap(cor(v[["E"]]))
pheatmap::pheatmap(cor(v[["E"]]))
range(log2(v[["E"]]),na.rm=T)
hist(v[["E"]])
boxplot(v[["E"]])
log2v=log2(abs(v[["E"]]))
boxplot(log2v)
hist(log2v)
summary(log2v)
colnames(log2v)
write.csv(log2v,file=paste0(inpD,inpF,".log2v.quant.norm.csv"))
hist(v[["weights"]])
write.csv(v[["weights"]],file=paste0(inpD,inpF,".weights.quant.norm.csv"))
fit <- lmFit(v,design=des)
fit <- contrasts.fit(fit, cmat)
fit <- eBayes(fit)
a <- decideTests(fit,adjust.method="fdr", p.value=0.05, lfc=0)
sma = summary(a)
print(sma)
dmm <- dim(maxLFQ)
res <- topTable(fit,n=dmm[1],coef=1)
plot(res$logFC,-log10(res$adj.P.Val))
resMerged<-merge(res,v[["E"]],by="row.names")
resMerged<-resMerged[order(resMerged$P.Value),]
write.csv(resMerged,file=paste0(inpD,inpF,"sum.voom.csv"),row.names = F)
#still variance , need to explore VTS https://bioconductor.org/packages/devel/bioc/vignettes/DESeq2/inst/doc/DESeq2.html#collapsing-technical-replicates , https://rnabio.org/module-03-expression/0003/02/01/Expression/ , http://cole-trapnell-lab.github.io/cufflinks/cuffcompare/index.html#cuffcompare-output-files , https://www.nature.com/articles/s41587-022-01440-w Removing unwanted variation from large-scale RNA sequencing data with PRPS? https://github.com/animesh/TCGA_PanCancer_UnwantedVariation
#ribosom https://string-db.org/cgi/globalenrichment?taskId=b8Wq4Li11Zpx&sessionId=bYMNhNKAgVfp or odorant receptors?
#sampleSmax####
maxLFQ <- data.frame(matrix(ncol=length(names(table(label$Bio))),nrow=nrow(countTableSel)))
colnames(maxLFQ) <- names(table(label$Bio))
rownames(maxLFQ)<-rownames(countTableSel)
for(i in names(table(label$Bio))){
  print(i)
  valsLFQ<-data.frame(countTableSel[,label[label$Bio==i,"Group"]])
  print(summary(valsLFQ))
  maxLFQ[i]<-apply(valsLFQ,1, function(x) max(x,na.rm=T))
  print(summary(maxLFQ[i]))
  hist(as.matrix(maxLFQ[i]))
}
summary(maxLFQ)
write.csv(maxLFQ,paste0(inpD,inpF,".maxLFQ.csv"))
plot(maxLFQ$TK9,repColLFQ$TK9)
plot(log2(maxLFQ$TK9),log2(repColLFQ$TK9))
abline(0,1)
colnames(maxLFQ)
