#"F:\OneDrive - NTNU\R-4.3.2\bin\Rscript.exe" C:\Users\animeshs\OneDrive\Desktop\Scripts\diffExprSeq.r L:\promec\Animesh\TK\SB\subread.1702041591.results\Homo_sapiens.GRCh38.110.30.count.txt
#setup####
#install.packages("BiocManager")
#install.packages("pheatmap")
#BiocManager::install("limma")
#BiocManager::install("edgeR")
library(limma)
library(edgeR)
#data####
inpD<-"L:/promec/Animesh/TK/SB/subread.1702041591.results/"
inpF<-"Homo_sapiens.GRCh38.110.30.count.txt"
countTable = read.table(paste0(inpD,inpF),header=TRUE,row.names=1)
colnames(countTable)
summary(countTable)
pdf(paste(inpD,inpF,"plots","pdf",sep = "."))
#select####
countTableSel=countTable[,grep("TK",colnames(countTable))]
summary(countTableSel)
colnames(countTableSel)
colnames(countTableSel)=gsub("X.cluster.projects.nn9036k.scripts.TK.SB.","",colnames(countTableSel))
colnames(countTableSel)
colnames(countTableSel)=gsub("_22FFLLLT3_AGAGAACCTA.GGTTATGCTA_L00","",colnames(countTableSel))
colnames(countTableSel)
colnames(countTableSel)=gsub("_22GH5GLT3_AGAGAACCTA.GGTTATGCTA_L00","",colnames(countTableSel))
colnames(countTableSel)
colnames(countTableSel)=gsub("_22FFLLLT3_GATATTGTGT.ACCACACGGT_L00","",colnames(countTableSel))
colnames(countTableSel)
colnames(countTableSel)=gsub("_22GH5GLT3_GATATTGTGT.ACCACACGGT_L00","",colnames(countTableSel))
colnames(countTableSel)
colnames(countTableSel)=gsub("_22FFLLLT3_CGTACAGGAA.TAGGTTCTCT_L00","",colnames(countTableSel))
colnames(countTableSel)
colnames(countTableSel)=gsub("_22GH5GLT3_GGCGCCATTG.ACCGCGCAAT_L00","",colnames(countTableSel))
colnames(countTableSel)
colnames(countTableSel)=gsub("_.sort.bam","",colnames(countTableSel))
colnames(countTableSel)
summary(countTableSel)
hist(sapply(countTableSel,as.numeric))
par(mar=c(12,3,1,1))
boxplot(countTableSel,las=2,main="countTableSel")
#sampleSmedian####
label<-data.frame(Bio=sapply(strsplit(colnames(countTableSel),"_",fixed=T),'[[',1))
label$Group<-colnames(countTableSel)
table(label$Bio)
table(label$Group)
medianLFQ <- data.frame(matrix(ncol=length(names(table(label$Bio))),nrow=nrow(countTableSel)))
colnames(medianLFQ) <- names(table(label$Bio))
rownames(medianLFQ)<-rownames(countTableSel)
for(i in names(table(label$Bio))){
  print(i)
  valsLFQ<-data.frame(countTableSel[,label[label$Bio==i,"Group"]])
  print(summary(valsLFQ))
  medianLFQ[i]<-apply(valsLFQ,1, function(x) median(x,na.rm=T))
  print(summary(medianLFQ[i]))
  hist(as.matrix(medianLFQ[i]))
}
summary(medianLFQ)
write.csv(medianLFQ,paste0(inpD,inpF,".medianLFQ.csv"))
#sampleSmax####
maxLFQ <- data.frame(matrix(ncol=length(names(table(label$Bio))),nrow=nrow(countTableSel)))
colnames(maxLFQ) <- names(table(label$Bio))
rownames(maxLFQ)<-rownames(countTableSel)
for(i in names(table(label$Bio))){
  print(i)
  valsLFQ<-data.frame(countTableSel[,label[label$Bio==i,"Group"]])
  print(summary(valsLFQ))
  maxLFQ[i]<-apply(valsLFQ,1, function(x) max(x,na.rm=T))
  print(summary(medianLFQ[i]))
  hist(as.matrix(medianLFQ[i]))
}
summary(maxLFQ)
write.csv(maxLFQ,paste0(inpD,inpF,".maxLFQ.csv"))
plot(maxLFQ$TK9,medianLFQ$TK9)
condition = factor( c("NS","NS","S","S","S","NS","NS"))
des = model.matrix(~-1+condition)
colnames(des) = levels(condition)
cmat <- makeContrasts(S - NS, levels=des)
colnames(maxLFQ)
print(condition)
summary(maxLFQ)
dge <- DGEList(counts=maxLFQ)
dge <- calcNormFactors(dge)
v <- voom(dge,design=des, normalize.method = "quantile",plot=TRUE)
heatmap(cor(v[["E"]]))
pheatmap::pheatmap(cor(v[["E"]]))
range(log2(v[["E"]]),na.rm=T)
hist(v[["E"]])
boxplot(v[["E"]])
log2v=log2(v[["E"]])
boxplot(log2v)
hist(log2v)
write.csv(log2v)
hist(v[["weights"]])
summary(log2v)
colnames(log2v)
fit <- lmFit(v,design=des)
fit <- contrasts.fit(fit, cmat)
fit <- eBayes(fit)
a <- decideTests(fit,adjust.method="fdr", p.value=0.05, lfc=0)
sma = summary(a)
dmm <- dim(maxLFQ)
res <- topTable(fit,n=dmm[1],coef=1)
plot(res$logFC,-log10(res$adj.P.Val))
write.csv(res,file=paste0(inpD,inpF,"max.quantnorm.voom.csv"))
countTable[countTable==0]=NA
countTable$rowLength<-log2(countTable$Length)
hist(countTable$rowLength)
countTable$rowLog2Length<-log2(countTable$Length)
hist(countTable$rowLog2Length)
countTable$rowMinMaxLength<-(countTable$rowLog2Length-min(countTable$rowLog2Length))/(max(countTable$rowLog2Length)-min(countTable$rowLog2Length))
hist(countTable$rowMinMaxLength)
countTable$rowStart<-as.numeric(paste(sapply(strsplit(paste(sapply(strsplit(countTable$Start, ";",fixed=T), "[", 1)), " "), "[", 1)))
hist(countTable$rowStart)
summary(countTable$rowStart)
countTable$rowStrand<-paste(sapply(strsplit(paste(sapply(strsplit(countTable$Strand, ";",fixed=T), "[", 1)), " "), "[", 1))
table(countTable$rowStrand)
countTable$rowChr<-paste(sapply(strsplit(paste(sapply(strsplit(countTable$Chr, ";",fixed=T), "[", 1)), " "), "[", 1))
table(countTable$rowChr)
countTableChr13<-countTable[countTable$rowChr=="13",]
countTableChr13$X.cluster.projects.nn9036k.scripts.TK.SB.TK12_R1_.sort.bam <- with(countTableChr13, ifelse(rowStrand=="-", -X.cluster.projects.nn9036k.scripts.TK.SB.TK12_R1_.sort.bam, X.cluster.projects.nn9036k.scripts.TK.SB.TK12_R1_.sort.bam))
countTableLen<-countTable[,grep("row",colnames(countTable))]
hist(countTable$Length)
#index <- mydata$Var1 <= 1
#countTableChr13[countTableChr13$rowStrand=="-","X.cluster.projects.nn9036k.scripts.TK.mergeHISAT.TK12_R3_.sort.bam"]=countTableChr13[countTableChr13$rowStrand=="-","X.cluster.projects.nn9036k.scripts.TK.mergeHISAT.TK12_R3_.sort.bam"]*(-1)
#plot(countTableChr13$rowStart,log2(countTableChr13$X.cluster.projects.nn9036k.scripts.TK.mergeHISAT.TK12_R3_.sort.bam))
plot(countTableChr13$rowStart,countTableChr13$X.cluster.projects.nn9036k.scripts.TK.SB.TK12_R1_.sort.bam,pch=16,col=gray(countTableChr13$rowMinMaxLength))
countTableChr13<-countTable[countTable$rowChr=="13",]
summary(countTableChr13)
countTableChr13$X.cluster.projects.nn9036k.scripts.TK.SB.TK9_3_22GH5GLT3_GGCGCCATTG.ACCGCGCAAT_L003__.sort.bam <- with(countTableChr13, ifelse(rowStrand=="-", -X.cluster.projects.nn9036k.scripts.TK.SB.TK9_3_22GH5GLT3_GGCGCCATTG.ACCGCGCAAT_L003__.sort.bam,X.cluster.projects.nn9036k.scripts.TK.SB.TK9_3_22GH5GLT3_GGCGCCATTG.ACCGCGCAAT_L003__.sort.bam))
summary(countTableChr13)
#index <- mydata$Var1 <= 1
#countTableChr13[countTableChr13$rowStrand=="-","X.cluster.projects.nn9036k.scripts.TK.mergeHISAT.TK12_R3_.sort.bam"]=countTableChr13[countTableChr13$rowStrand=="-","X.cluster.projects.nn9036k.scripts.TK.mergeHISAT.TK12_R3_.sort.bam"]*(-1)
#plot(countTableChr13$rowStart,log2(countTableChr13$X.cluster.projects.nn9036k.scripts.TK.mergeHISAT.TK12_R3_.sort.bam))
plot(countTableChr13$rowStart,countTableChr13$X.cluster.projects.nn9036k.scripts.TK.SB.TK9_3_22GH5GLT3_GGCGCCATTG.ACCGCGCAAT_L003__.sort.bam,,pch=16,col=gray(countTableChr13$rowMinMaxLength))
summary(countTable)
countTableSelLog2=log2(countTableSel)
countTableSelLog2[countTableSelLog2==-Inf]=NA
summary(countTableSelLog2)
min(countTableSelLog2,na.rm=T)
max(countTableSelLog2,na.rm=T)
hist(sapply(countTableSelLog2,as.numeric),breaks=100)
par(mar=c(12,3,1,1))
boxplot(countTableSelLog2,las=2,main="countTableSelLog2")
#log2sampleS####
medianLog2LFQ <- data.frame(matrix(ncol=length(names(table(label$Bio))),nrow=nrow(countTableSelLog2)))
colnames(medianLog2LFQ) <- names(table(label$Bio))
rownames(medianLog2LFQ)<-rownames(countTableSelLog2)
for(i in names(table(label$Bio))){
  print(i)
  log2LFQvals<-data.frame(countTableSelLog2[,label[label$Bio==i,"Group"]])
  print(summary(log2LFQvals))
  medianLog2LFQ[i]<-apply(log2LFQvals,1, function(x) median(x,na.rm=T))
  print(summary(medianLog2LFQ[i]))
  hist(as.matrix(medianLog2LFQ[i]))
}
summary(medianLog2LFQ)
write.csv(medianLog2LFQ,paste0(inpD,inpF,".medianLog2LFQ.csv"))
