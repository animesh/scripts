##MQ
```{r setup, include=FALSE}
#library/packages
.libPaths( c( .libPaths(), "L:/promec/Animesh/R/win-library/4.0") )
.libPaths()
#plot
#par(mfrow=c(1,2))
#data
inpD <-"L:/promec/TIMSTOF/LARS/2023/230222 Katja/"
thr<-20
selThr=0.1
selThrFC=1
hdr<-gsub("[^[:alnum:] ]", "",inpD)
setwd(inpD)
getwd()
#test
chkrVector<-c(22.39459,20.48316,21.87155,NA,20.34495)
chkrDF<-as.data.frame(chkrVector)
plot(chkrDF)
hist(as.matrix(chkrDF))
chkrDF[,1]
apply(chkrDF, 2, function(x) t.test(as.numeric(x[c(1:3)]),as.numeric(x[4:5]),na.rm=T,var.equal=T)$p.value)
t.test(as.numeric(chkrVector[c(1:3)]),as.numeric(chkrVector[4:5]),na.rm=T,var.equal=T)$p.value
t.test(as.numeric(c(22.39459,20.48316,21.87155)),as.numeric(c(NA,20.34495)),na.rm=T,var.equal=T)$p.value
t.test(c(20.39459,19.48316),c(NA,25.34495),na.rm=T,var.equal=T)$p.value
t.test(c(22.39459,20.48316,21.87155),c(NA,17.97),na.rm=T,var.equal=T)$p.value
t.test(c(21.4316,21.77155),c(NA,17.7),na.rm=T,var.equal=T)$p.value
t.test(c(21.4316,21.77155),c(17.6,17.7),na.rm=T,var.equal=F)$p.value
t.test(c(24.00049729, 23.97020359, 24.91145672), c(24.93876407, 24.84723287, 23.98674622),var.equal = T)$p.value
#[1] 0.5304706
t.test(c(24.00049729, 23.97020359, 24.91145672), c(24.93876407, 24.84723287, 23.98674622),var.equal = F)$p.value
#[1] 0.5304824
```

```{r data}
#| context: setup
#| include: true
inpF<-"F:/OneDrive - NTNU/Desktop/Tobias/Tables Filtered, Uniprot updated for all DEPs at 1.5, 0.05 Geir.xlsx"
data<-readxl::read_xlsx(inpF,sheet=1)
colnames(data)<-data[1,]
data$`Gene names`<-toupper(data$`Gene names`)
genes<-readxl::read_xlsx(inpF,sheet=2)
genesDF<-data.frame(Gene=(unique(genes[,"DNA repair genes...1"])))
colnames(genesDF)<-"Gene names"
genesDF$`Gene names`<-toupper(genesDF$`Gene names`)
genesDF<-merge(genesDF,data,by="Gene names",all.x=T)
genesDF<-genesDF[!duplicated(genesDF$`Gene names`),]
genesDF<-genesDF[!is.na(genesDF$`Gene names`),]
rownames(genesDF)<-genesDF$`Gene names`
genesDF<-genesDF[,c(5:10)]
rN<-rownames(genesDF)
genesDF<-sapply(genesDF,as.numeric)
#genesDF<-genesDF[!is.na(rowSums(genesDF)),]
#rownames(genesDF)<-rN
summary((genesDF))
```

```{r cluster}
bk1 <- c(seq(range(genesDF,na.rm=T)[1],range(genesDF,na.rm=T)[1]+(range(genesDF,na.rm=T)[2]-range(genesDF,na.rm=T)[1])/2,by=0.01))
bk2 <- c(seq(range(genesDF,na.rm=T)[1]+(range(genesDF,na.rm=T)[2]-range(genesDF,na.rm=T)[1])/2,range(genesDF,na.rm=T)[2],by=0.01))
bk <- c(bk1,bk2)  #combine the break limits for purpose of graphing
palette <- c(colorRampPalette(colors = c("green", "black"))(n = length(bk1)-1),"black", "black",c(colorRampPalette(colors = c("black","red"))(n = length(bk2)-1)))
svgPHC<-pheatmap::pheatmap(genesDF,color = palette,clustering_distance_rows = "euclidean",clustering_distance_cols = "euclidean",fontsize_row=4,cluster_cols=T,cluster_rows=F,fontsize_col  = 8,na_col = "grey")
ggplot2::ggsave(file=paste0(inpF,"log2selectClust.svg"),plot=svgPHC,width=6, height=10,dpi = 320)#,  
```

```{r proteinGroups, echo=FALSE}
inpF<-paste0(inpD,"proteinGroups.txt")
data <- read.table(inpF,stringsAsFactors = FALSE, header = TRUE, quote = "", comment.char = "", sep = "\t")
#clean
#data = data[!data$Reverse=="+",]
#data = data[!data$Potential.contaminant=="+",]
#data = data[!data$Only.identified.by.site=="+",]
row.names(data)<-paste(row.names(data),data$Fasta.headers,data$Protein.IDs,data$Protein.names,data$Gene.names,data$Score,data$Peptide.counts..unique.,sep=";;")
summary(data)
dim(data)
hist(as.matrix(log2(data[,grep("Intensity",colnames(data))])))
summary(log2(data[,grep("Intensity",colnames(data))]))
selection<-"LFQ.intensity."
LFQ<-as.matrix(data[,grep(selection,colnames(data))])
#protNum<-1:ncol(LFQ)
#protNum<-"LFQ intensity"#1:ncol(LFQ)
#colnames(LFQ)=paste(protNum,sub(selection,"",colnames(LFQ)),sep=";")
colnames(LFQ)=sub(selection,"",colnames(LFQ))
dim(LFQ)
log2LFQ<-log2(LFQ)
log2LFQ[log2LFQ==-Inf]=NA
log2LFQ[log2LFQ==0]=NA
summary(log2LFQ)
hist(log2LFQ)
inpW<-paste0(inpD,hdr,"log2LFQ.xlsx")
rowName<-paste(sapply(strsplit(paste(sapply(strsplit(data$Fasta.headers, "|",fixed=T), "[", 2)), "-"), "[", 1))
writexl::write_xlsx(as.data.frame(cbind(rowName,log2LFQ,rownames(data))),inpW)
```

```{r label}
inpL<-paste0(inpD,"Groups.txt")
#lGroup<-"Grpup"
lGroup<-"Gender"
#lGroup<-"Bio"
rGroup<-"Rem"
label<-read.table(inpL,header=T,row.names=1,sep="\t")#, colClasses=c(rep("factor",3)))
rownames(label)<-gsub("LFQ intensity ","",rownames(label))
rownames(label)<-gsub("\\-","\\.",rownames(label))
label
annoFactor<-label[lGroup]
names(annoFactor)<-lGroup
anno<-data.frame(factor(label[,lGroup]))
row.names(anno)<-rownames(label)
names(anno)<-lGroup
table(anno)
annoR<-data.frame(factor(annoFactor[rownames(label[is.na(label[rGroup])|label[rGroup]==" "|label[rGroup]=='',]),]))
row.names(annoR)<-rownames(label[is.na(label[rGroup])|label[rGroup]==" "|label[rGroup]=='',])
names(annoR)<-lGroup
summary(annoR)
```


```{r PCA, echo = FALSE}
options(nwarnings = 1000000)
scale=2
set.seed(scale)
boxplot(log2LFQ)
hist(log2LFQ)
colnames(log2LFQ)
log2LFQrem<-log2LFQ[,gsub("-",".",rownames(label[is.na(label[rGroup])|label[rGroup]==" "|label[rGroup]=='',]))]
boxplot(log2LFQrem)
hist(log2LFQrem)
colnames(log2LFQrem)
summary(log2LFQrem)
log2LFQrem<-scale(log2LFQrem)
boxplot(log2LFQrem)
hist(log2LFQrem)
colnames(log2LFQrem)
summary(log2LFQrem)
log2LFQimp<-matrix(rnorm(dim(log2LFQrem)[1]*dim(log2LFQrem)[2],mean=mean(log2LFQrem,na.rm = T)-scale,sd=sd(log2LFQrem,na.rm = T)/(scale)), dim(log2LFQrem)[1],dim(log2LFQrem)[2])
hist(log2LFQimp)
boxplot(log2LFQimp)
log2LFQimp[log2LFQimp<0]<-0
summary(log2LFQimp)
dataHighNormLog2<-log2LFQimp
dataHighNormLog2[!is.na(log2LFQrem)]<-log2LFQrem[!is.na(log2LFQrem)]
summary(dataHighNormLog2)
hist(dataHighNormLog2)
boxplot(dataHighNormLog2)
log2LFQt<-t(dataHighNormLog2)
row.names(log2LFQt)<-colnames(log2LFQrem)
plot(prcomp(log2LFQt))
log2LFQtPCA<-prcomp(log2LFQt)
write.csv(x = data.frame(log2LFQtPCA$x),file = paste0(inpF,"log2LFQtPCA.csv"))
dflog2LFQtPCA<-data.frame(log2LFQtPCA$x)
rownames(dflog2LFQtPCA)<-gsub("\\.","-",rownames(dflog2LFQtPCA))
rownames(dflog2LFQtPCA)
rownames(label)
dflog2LFQtPCAlab<-merge(x = dflog2LFQtPCA,y = label,by = 'row.names', all = F)
write.csv(x = dflog2LFQtPCAlab,file = paste0(inpF,"dflog2LFQtPCAlab.csv"))
log2LFQtPCAsumm<-summary(log2LFQtPCA)
write.csv(x = (log2LFQtPCAsumm$importance),file = paste0(inpF,"log2LFQtPCAsummimportance.csv"))
svglite::svglite(paste0(inpF,"log2LFQtPCA12name.svg"),width = 8, height = 8)
op <- par(cex = 0.5)
plot(log2LFQtPCA$x[,1], log2LFQtPCA$x[,2], pch = 16, col = factor(rownames(log2LFQt)),xlab = paste0("PC1 (", round(100*log2LFQtPCAsumm$importance[2,1],1), "%)"), ylab = paste0("PC2 (", round(100*log2LFQtPCAsumm$importance[2,2],1), "%)"),main=paste("PCA 1/2 with 0 containing proteinGroups imputed scale",scale,"\nProtein groups", dim(log2LFQt)[2],"across samples",dim(log2LFQt)[1]))
legend("topleft", col = factor(rownames(log2LFQt)), legend = factor(rownames(log2LFQt)), pch = 16)
dev.off()
svglite::svglite(paste0(inpF,"log2LFQtPCA12group.svg"),width = 8, height = 8)
op <- par(cex = 0.5)
label[rownames(label[is.na(label[rGroup])|label[rGroup]==" "|label[rGroup]=='',]),"Grpup"]
plot(log2LFQtPCA$x[,1], log2LFQtPCA$x[,2], pch = 16, col = factor(label[rownames(label[is.na(label[rGroup])|label[rGroup]==" "|label[rGroup]=='',]),"Grpup"]),xlab = paste0("PC1 (", round(100*log2LFQtPCAsumm$importance[2,1],1), "%)"), ylab = paste0("PC2 (", round(100*log2LFQtPCAsumm$importance[2,2],1), "%)"),main=paste("PCA 1/2 with 0 containing proteinGroups imputed scale",scale,"\nProtein groups", dim(log2LFQt)[2],"across samples",dim(log2LFQt)[1]))
legend("topleft", col = factor(label[rownames(label[is.na(label[rGroup])|label[rGroup]==" "|label[rGroup]=='',]),"Grpup"]), legend = factor(label[rownames(label[is.na(label[rGroup])|label[rGroup]==" "|label[rGroup]=='',]),"Grpup"]), pch = 16)
dev.off()
svglite::svglite(paste0(inpF,"log2LFQtPCA12gender.svg"),width = 8, height = 8)
op <- par(cex = 0.5)
label[rownames(label[is.na(label[rGroup])|label[rGroup]==" "|label[rGroup]=='',]),"Gender"]
plot(log2LFQtPCA$x[,1], log2LFQtPCA$x[,2], pch = 16, col = factor(label[rownames(label[is.na(label[rGroup])|label[rGroup]==" "|label[rGroup]=='',]),"Gender"]),xlab = paste0("PC1 (", round(100*log2LFQtPCAsumm$importance[2,1],1), "%)"), ylab = paste0("PC2 (", round(100*log2LFQtPCAsumm$importance[2,2],1), "%)"),main=paste("PCA 1/2 with 0 containing proteinGroups imputed scale",scale,"\nProtein groups", dim(log2LFQt)[2],"across samples",dim(log2LFQt)[1]))
legend("topleft", col = factor(label[rownames(label[is.na(label[rGroup])|label[rGroup]==" "|label[rGroup]=='',]),"Gender"]), legend = factor(label[rownames(label[is.na(label[rGroup])|label[rGroup]==" "|label[rGroup]=='',]),"Gender"]), pch = 16)
dev.off()
```

```{r corHC}
#corrplot::corrplot(cor(log2LFQ))
#log2LFQ0=log2LFQ
#log2LFQ0[log2LFQ0==NA]=0
#pheatmap::pheatmap(log2LFQ0,clustering_distance_rows = "binary",clustering_distance_cols = "correlation",fontsize_row=4,cluster_cols=FALSE,cluster_rows=T,color = my_palette,fontsize_col  = 4)
scale=3
log2LFQimp<-matrix(rnorm(dim(log2LFQ)[1]*dim(log2LFQ)[2],mean=mean(log2LFQ,na.rm = T)-scale,sd=sd(log2LFQ,na.rm = T)/(scale)), dim(log2LFQ)[1],dim(log2LFQ)[2])
log2LFQimp[log2LFQimp<0]<-0
bk1 <- c(seq(-3,-0.01,by=0.01))
bk2 <- c(seq(0.01,3,by=0.01))
bk <- c(bk1,bk2)  #combine the break limits for purpose of graphing
my_palette <- c(colorRampPalette(colors = c("darkblue", "white"))(n = length(bk1)-1),
              "gray", "gray",
              c(colorRampPalette(colors = c("white","darkred"))(n = length(bk2)-1)))
colnames(log2LFQimp)<-colnames(log2LFQ)
#pheatmap::pheatmap(log2LFQimp,clustering_distance_rows = "binary",clustering_distance_cols = "correlation",fontsize_row=8,cluster_cols=T,cluster_rows=T,color = my_palette,fontsize_col  = 8)
#pheatmap::pheatmap(log2LFQimp,clustering_distance_rows = "correlation",clustering_distance_cols = "correlation",fontsize_row=1,cluster_cols=T,cluster_rows=T,fontsize_col  = 8)
log2LFQimp<-log2LFQ
dim(log2LFQimp)
log2LFQimpCorr<-cor(log2LFQimp,use="pairwise.complete.obs",method="pearson")
dim(log2LFQimpCorr)
colnames(log2LFQimpCorr)<-colnames(log2LFQimp)
rownames(log2LFQimpCorr)<-colnames(log2LFQimp)
svgPHC<-pheatmap::pheatmap(log2LFQimpCorr,clustering_distance_rows = "euclidean",clustering_distance_cols = "euclidean",fontsize_row=8,cluster_cols=T,cluster_rows=T,fontsize_col  = 8)
log2LFQrem<-log2LFQ[,gsub("-",".",rownames(label[is.na(label[rGroup])|label[rGroup]==" "|label[rGroup]=='',]))]
log2LFQimp<-log2LFQrem
dim(log2LFQimp)
log2LFQimpCorr<-cor(log2LFQimp,use="pairwise.complete.obs",method="pearson")
dim(log2LFQimpCorr)
colnames(log2LFQimpCorr)<-colnames(log2LFQimp)
rownames(log2LFQimpCorr)<-colnames(log2LFQimp)
svgPHC<-pheatmap::pheatmap(log2LFQimpCorr,clustering_distance_rows = "euclidean",clustering_distance_cols = "euclidean",fontsize_row=8,cluster_cols=T,cluster_rows=T,fontsize_col  = 8)
#svgPHC<-pheatmap::pheatmap(log2LFQimpCorr,clustering_distance_rows = "euclidean",clustering_distance_cols = "euclidean",annotation_row = anno, annotation_col = anno,fontsize_row=8,cluster_cols=T,cluster_rows=T,fontsize_col  = 8)
#pheatmap::pheatmap(log2LFQimpCorr,clustering_distance_rows = "euclidean",clustering_distance_cols = "euclidean",fontsize_row=4,cluster_cols=T,cluster_rows=T,fontsize_col  = 4,labels_col = label$Sample.Number,labels_row = label$Cell.Type_Sample.Group)
#svgPHC<-pheatmap::pheatmap(log2LFQimpCorr,clustering_distance_rows = "euclidean",clustering_distance_cols = "euclidean",fontsize_row=6,cluster_cols=T,cluster_rows=T,fontsize_col  = 6,labels_row = paste(label$RawFnum,label$ID_ROLF,label$Tank,label$Diet,label$Fish))
ggplot2::ggsave(file=paste0(inpF,hdr,selection,"log2pearClust.svg"),plot=svgPHC)#,  
assign(paste0(selection,"clusterData"),log2LFQimpCorr)
write.csv(cbind(rownames(log2LFQimpCorr),log2LFQimpCorr),paste0(inpF,hdr,selection,"log2spearClust.csv"),row.names=F)
```

```{r fmPCA}
plot(log2LFQtPCA$x[,16], log2LFQtPCA$x[,5], pch = 16, col = factor(label[rownames(label[is.na(label[rGroup])|label[rGroup]==" "|label[rGroup]=='',]),"Gender"]),xlab = paste0("PC3 (", round(100*log2LFQtPCAsumm$importance[2,3],1), "%)"), ylab = paste0("PC16 (", round(100*log2LFQtPCAsumm$importance[2,16],1), "%)"),main=paste("PCA 3/16 with 0 containing proteinGroups imputed scale",scale,"\nProtein groups", dim(log2LFQt)[2],"across samples",dim(log2LFQt)[1]))
legend("topleft", col = factor(label[rownames(label[is.na(label[rGroup])|label[rGroup]==" "|label[rGroup]=='',]),"Gender"]), legend = factor(label[rownames(label[is.na(label[rGroup])|label[rGroup]==" "|label[rGroup]=='',]),"Gender"]), pch = 16)
plot(log2LFQtPCA$x[,1], log2LFQtPCA$x[,3], pch = 16, col = factor(label[rownames(label[is.na(label[rGroup])|label[rGroup]==" "|label[rGroup]=='',]),"Gender"]),xlab = paste0("PC1 (", round(100*log2LFQtPCAsumm$importance[2,1],1), "%)"), ylab = paste0("PC2 (", round(100*log2LFQtPCAsumm$importance[2,3],1), "%)"),main=paste("PCA 1/2 with 0 containing proteinGroups imputed","\nProtein groups", dim(log2LFQt)[2],"across samples",dim(log2LFQt)[1]))
legend("topleft", col = factor(rownames(log2LFQt)), legend = factor(rownames(log2LFQt)), pch = 16)
plot(log2LFQtPCA$x[,3], log2LFQtPCA$x[,2], pch = 16, col = factor(label[rownames(label[is.na(label[rGroup])|label[rGroup]==" "|label[rGroup]=='',]),"Gender"]),xlab = paste0("PC1 (", round(100*log2LFQtPCAsumm$importance[2,3],1), "%)"), ylab = paste0("PC2 (", round(100*log2LFQtPCAsumm$importance[2,2],1), "%)"),main=paste("PCA 1/2 with 0 containing proteinGroups imputed","\nProtein groups", dim(log2LFQt)[2],"across samples",dim(log2LFQt)[1]))
plot(log2LFQtPCA$x[,19], log2LFQtPCA$x[,18], pch = 16, col = factor(label[rownames(label[is.na(label[rGroup])|label[rGroup]==" "|label[rGroup]=='',]),"Gender"]),xlab = paste0("PC1 (", round(100*log2LFQtPCAsumm$importance[2,3],1), "%)"), ylab = paste0("PC2 (", round(100*log2LFQtPCAsumm$importance[2,4],1), "%)"),main=paste("PCA 1/2 with 0 containing proteinGroups imputed","\nProtein groups", dim(log2LFQt)[2],"across samples",dim(log2LFQt)[1]))
pca_results <- FactoMineR::PCA(log2LFQrem, scale.unit=TRUE, ncp=25, graph=T) 
FactoMineR::fviz_pca_ind(pca_results, axes = c(1,2))+ 
  FactoMineR::geom_point(FactoMineR::aes(colour = rownames())) +
  FactoMineR::guides(colour = FactoMineR::guide_legend(title = "color"))

```


```{r Ctr}
sel<-"Ctr"
#colSel<-paste(rownames(label[grep(sel,label$Diet),]),collapse=",")
hda<-as.matrix(log2LFQ[,grep(sel,label$Group)])
summary(hda)
sum(hda>thr,na.rm=T)
hist(as.matrix(hda))
limma::vennDiagram(hda[,1:5]>thr)
hdaM<-apply(hda,1,function(x) if(sum(is.na(x))<ncol(hda)){median(x,na.rm=T)} else{0})
sum(hdaM>thr,na.rm=T)
inpW<-paste0(inpF,hdr,sel,"LFQ.xlsx")
writexl::write_xlsx(as.data.frame(cbind(hdaM,hda,data$Fasta.headers)),inpW)
assign(paste0(sel,"median"),hdaM)
assign(paste0(sel,"all"),hda)
```

```{r KO}
sel<-"KO"
hda<-as.matrix(log2LFQ[,grep(sel,label$Group)])
summary(hda)
sum(hda>thr,na.rm=T)
hist(as.matrix(hda))
limma::vennDiagram(hda[,1:5]>thr)
hdaM<-apply(hda,1,function(x) if(sum(is.na(x))<ncol(hda)){median(x,na.rm=T)} else{0})
sum(hdaM[,1:5>thr,na.rm=T)
inpW<-paste0(inpF,hdr,sel,"LFQ.xlsx")
writexl::write_xlsx(as.data.frame(cbind(hdaM,hda,data$Fasta.headers)),inpW)
assign(paste0(sel,"median"),hdaM)
assign(paste0(sel,"all"),hda)
```

```{r vennMedians}
hda<-cbind(Ctrmedian,KOmedian)
hist(hda)
limma::vennDiagram(hda>thr)
writexl::write_xlsx(as.data.frame(cbind(Fasta=rownames(data),hda,Ctrall,KOall)),paste0(inpF,hdr,selection,"median.xlsx"))
write.csv(cbind(Fasta=rownames(data),hda,Ctrall,KOall),paste0(inpF,hdr,selection,"median.csv"),row.names = F)
```

```{r tKO, echo = FALSE}
dataSellog2grpTtest<-cbind(KOall[,c(1,2,3,5)],Ctrall[,c(2,3,5,6)])
comp<-"Ctr_KO"
dataSellog2grpTtest[dataSellog2grpTtest==0]=NA
summary(dataSellog2grpTtest)
row.names(dataSellog2grpTtest)<-row.names(data)
sCol<-1
eCol<-8
mCol<-4
cvThr<-0.05
t.test(as.numeric(dataSellog2grpTtest[1,c(sCol:mCol)]),as.numeric(dataSellog2grpTtest[1,c((mCol+1):eCol)]),na.rm=T)$p.value
chkr<-1
sum(!is.na(dataSellog2grpTtest[chkr,c(1:eCol)]))
t.test(as.numeric(dataSellog2grpTtest[chkr,c(sCol:mCol)]),as.numeric(dataSellog2grpTtest[chkr,c((mCol+1):eCol)]),na.rm=T)$p.value
dim(dataSellog2grpTtest)
options(nwarnings = 1000000)

pValNA = apply(
  dataSellog2grpTtest, 1, function(x)
    if(sum(!is.na(x[c(sCol:mCol)]))<2&sum(!is.na(x[c((mCol+1):eCol)]))<2){NA}
    else if(sum(is.na(x[c(sCol:mCol)]))==0&sum(is.na(x[c((mCol+1):eCol)]))==0){
      t.test(as.numeric(x[c(sCol:mCol)]),as.numeric(x[c((mCol+1):eCol)]),var.equal=T)$p.value}
    else if(sum(!is.na(x[c(sCol:mCol)]))>1&(min(x[c(sCol:mCol)],na.rm=T)==max(x[c(sCol:mCol)],na.rm=T))){0}
    else if(sum(!is.na(x[c((mCol+1):eCol)]))>1&(min(x[c((mCol+1):eCol)],na.rm=T)==max(x[c((mCol+1):eCol)],na.rm=T))){0}
    else if(sum(!is.na(x[c(sCol:mCol)]))>1&sum(!is.na(x[c((mCol+1):eCol)]))<1&(sd(x[c(sCol:mCol)],na.rm=T)/mean(x[c(sCol:mCol)],na.rm=T))<cvThr){0}
    else if(sum(!is.na(x[c(sCol:mCol)]))<1&sum(!is.na(x[c((mCol+1):eCol)]))>1&(sd(x[c((mCol+1):eCol)],na.rm=T)/mean(x[c((mCol+1):eCol)],na.rm=T))<cvThr){0}
    else if(sum(!is.na(x[c(sCol:mCol)]))>=2&sum(!is.na(x[c((mCol+1):eCol)]))>=1){
      t.test(as.numeric(x[c(sCol:mCol)]),as.numeric(x[c((mCol+1):eCol)]),na.rm=T,var.equal=T)$p.value}
    else if(sum(!is.na(x[c(sCol:mCol)]))>=1&sum(!is.na(x[c((mCol+1):eCol)]))>=2){
      t.test(as.numeric(x[c(sCol:mCol)]),as.numeric(x[c((mCol+1):eCol)]),na.rm=T,var.equal=T)$p.value}
  else{NA}
  )
summary(warnings())
hist(pValNA)
summary(pValNA)
dfpValNA<-as.data.frame(ceiling(pValNA))
pValNAdm<-cbind(pValNA,dataSellog2grpTtest,row.names(data))
pValNAminusLog10 = -log10(pValNA+.Machine$double.xmin)
hist(pValNAminusLog10)
library(scales)
pValNAminusLog10=squish(pValNAminusLog10,c(0,5))
hist(pValNAminusLog10)
length(pValNA)-(sum(is.na(pValNA))+sum(ceiling(pValNA)==0,na.rm = T))
pValBHna = p.adjust(pValNA,method = "BH")
hist(pValBHna)
pValBHnaMinusLog10 = -log10(pValBHna+.Machine$double.xmin)
hist(pValBHnaMinusLog10)
dataSellog2grpTtestNum<-apply(dataSellog2grpTtest, 2,as.numeric)
logFCmedianGrp1 = matrixStats::rowMedians(dataSellog2grpTtestNum[,c(sCol:mCol)],na.rm=T)
logFCmedianGrp2 = matrixStats::rowMedians(dataSellog2grpTtestNum[,c((mCol+1):eCol)],na.rm=T)
logFCmedianGrp1[is.nan(logFCmedianGrp1)]=0
logFCmedianGrp2[is.nan(logFCmedianGrp2)]=0
logFCmedian = logFCmedianGrp1-logFCmedianGrp2
logFCmedianFC = 2^(logFCmedian+.Machine$double.xmin)
logFCmedianFC=squish(logFCmedianFC,c(0.01,100))
hist(logFCmedianFC)
log2FCmedianFC=log2(logFCmedianFC)
hist(log2FCmedianFC)
ttest.results = data.frame(Uniprot=rowName,PValueMinusLog10=pValNAminusLog10,FoldChanglog2median=logFCmedianFC,CorrectedPValueBH=pValBHna,TtestPval=pValNA,dataSellog2grpTtest,Log2MedianChange=logFCmedian,RowGeneUniProtScorePeps=rownames(dataSellog2grpTtest))
writexl::write_xlsx(ttest.results,paste0(inpF,hdr,selection,sCol,eCol,comp,selThr,selThrFC,cvThr,"tTestBH.xlsx"))
write.csv(ttest.results,paste0(inpF,hdr,selection,sCol,eCol,comp,selThr,selThrFC,cvThr,"tTestBH.csv"),row.names = F)
#limma::vennDiagram(cbind(as.matrix(dataSellog2grpTtest[,c(sCol:mCol)]),as.matrix(dataSellog2grpTtest[,c((mCol+1):eCol)])))
limma::vennDiagram(cbind(logFCmedianGrp1,logFCmedianGrp2))
limma::vennDiagram(cbind(logFCmedianGrp1,logFCmedianGrp2))
data$RowGeneUniProtScorePeps<-data$Gene.names
ttest.results[is.na(ttest.results)]=selThr
Significance=ttest.results$CorrectedPValueBH<selThr&ttest.results$CorrectedPValueBH>0&abs(ttest.results$Log2MedianChange)>selThrFC
sum(Significance)
dsub <- subset(ttest.results,Significance)
p <- ggplot2::ggplot(ttest.results,ggplot2::aes(Log2MedianChange,PValueMinusLog10))+ ggplot2::geom_point(ggplot2::aes(color=Significance)) 
p<-p + ggplot2::theme_bw(base_size=8) + ggplot2::geom_text(data=dsub,ggplot2::aes(label=RowGeneUniProtScorePeps),hjust=0, vjust=0,size=1) + ggplot2::scale_fill_gradient(low="white", high="darkblue") + ggplot2::xlab("Log2 Median Change") + ggplot2::ylab("-Log10 P-value")
#f=paste(file,proc.time()[3],".jpg")
ggplot2::ggsave(paste0(inpF,hdr,selection,sCol,eCol,comp,selThr,selThrFC,cvThr,"VolcanoTest.svg"), p)
print(p)
```

```{r wKO, echo = FALSE}
dataSellog2grpTtest<-cbind(KOall,Ctrall)
comp<-"Ctr_KO"
dataSellog2grpTtest[dataSellog2grpTtest==0]=NA
summary(dataSellog2grpTtest)
row.names(dataSellog2grpTtest)<-row.names(data)
sCol<-1
eCol<-12
mCol<-6
qThr<-1.5
t.test(as.numeric(dataSellog2grpTtest[1,c(sCol:mCol)]),as.numeric(dataSellog2grpTtest[1,c((mCol+1):eCol)]),na.rm=T)$p.value
chkr<-1
sum(!is.na(dataSellog2grpTtest[chkr,c(1:eCol)]))
t.test(as.numeric(dataSellog2grpTtest[chkr,c(sCol:mCol)]),as.numeric(dataSellog2grpTtest[chkr,c((mCol+1):eCol)]),na.rm=T)$p.value
dim(dataSellog2grpTtest)
options(nwarnings = 1000000)
pValNA = apply(
  dataSellog2grpTtest, 1, function(x)
    if(sum(!is.na(x[c(sCol:mCol)]))<2&sum(!is.na(x[c((mCol+1):eCol)]))<2){NA}
    else if(sum(is.na(x[c(sCol:mCol)]))==0&sum(is.na(x[c((mCol+1):eCol)]))==0){
      t.test(as.numeric(x[c(sCol:mCol)]),as.numeric(x[c((mCol+1):eCol)]),var.equal=F)$p.value}
    else if(sum(!is.na(x[c(sCol:mCol)]))>1&(min(x[c(sCol:mCol)],na.rm=T)==max(x[c(sCol:mCol)],na.rm=T))){0}
    else if(sum(!is.na(x[c((mCol+1):eCol)]))>1&(min(x[c((mCol+1):eCol)],na.rm=T)==max(x[c((mCol+1):eCol)],na.rm=T))){0}
    else if(sum(!is.na(x[c(sCol:mCol)]))>=2&sum(!is.na(x[c((mCol+1):eCol)]))==1&(as.numeric(quantile(as.numeric(x[c(sCol:mCol)]),na.rm=T)[1])-(qThr*IQR(as.numeric(x[c(sCol:mCol)]),na.rm=T)))>max(as.numeric(x[c((mCol+1):eCol)]),na.rm=T)){0}
    else if(sum(!is.na(x[c(sCol:mCol)]))>=2&sum(!is.na(x[c((mCol+1):eCol)]))==1&(as.numeric(quantile(as.numeric(x[c(sCol:mCol)]),na.rm=T)[5])+(qThr*IQR(as.numeric(x[c(sCol:mCol)]),na.rm=T)))<min(as.numeric(x[c((mCol+1):eCol)]),na.rm=T)){0}
    else if(sum(!is.na(x[c(sCol:mCol)]))==1&sum(!is.na(x[c((mCol+1):eCol)]))>=2&(as.numeric(quantile(as.numeric(x[c((mCol+1):eCol)]),na.rm=T)[1])-(qThr*IQR(as.numeric(x[c((mCol+1):eCol)]),na.rm=T))>max(as.numeric(x[c(sCol:mCol)]),na.rm=T))){0}
    else if(sum(!is.na(x[c(sCol:mCol)]))==1&sum(!is.na(x[c((mCol+1):eCol)]))>=2&(as.numeric(quantile(as.numeric(x[c((mCol+1):eCol)]),na.rm=T)[5])+(qThr*IQR(as.numeric(x[c((mCol+1):eCol)]),na.rm=T))<min(as.numeric(x[c(sCol:mCol)]),na.rm=T))){0}
    else if(sum(!is.na(x[c(sCol:mCol)]))>1&sum(!is.na(x[c((mCol+1):eCol)]))<1){0}
    else if(sum(!is.na(x[c(sCol:mCol)]))<1&sum(!is.na(x[c((mCol+1):eCol)]))>1){0}
    else if(sum(!is.na(x[c(sCol:mCol)]))>=2&sum(!is.na(x[c((mCol+1):eCol)]))==1&(as.numeric(quantile(as.numeric(x[c(sCol:mCol)]),na.rm=T)[1])-(qThr*IQR(as.numeric(x[c(sCol:mCol)]),na.rm=T)))<=max(as.numeric(x[c((mCol+1):eCol)]),na.rm=T)){1}
    else if(sum(!is.na(x[c(sCol:mCol)]))>=2&sum(!is.na(x[c((mCol+1):eCol)]))==1&(as.numeric(quantile(as.numeric(x[c(sCol:mCol)]),na.rm=T)[5])+(qThr*IQR(as.numeric(x[c(sCol:mCol)]),na.rm=T)))>=min(as.numeric(x[c((mCol+1):eCol)]),na.rm=T)){1}
    else if(sum(!is.na(x[c(sCol:mCol)]))==1&sum(!is.na(x[c((mCol+1):eCol)]))>=2&(as.numeric(quantile(as.numeric(x[c((mCol+1):eCol)]),na.rm=T)[1])-(qThr*IQR(as.numeric(x[c((mCol+1):eCol)]),na.rm=T))<=max(as.numeric(x[c(sCol:mCol)]),na.rm=T))){1}
    else if(sum(!is.na(x[c(sCol:mCol)]))==1&sum(!is.na(x[c((mCol+1):eCol)]))>=2&(as.numeric(quantile(as.numeric(x[c((mCol+1):eCol)]),na.rm=T)[5])+(qThr*IQR(as.numeric(x[c((mCol+1):eCol)]),na.rm=T))>=min(as.numeric(x[c(sCol:mCol)]),na.rm=T))){1}
    else if(sum(!is.na(x[c(sCol:mCol)]))>=2&sum(!is.na(x[c((mCol+1):eCol)]))>=2){
      t.test(as.numeric(x[c(sCol:mCol)]),as.numeric(x[c((mCol+1):eCol)]),na.rm=T,var.equal=F)$p.value}
  else{NA}
  )
summary(warnings())
hist(pValNA)
pValNAdm<-cbind(pValNA,dataSellog2grpTtest,row.names(data))
pValNAminusLog10 = -log10(pValNA+.Machine$double.xmin)
hist(pValNAminusLog10)
library(scales)
pValNAminusLog10=squish(pValNAminusLog10,c(0,5))
hist(pValNAminusLog10)
pValBHna = p.adjust(pValNA,method = "BH")
hist(pValBHna)
pValBHnaMinusLog10 = -log10(pValBHna+.Machine$double.xmin)
hist(pValBHnaMinusLog10)
dataSellog2grpTtestNum<-apply(dataSellog2grpTtest, 2,as.numeric)
logFCmedianGrp1 = matrixStats::rowMedians(dataSellog2grpTtestNum[,c(sCol:mCol)],na.rm=T)
logFCmedianGrp2 = matrixStats::rowMedians(dataSellog2grpTtestNum[,c((mCol+1):eCol)],na.rm=T)
logFCmedianGrp1[is.nan(logFCmedianGrp1)]=0
logFCmedianGrp2[is.nan(logFCmedianGrp2)]=0
logFCmedian = logFCmedianGrp1-logFCmedianGrp2
logFCmedianFC = 2^(logFCmedian+.Machine$double.xmin)
logFCmedianFC=squish(logFCmedianFC,c(0.01,100))
hist(logFCmedianFC)
log2FCmedianFC=log2(logFCmedianFC)
hist(log2FCmedianFC)
ttest.results = data.frame(Uniprot=rowName,PValueMinusLog10=pValNAminusLog10,FoldChanglog2median=logFCmedianFC,CorrectedPValueBH=pValBHna,TtestPval=pValNA,dataSellog2grpTtest,Log2MedianChange=logFCmedian,RowGeneUniProtScorePeps=rownames(dataSellog2grpTtest))
writexl::write_xlsx(ttest.results,paste0(inpF,hdr,selection,sCol,eCol,qThr,comp,selThr,selThrFC,"wTestBH.xlsx"))
write.csv(ttest.results,paste0(inpF,hdr,selection,sCol,eCol,qThr,comp,selThr,selThrFC,"wTestBH.csv"),row.names = F)
#limma::vennDiagram(cbind(as.matrix(dataSellog2grpTtest[,c(sCol:mCol)]),as.matrix(dataSellog2grpTtest[,c((mCol+1):eCol)])))
limma::vennDiagram(cbind(logFCmedianGrp1,logFCmedianGrp2))
limma::vennDiagram(cbind(logFCmedianGrp1,logFCmedianGrp2))
data$RowGeneUniProtScorePeps<-data$Gene.names
ttest.results[is.na(ttest.results)]=selThr
Significance=ttest.results$CorrectedPValueBH<selThr&ttest.results$CorrectedPValueBH>0&abs(ttest.results$Log2MedianChange)>selThrFC
sum(Significance)
dsub <- subset(ttest.results,Significance)
p <- ggplot2::ggplot(ttest.results,ggplot2::aes(Log2MedianChange,PValueMinusLog10))+ ggplot2::geom_point(ggplot2::aes(color=Significance)) 
p<-p + ggplot2::theme_bw(base_size=8) + ggplot2::geom_text(data=dsub,ggplot2::aes(label=RowGeneUniProtScorePeps),hjust=0, vjust=0,size=1) + ggplot2::scale_fill_gradient(low="white", high="darkblue") + ggplot2::xlab("Log2 Median Change") + ggplot2::ylab("-Log10 P-value")
#f=paste(file,proc.time()[3],".jpg")
ggplot2::ggsave(paste0(inpF,hdr,selection,sCol,eCol,qThr,comp,selThr,selThrFC,"WolcanoTest.svg"), p)
print(p)
```


##PD
```{r setup, include=FALSE}
#library/packages
.libPaths( c( "L:/promec/Animesh/R/win-library/4.0", .libPaths()) )
.libPaths()
#plot
par(mfrow=c(1,2))
#library/packages
inpD <-"L:/promec/HF/Lars/2021/march/Ingrid/KO/"
fName<-"210317_Ingrid1.xlsx"
inpF<-paste0(inpD,fName)
thr<-2
selThr=0.1
selThrFC=1
options(nwarnings = 1000000)
hdr<-gsub("[^[:alnum:] ]", "",inpD)
.libPaths( c( .libPaths(), inpD) )
.libPaths()
#install.packages("lattice", repos="http://cran.r-project.org", lib=inpD)
#install.packages("rlang")
#install.packages("writexl")
#install.packages("readxl")
#install.packages("devtools")
#install.packages("BiocManager")
#BiocManager::install("limma")
#install.packages("matrixStats")
#directory/home
setwd(inpD)
getwd()
chkrVector<-c(22.39459,20.48316,21.87155,NA,20.34495)
chkrDF<-as.data.frame(chkrVector)
plot(chkrDF)
hist(as.matrix(chkrDF))
chkrDF[,1]
apply(chkrDF, 2, function(x) t.test(as.numeric(x[c(1:3)]),as.numeric(x[4:5]),na.rm=T,var.equal=T)$p.value)
t.test(as.numeric(chkrVector[c(1:3)]),as.numeric(chkrVector[4:5]),na.rm=T,var.equal=T)$p.value
t.test(as.numeric(c(22.39459,20.48316,21.87155)),as.numeric(c(NA,20.34495)),na.rm=T,var.equal=T)$p.value
t.test(c(22.39459,20.48316,21.87155),c(NA,20.34495),na.rm=T,var.equal=T)$p.value
t.test(c(22.39459,20.48316,21.87155),c(NA,17.97),na.rm=T,var.equal=T)$p.value
t.test(c(21.4316,21.77155),c(NA,17.7),na.rm=T,var.equal=T)$p.value
t.test(c(21.4316,21.77155),c(17.6,17.7),na.rm=T,var.equal=F)$p.value
#https://biocorecrg.github.io/CRG_RIntroduction/volcano-plots.html
```

```{r proteinGroups, echo=FALSE}
data <- readxl::read_xlsx(inpF)
#clean
#data = data[!data$Reverse=="+",]
#data = data[!data$Potential.contaminant=="+",]
#data = data[!data$Only.identified.by.site=="+",]
#row.names(data)<-paste(row.names(data),data$Fasta.headers,data$Protein.IDs,data$Protein.names,data$Gene.names,data$Score,data$Peptide.counts..unique.,sep=";;")
summary(data)
dim(data)
selection<-"Abundance."
hist(as.matrix(log2(data[,grep(selection,colnames(data))])))
summary(log2(data[,grep(selection,colnames(data))]))
selection<-"Scaled"
#selection<-"Normalized"
selThr<-5
LFQ<-as.matrix(data[,grep(selection,colnames(data))])
#protNum<-1:ncol(LFQ)
colnames(LFQ)=sub(paste0("Abundances \\(",selection,"\\)\\: "),"",colnames(LFQ))
colnames(LFQ)=sub("\\: Sample","",colnames(LFQ))
dim(LFQ)
log2LFQ<-log2(LFQ)
log2LFQ[log2LFQ==-Inf]=NA
log2LFQ[log2LFQ==0]=NA
summary(log2LFQ)
Means<-apply(log2LFQ,1, mean, na.rm = TRUE)
Stdevs<-apply(log2LFQ,1, sd, na.rm = TRUE)
NAs<-rowSums(is.na(log2LFQ))
summary(NAs)
CVs<-Stdevs/Means
hist(log2LFQ)
rowName<-data$`FASTA Title Lines`
rowName<-sub("ProteinCenter:sp_tr_incl_isoforms\\|","",rowName)
rowName<-gsub("\r","",rowName)
rowName<-gsub("\n","",rowName)
rownames(data)<-rowName
uniprot<-paste(sapply(strsplit(paste(sapply(strsplit(rowName, ">",fixed=T), "[", 2)), " "), "[", 1))
writexl::write_xlsx(as.data.frame(cbind(rownames(data),Uniprot=uniprot,log2LFQ,NAs,CVs)),paste0(inpF,selection,selThr,"log2LFQ.xlsx"))
write.table(as.data.frame(cbind(Uniprot=rowName,log2LFQ,NAs,CVs)),paste0(inpF,selection,selThr,"log2LFQ.txt"),row.names = F,sep="\t",quote = FALSE)
```

```{r corHC}
corrplot::corrplot(cor(log2LFQ))
log2LFQ0=log2LFQ
log2LFQ0[log2LFQ0==NA]=0
pheatmap::pheatmap(log2LFQ0,clustering_distance_rows = "binary",clustering_distance_cols = "correlation",fontsize_row=4,cluster_cols=FALSE,cluster_rows=T,color = my_palette,fontsize_col  = 4)
scale=3
log2LFQimp<-matrix(rnorm(dim(log2LFQ)[1]*dim(log2LFQ)[2],mean=mean(log2LFQ,na.rm = T)-scale,sd=sd(log2LFQ,na.rm = T)/(scale)), dim(log2LFQ)[1],dim(log2LFQ)[2])
log2LFQimp[log2LFQimp<0]<-0
bk1 <- c(seq(-3,-0.01,by=0.01))
bk2 <- c(seq(0.01,3,by=0.01))
bk <- c(bk1,bk2)  #combine the break limits for purpose of graphing
my_palette <- c(colorRampPalette(colors = c("darkblue", "white"))(n = length(bk1)-1),
              "gray", "gray",
              c(colorRampPalette(colors = c("white","darkred"))(n = length(bk2)-1)))
pheatmap::pheatmap(log2LFQimp,clustering_distance_rows = "binary",clustering_distance_cols = "correlation",fontsize_row=4,cluster_cols=FALSE,cluster_rows=T,color = my_palette,fontsize_col  = 4)
colnames(log2LFQimp)<-colnames(log2LFQ)
pheatmap::pheatmap(log2LFQimp,clustering_distance_rows = "correlation",clustering_distance_cols = "correlation",fontsize_row=4,cluster_cols=T,cluster_rows=T,fontsize_col  = 4,labels_col = label$Sample_Name__)
log2LFQimpCorr<-cor(log2LFQ,use="pairwise.complete.obs",method="spearman")
colnames(log2LFQimpCorr)<-colnames(log2LFQ)
rownames(log2LFQimpCorr)<-colnames(log2LFQ)
pheatmap::pheatmap(log2LFQimpCorr,clustering_distance_rows = "euclidean",clustering_distance_cols = "euclidean",fontsize_row=4,cluster_cols=T,cluster_rows=T,fontsize_col  = 4,labels_col = label$Sample.Number,labels_row = label$Cell.Type_Sample.Group)
pheatmap::pheatmap(log2LFQimpCorr,clustering_distance_rows = "euclidean",clustering_distance_cols = "euclidean",fontsize_row=6,cluster_cols=T,cluster_rows=T,fontsize_col  = 6)
ggplot2::ggsave(file=paste0(inpF,selection,selThr,"log2spearClust.svg"),plot=svgPHC)
fn<-as.data.frame(label$File.Name[-1])
fn$`label$File.Name`<-sub("F\\:\\\\promec\\\\Qexactive\\\\Mirta\\\\Katja\\\\20210302_DDA_","",fn$`label$File.Name`)
rownames(fn)<-label$Study.File.ID[-1]
svgPHC<-pheatmap::pheatmap(log2LFQimpCorr,clustering_distance_rows = "euclidean",clustering_distance_cols = "euclidean",fontsize_row=8,cluster_cols=T,cluster_rows=T,fontsize_col  = 8,labels_col = fn$`label$File.Name`,labels_row = fn$`label$File.Name`)
ggplot2::ggsave(file=paste0(inpF,selection,selThr,"log2spearClust.svg"),plot=svgPHC)#,  
assign(paste0(selection,"clusterData"),log2LFQimpCorr)
write.txt(cbind(rownames(log2LFQimpCorr),log2LFQimpCorr),paste0(inpF,selection,selThr,"log2spearClust.txt"),row.names=F)
```


```{r Ctr}
sel<-"Ctr"
hda<-as.matrix(log2LFQ[,c(1:6)])
hist(as.matrix(hda))
hdaM<-apply(hda,1,function(x) if(sum(is.na(x))<ncol(hda)){median(x,na.rm=T)} else{0})
sum(hdaM>thr,na.rm=T)
limma::vennDiagram(hda[,1:5]>thr)
inpW<-paste0(inpF,hdr,sel,"LFQ.xlsx")
writexl::write_xlsx(as.data.frame(cbind(hdaM,hda,data$`FASTA Title Lines`)),inpW)
assign(paste0(sel,"median"),hdaM)
assign(paste0(sel,"all"),hda)
```

```{r KO}
sel<-"KO"
hda<-as.matrix(log2LFQ[,c(7:12)])
hist(as.matrix(hda))
hdaM<-apply(hda,1,function(x) if(sum(is.na(x))<ncol(hda)){median(x,na.rm=T)} else{0})
sum(hdaM>thr,na.rm=T)
limma::vennDiagram(hda[,1:5]>thr)
inpW<-paste0(inpF,hdr,sel,"LFQ.xlsx")
writexl::write_xlsx(as.data.frame(cbind(hdaM,hda,data$`FASTA Title Lines`)),inpW)
assign(paste0(sel,"median"),hdaM)
assign(paste0(sel,"all"),hda)
```


```{r vennMedians}
hda<-cbind(Ctrmedian,KOmedian)
hist(hda)
limma::vennDiagram(hda>thr)
writexl::write_xlsx(as.data.frame(cbind(Fasta=rownames(data),hda,Ctrall,KOall)),paste0(inpF,hdr,selection,"median.xlsx"))
write.csv(cbind(Fasta=rownames(data),hda,Ctrall,KOall),paste0(inpF,hdr,selection,"median.csv"),row.names = F)
```

```{r wKO, echo = FALSE}
dataSellog2grpTtest<-cbind(KOall[,c(2,4,5,6)],Ctrall[,c(2,3,5,6)])
summary(dataSellog2grpTtest)
compName<-colnames(dataSellog2grpTtest)
compName<-toString(compName)
compName<-gsub(" ", "",compName)
compName<-gsub("[^[:alnum:] ]", "",compName)
row.names(dataSellog2grpTtest)<-row.names(data)
sCol<-1
eCol<-8
mCol<-4
qThr<-3
t.test(as.numeric(dataSellog2grpTtest[1,c(sCol:mCol)]),as.numeric(dataSellog2grpTtest[1,c((mCol+1):eCol)]),na.rm=T)$p.value
chkr<-1
sum(!is.na(dataSellog2grpTtest[chkr,c(1:eCol)]))
t.test(as.numeric(dataSellog2grpTtest[chkr,c(sCol:mCol)]),as.numeric(dataSellog2grpTtest[chkr,c((mCol+1):eCol)]),na.rm=T)$p.value
dim(dataSellog2grpTtest)
options(nwarnings = 1000000)
pValNA = apply(
  dataSellog2grpTtest, 1, function(x)
    if(sum(!is.na(x[c(sCol:mCol)]))<2&sum(!is.na(x[c((mCol+1):eCol)]))<2){NA}
    else if(sum(is.na(x[c(sCol:mCol)]))==0&sum(is.na(x[c((mCol+1):eCol)]))==0){
      t.test(as.numeric(x[c(sCol:mCol)]),as.numeric(x[c((mCol+1):eCol)]),var.equal=F)$p.value}
    else if(sum(!is.na(x[c(sCol:mCol)]))>=2&sum(!is.na(x[c((mCol+1):eCol)]))==1&(as.numeric(quantile(as.numeric(x[c(sCol:mCol)]),na.rm=T)[1])-(qThr*IQR(as.numeric(x[c(sCol:mCol)]),na.rm=T)))>max(as.numeric(x[c((mCol+1):eCol)]),na.rm=T)){0}
    else if(sum(!is.na(x[c(sCol:mCol)]))>=2&sum(!is.na(x[c((mCol+1):eCol)]))==1&(as.numeric(quantile(as.numeric(x[c(sCol:mCol)]),na.rm=T)[5])+(qThr*IQR(as.numeric(x[c(sCol:mCol)]),na.rm=T)))<min(as.numeric(x[c((mCol+1):eCol)]),na.rm=T)){0}
    else if(sum(!is.na(x[c(sCol:mCol)]))==1&sum(!is.na(x[c((mCol+1):eCol)]))>=2&(as.numeric(quantile(as.numeric(x[c((mCol+1):eCol)]),na.rm=T)[1])-(qThr*IQR(as.numeric(x[c((mCol+1):eCol)]),na.rm=T))>max(as.numeric(x[c(sCol:mCol)]),na.rm=T))){0}
    else if(sum(!is.na(x[c(sCol:mCol)]))==1&sum(!is.na(x[c((mCol+1):eCol)]))>=2&(as.numeric(quantile(as.numeric(x[c((mCol+1):eCol)]),na.rm=T)[5])+(qThr*IQR(as.numeric(x[c((mCol+1):eCol)]),na.rm=T))<min(as.numeric(x[c(sCol:mCol)]),na.rm=T))){0}
    else if(sum(!is.na(x[c(sCol:mCol)]))>1&sum(!is.na(x[c((mCol+1):eCol)]))<1){0}
    else if(sum(!is.na(x[c(sCol:mCol)]))<1&sum(!is.na(x[c((mCol+1):eCol)]))>1){0}
    else if(sum(!is.na(x[c(sCol:mCol)]))>=2&sum(!is.na(x[c((mCol+1):eCol)]))==1&(as.numeric(quantile(as.numeric(x[c(sCol:mCol)]),na.rm=T)[1])-(qThr*IQR(as.numeric(x[c(sCol:mCol)]),na.rm=T)))<=max(as.numeric(x[c((mCol+1):eCol)]),na.rm=T)){1}
    else if(sum(!is.na(x[c(sCol:mCol)]))>=2&sum(!is.na(x[c((mCol+1):eCol)]))==1&(as.numeric(quantile(as.numeric(x[c(sCol:mCol)]),na.rm=T)[5])+(qThr*IQR(as.numeric(x[c(sCol:mCol)]),na.rm=T)))>=min(as.numeric(x[c((mCol+1):eCol)]),na.rm=T)){1}
    else if(sum(!is.na(x[c(sCol:mCol)]))==1&sum(!is.na(x[c((mCol+1):eCol)]))>=2&(as.numeric(quantile(as.numeric(x[c((mCol+1):eCol)]),na.rm=T)[1])-(qThr*IQR(as.numeric(x[c((mCol+1):eCol)]),na.rm=T))<=max(as.numeric(x[c(sCol:mCol)]),na.rm=T))){1}
    else if(sum(!is.na(x[c(sCol:mCol)]))==1&sum(!is.na(x[c((mCol+1):eCol)]))>=2&(as.numeric(quantile(as.numeric(x[c((mCol+1):eCol)]),na.rm=T)[5])+(qThr*IQR(as.numeric(x[c((mCol+1):eCol)]),na.rm=T))>=min(as.numeric(x[c(sCol:mCol)]),na.rm=T))){1}
    else if(sum(!is.na(x[c(sCol:mCol)]))>=2&sum(!is.na(x[c((mCol+1):eCol)]))>=2){
      t.test(as.numeric(x[c(sCol:mCol)]),as.numeric(x[c((mCol+1):eCol)]),na.rm=T,var.equal=F)$p.value}
  else{NA}
  )
summary(warnings())
hist(pValNA)
pValNAdm<-cbind(pValNA,dataSellog2grpTtest,row.names(data))
pValNAminusLog10 = -log10(pValNA+.Machine$double.xmin)
hist(pValNAminusLog10)
library(scales)
pValNAminusLog10=squish(pValNAminusLog10,c(0,5))
hist(pValNAminusLog10)
pValBHna = p.adjust(pValNA,method = "BH")
hist(pValBHna)
pValBHnaMinusLog10 = -log10(pValBHna+.Machine$double.xmin)
hist(pValBHnaMinusLog10)
dataSellog2grpTtestNum<-apply(dataSellog2grpTtest, 2,as.numeric)
logFCmedianGrp1 = matrixStats::rowMedians(dataSellog2grpTtestNum[,c(sCol:mCol)],na.rm=T)
logFCmedianGrp2 = matrixStats::rowMedians(dataSellog2grpTtestNum[,c((mCol+1):eCol)],na.rm=T)
logFCmedianGrp1[is.nan(logFCmedianGrp1)]=0
logFCmedianGrp2[is.nan(logFCmedianGrp2)]=0
logFCmedian = logFCmedianGrp1-logFCmedianGrp2
logFCmedianFC = 2^(logFCmedian+.Machine$double.xmin)
logFCmedianFC=squish(logFCmedianFC,c(0.01,100))
hist(logFCmedianFC)
log2FCmedianFC=log2(logFCmedianFC)
hist(log2FCmedianFC)
ttest.results = data.frame(Uniprot=rowName,PValueMinusLog10=pValNAminusLog10,FoldChanglog2median=logFCmedianFC,CorrectedPValueBH=pValBHna,TtestPval=pValNA,dataSellog2grpTtest,Log2MedianChange=logFCmedian,RowGeneUniProtScorePeps=rownames(dataSellog2grpTtest))
writexl::write_xlsx(ttest.results,paste0(inpF,selection,selThr,sCol,eCol,qThr,compName,"tTeswKO.xlsx"))
write.table(ttest.results,paste0(inpF,selection,selThr,sCol,eCol,qThr,compName,"tTeswKO.txt"),row.names = F,sep="\t")
#limma::vennDiagram(cbind(as.matrix(dataSellog2grpTtest[,c(sCol:mCol)]),as.matrix(dataSellog2grpTtest[,c((mCol+1):eCol)])))
limma::vennDiagram(cbind(logFCmedianGrp1,logFCmedianGrp2))
ttest.results[is.na(ttest.results)]=0.1
Significance=ttest.results$CorrectedPValueBH<0.1&ttest.results$CorrectedPValueBH>0&abs(ttest.results$Log2MedianChange)>1
sum(Significance)
```

```{r tKO, echo = FALSE}
dataSellog2grpTtest<-cbind(KOall[,c(2,4,5,6)],Ctrall[,c(2,3,5,6)])
comp<-"Ctr_KO"
dataSellog2grpTtest[dataSellog2grpTtest==0]=NA
summary(dataSellog2grpTtest)
row.names(dataSellog2grpTtest)<-row.names(data)
sCol<-1
eCol<-8
mCol<-4
cvThr<-0.05
t.test(as.numeric(dataSellog2grpTtest[1,c(sCol:mCol)]),as.numeric(dataSellog2grpTtest[1,c((mCol+1):eCol)]),na.rm=T)$p.value
chkr<-1
sum(!is.na(dataSellog2grpTtest[chkr,c(1:eCol)]))
t.test(as.numeric(dataSellog2grpTtest[chkr,c(sCol:mCol)]),as.numeric(dataSellog2grpTtest[chkr,c((mCol+1):eCol)]),na.rm=T)$p.value
dim(dataSellog2grpTtest)
options(nwarnings = 1000000)

pValNA = apply(
  dataSellog2grpTtest, 1, function(x)
    if(sum(!is.na(x[c(sCol:mCol)]))<2&sum(!is.na(x[c((mCol+1):eCol)]))<2){NA}
    else if(sum(is.na(x[c(sCol:mCol)]))==0&sum(is.na(x[c((mCol+1):eCol)]))==0){
      t.test(as.numeric(x[c(sCol:mCol)]),as.numeric(x[c((mCol+1):eCol)]),var.equal=T)$p.value}
    else if(sum(!is.na(x[c(sCol:mCol)]))>1&(min(x[c(sCol:mCol)],na.rm=T)==max(x[c(sCol:mCol)],na.rm=T))){0}
    else if(sum(!is.na(x[c((mCol+1):eCol)]))>1&(min(x[c((mCol+1):eCol)],na.rm=T)==max(x[c((mCol+1):eCol)],na.rm=T))){0}
    else if(sum(!is.na(x[c(sCol:mCol)]))>1&sum(!is.na(x[c((mCol+1):eCol)]))<1&(sd(x[c(sCol:mCol)],na.rm=T)/mean(x[c(sCol:mCol)],na.rm=T))<cvThr){0}
    else if(sum(!is.na(x[c(sCol:mCol)]))<1&sum(!is.na(x[c((mCol+1):eCol)]))>1&(sd(x[c((mCol+1):eCol)],na.rm=T)/mean(x[c((mCol+1):eCol)],na.rm=T))<cvThr){0}
    else if(sum(!is.na(x[c(sCol:mCol)]))>=2&sum(!is.na(x[c((mCol+1):eCol)]))>=1){
      t.test(as.numeric(x[c(sCol:mCol)]),as.numeric(x[c((mCol+1):eCol)]),na.rm=T,var.equal=T)$p.value}
    else if(sum(!is.na(x[c(sCol:mCol)]))>=1&sum(!is.na(x[c((mCol+1):eCol)]))>=2){
      t.test(as.numeric(x[c(sCol:mCol)]),as.numeric(x[c((mCol+1):eCol)]),na.rm=T,var.equal=T)$p.value}
  else{NA}
  )
summary(warnings())
hist(pValNA)
summary(pValNA)
dfpValNA<-as.data.frame(ceiling(pValNA))
pValNAdm<-cbind(pValNA,dataSellog2grpTtest,row.names(data))
pValNAminusLog10 = -log10(pValNA+.Machine$double.xmin)
hist(pValNAminusLog10)
library(scales)
pValNAminusLog10=squish(pValNAminusLog10,c(0,5))
hist(pValNAminusLog10)
length(pValNA)-(sum(is.na(pValNA))+sum(ceiling(pValNA)==0,na.rm = T))
pValBHna = p.adjust(pValNA,method = "BH")
hist(pValBHna)
pValBHnaMinusLog10 = -log10(pValBHna+.Machine$double.xmin)
hist(pValBHnaMinusLog10)
dataSellog2grpTtestNum<-apply(dataSellog2grpTtest, 2,as.numeric)
logFCmedianGrp1 = matrixStats::rowMedians(dataSellog2grpTtestNum[,c(sCol:mCol)],na.rm=T)
logFCmedianGrp2 = matrixStats::rowMedians(dataSellog2grpTtestNum[,c((mCol+1):eCol)],na.rm=T)
logFCmedianGrp1[is.nan(logFCmedianGrp1)]=0
logFCmedianGrp2[is.nan(logFCmedianGrp2)]=0
logFCmedian = logFCmedianGrp1-logFCmedianGrp2
logFCmedianFC = 2^(logFCmedian+.Machine$double.xmin)
logFCmedianFC=squish(logFCmedianFC,c(0.01,100))
hist(logFCmedianFC)
log2FCmedianFC=log2(logFCmedianFC)
hist(log2FCmedianFC)
ttest.results = data.frame(Uniprot=uniprot,PValueMinusLog10=pValNAminusLog10,FoldChanglog2median=logFCmedianFC,CorrectedPValueBH=pValBHna,TtestPval=pValNA,dataSellog2grpTtest,Log2MedianChange=logFCmedian,Description=rowName)
writexl::write_xlsx(ttest.results,paste0(inpF,hdr,selection,sCol,eCol,comp,selThr,selThrFC,cvThr,"tTestBH.xlsx"))
write.csv(ttest.results,paste0(inpF,hdr,selection,sCol,eCol,comp,selThr,selThrFC,cvThr,"tTestBH.csv"),row.names = F,quote = F)
#limma::vennDiagram(cbind(as.matrix(dataSellog2grpTtest[,c(sCol:mCol)]),as.matrix(dataSellog2grpTtest[,c((mCol+1):eCol)])))
limma::vennDiagram(cbind(logFCmedianGrp1,logFCmedianGrp2))
limma::vennDiagram(cbind(logFCmedianGrp1,logFCmedianGrp2))
data$RowGeneUniProtScorePeps<-data$Gene.names
ttest.results[is.na(ttest.results)]=selThr
Significance=ttest.results$CorrectedPValueBH<selThr&ttest.results$CorrectedPValueBH>0&abs(ttest.results$Log2MedianChange)>selThrFC
sum(Significance)
dsub <- subset(ttest.results,Significance)
p <- ggplot2::ggplot(ttest.results,ggplot2::aes(Log2MedianChange,PValueMinusLog10))+ ggplot2::geom_point(ggplot2::aes(color=Significance)) 
p<-p + ggplot2::theme_bw(base_size=8) + ggplot2::geom_text(data=dsub,ggplot2::aes(label=RowGeneUniProtScorePeps),hjust=0, vjust=0,size=1) + ggplot2::scale_fill_gradient(low="white", high="darkblue") + ggplot2::xlab("Log2 Median Change") + ggplot2::ylab("-Log10 P-value")
#f=paste(file,proc.time()[3],".jpg")
ggplot2::ggsave(paste0(inpF,hdr,selection,sCol,eCol,comp,selThr,selThrFC,cvThr,"VolcanoTest.svg"), p)
print(p)
```
