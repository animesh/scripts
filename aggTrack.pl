#! /usr/bin/perl -w

use strict;
use warnings;
use File::Temp "tempfile";

#aggTrack.pl name input output
#creates three custom tracks for wiggles generated by aggregate datapooints tool
#representing mean, minimum, and maximum values
#input format must look like this:
#chr2L	16296021	16296221	0.738439981826	0.00999999977648	1.46687996387
#chr2L	16298881	16299188	0.795374994166	0.00999999977648	1.58074998856
#where last three columns are mean, minimum, and maximum values
#

my ($f_mean, $fn_mean) = tempfile();
my ($f_min,  $fn_min)  = tempfile();
my ($f_max,  $fn_max)  = tempfile();
my ($fh_mean, $fhn_mean) = tempfile();
my ($fh_min,  $fhn_min)  = tempfile();
my ($fh_max,  $fhn_max)  = tempfile();
my @trackColors = ("0,70,255", "0,130,0", "255,0,0");
my @trackPriority = (10,20,30);

#Find min and max values


die "Not enough agruments\n" unless @ARGV == 3;

my $min = 1000000;
my $max = 0;

open (IN, "<$ARGV[1]") or die "Cannot open $ARGV[1]:$!\n";
while (<IN>) {
  chop;
  my @tmp  = split /\t/;
  if ($tmp[@tmp-2] ne "nan") { $min = $tmp[@tmp-2] if ($min > $tmp[@tmp-2]) }
  if ($tmp[@tmp-1] ne "nan") { $max = $tmp[@tmp-1] if ($max < $tmp[@tmp-1]) }
  print $f_mean (join("\t", @tmp[0..@tmp-4]) . "\t" . $tmp[@tmp-3] . "\n") unless ($tmp[@tmp-3] eq "nan");
  print $f_min  (join("\t", @tmp[0..@tmp-4]) . "\t" . $tmp[@tmp-2] . "\n") unless ($tmp[@tmp-2] eq "nan");
  print $f_max  (join("\t", @tmp[0..@tmp-4]) . "\t" . $tmp[@tmp-1] . "\n") unless ($tmp[@tmp-1] eq "nan");
}
$min = sprintf("%.3f", $min);
$max = sprintf("%.3f", $max);
close IN;

print $fh_mean "track type=wiggle_0 name=\"$ARGV[0]_mean\" description=\"mean\" visibility=full color=$trackColors[0] altColor=$trackColors[0] priority=$trackPriority[0] autoScale=off viewLimits=$min:$max\n";
print $fh_min  "track type=wiggle_0 name=\"$ARGV[0]_min\" description=\"minimum\" visibility=full color=$trackColors[1] altColor=$trackColors[1] priority=$trackPriority[1] autoScale=off viewLimits=$min:$max\n";
print $fh_max  "track type=wiggle_0 name=\"$ARGV[0]_max\" description=\"maximum\" visibility=full color=$trackColors[2] altColor=$trackColors[2] priority=$trackPriority[2] autoScale=off viewLimits=$min:$max\n";

my $catStatus = system("cat $fhn_mean $fn_mean $fhn_min $fn_min $fhn_max $fn_max > $ARGV[2]");
die "aggTrack exited abnormally: $?" unless $catStatus == 0;

`rm -f $fhn_mean $fn_mean $fhn_min $fn_min $fhn_max $fn_max`;
