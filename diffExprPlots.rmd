---
runtime: shiny
output: 
  html_document:
    theme: darkly
    highlight: tango
---

```{r setup, echo = FALSE}
libPaths="L:/promec/Animesh/R/win-library/4.0"
.libPaths(c(libPaths, .libPaths()))
#install.packages("htmltools",lib=.libPaths()[1])
#knitr::opts_chunk$set(echo=F)
#library(shiny)
#install.packages("shinythemes")
#library(shinythemes)
#theme = shinythemes::shinytheme("darkly")
```


```{r data, echo = FALSE}
fName<-"proteinGroups.txt"
inpD <-"L:/promec/Qexactive/Mirta/Celine/combined/txtLFQ1/"
inpF<-paste0(inpD,fName)
data <- data.table::fread(inpF)
#data<-data[!data$Reverse=="+",]
#summary(data)
```

```{r select, echo = FALSE}
sel<-grep("LFQ",names(data))
dataHigh<-data[data$`Q-value`==0,]
dataHigh<-dataHigh[,..sel]
#summary(dataHighNorm)
dataHighLog2<-log2(dataHigh)
#dataHighNormLog2[is.na(dataHighNormLog2)]<-rnorm(1)
#summary(dataHighNormLog2)
hist(as.matrix(dataHighLog2))
```

```{r vennDiagram, echo = FALSE}
limma::vennDiagram(dataHighLog2[,2:5]>20)
#ggplot::ggsave(file=paste0(inpF,"venn.svg"),plot=vplot)#,  width=6, height=6)
```

```{r corHC}
#corrplot::corrplot(cor(log2LFQ))
#log2LFQ0=log2LFQ
#log2LFQ0[log2LFQ0==NA]=0
#pheatmap::pheatmap(log2LFQ0,clustering_distance_rows = "binary",clustering_distance_cols = "correlation",fontsize_row=4,cluster_cols=FALSE,cluster_rows=T,color = my_palette,fontsize_col  = 4)
log2LFQ<-dataHighLog2
log2LFQ[log2LFQ==-Inf]=NA
scale=3
log2LFQimp<-matrix(rnorm(dim(log2LFQ)[1]*dim(log2LFQ)[2],mean=mean(log2LFQ,na.rm = T)-scale,sd=sd(log2LFQ,na.rm = T)/(scale)), dim(log2LFQ)[1],dim(log2LFQ)[2])
log2LFQimp[log2LFQimp<0]<-0
bk1 <- c(seq(-3,-0.01,by=0.01))
bk2 <- c(seq(0.01,3,by=0.01))
bk <- c(bk1,bk2)  #combine the break limits for purpose of graphing
my_palette <- c(colorRampPalette(colors = c("darkblue", "white"))(n = length(bk1)-1),
              "gray", "gray",
              c(colorRampPalette(colors = c("white","darkred"))(n = length(bk2)-1)))
colnames(log2LFQimp)<-colnames(log2LFQ)
#pheatmap::pheatmap(log2LFQimp,clustering_distance_rows = "binary",clustering_distance_cols = "correlation",fontsize_row=8,cluster_cols=T,cluster_rows=T,color = my_palette,fontsize_col  = 8)
#pheatmap::pheatmap(log2LFQimp,clustering_distance_rows = "correlation",clustering_distance_cols = "correlation",fontsize_row=1,cluster_cols=T,cluster_rows=T,fontsize_col  = 8)
log2LFQimpCorr<-cor(log2LFQ,use="pairwise.complete.obs",method="pearson")*cor(log2LFQ,use="pairwise.complete.obs",method="pearson")
colnames(log2LFQimpCorr)<-colnames(log2LFQ)
rownames(log2LFQimpCorr)<-colnames(log2LFQ)
svgPHC<-pheatmap::pheatmap(log2LFQimpCorr,clustering_distance_rows = "euclidean",clustering_distance_cols = "euclidean",fontsize_row=8,cluster_cols=T,cluster_rows=T,fontsize_col  = 8)
D#pheatmap::pheatmap(log2LFQimpCorr,clustering_distance_rows = "euclidean",clustering_distance_cols = "euclidean",fontsize_row=4,cluster_cols=T,cluster_rows=T,fontsize_col  = 4,labels_col = label$Sample.Number,labels_row = label$Cell.Type_Sample.Group)
svgPHC<-pheatmap::pheatmap(log2LFQimpCorr,clustering_distance_rows = "euclidean",clustering_distance_cols = "euclidean",fontsize_row=6,cluster_cols=T,cluster_rows=T,fontsize_col  = 6,labels_row = paste(label$RawFnum,label$ID_ROLF,label$Tank,label$Diet,label$Fish))
ggplot2::ggsave(file=paste0(inpF,selection,"log2spearClust.svg"),plot=svgPHC)#,  
assign(paste0(selection,"clusterData"),log2LFQimpCorr)
write.csv(cbind(rownames(log2LFQimpCorr),log2LFQimpCorr),paste0(inpF,selection,"log2spearClust.csv"),row.names=F)
```



```{r PCA, echo = FALSE}
dataHighNormLog2<-dataHighLog2[,2:7]
dataHighNormLog2[dataHighNormLog2==-Inf]=0
log2LFQt<-t(dataHighNormLog2)
row.names(log2LFQt)<-colnames(dataHighNormLog2)
log2LFQtPCA<-prcomp(log2LFQt)
log2LFQtPCAsumm<-summary(log2LFQtPCA)
plot(prcomp(log2LFQt))
plot(log2LFQtPCA$x[,1], log2LFQtPCA$x[,2], pch = 16, col = factor(rownames(log2LFQt)),xlab = paste0("PC1 (", round(100*log2LFQtPCAsumm$importance[2,1],1), "%)"), ylab = paste0("PC2 (", round(100*log2LFQtPCAsumm$importance[2,2],1), "%)"),main=paste("PCA 1/2 with 0 containing proteinGroups imputed","\nProtein groups", dim(log2LFQt)[2],"across samples",dim(log2LFQt)[1]))
op <- par(cex = 1)
legend("bottomright", col = factor(rownames(log2LFQt)), legend = factor(rownames(log2LFQt)), pch = 16)
```

```{r PCA3/4, echo = FALSE}
dataHighNormLog2<-dataHighLog2[,2:7]
dataHighNormLog2[dataHighNormLog2==-Inf]=0
log2LFQt<-t(dataHighNormLog2)
row.names(log2LFQt)<-colnames(dataHighNormLog2)
log2LFQtPCA<-prcomp(log2LFQt)
log2LFQtPCAsumm<-summary(log2LFQtPCA)
plot(prcomp(log2LFQt))
plot(log2LFQtPCA$x[,3], log2LFQtPCA$x[,4], pch = 16, col = factor(rownames(log2LFQt)),xlab = paste0("PC1 (", round(100*log2LFQtPCAsumm$importance[2,3],1), "%)"), ylab = paste0("PC2 (", round(100*log2LFQtPCAsumm$importance[2,4],1), "%)"),main=paste("PCA 1/2 with 0 containing proteinGroups imputed","\nProtein groups", dim(log2LFQt)[2],"across samples",dim(log2LFQt)[1]))
op <- par(cex = 1)
legend("bottomright", col = factor(rownames(log2LFQt)), legend = factor(rownames(log2LFQt)), pch = 16)
```

```{r PCA5/6, echo = FALSE}
dataHighNormLog2<-dataHighLog2[,2:7]
dataHighNormLog2[dataHighNormLog2==-Inf]=0
log2LFQt<-t(dataHighNormLog2)
row.names(log2LFQt)<-colnames(dataHighNormLog2)
log2LFQtPCA<-prcomp(log2LFQt)
log2LFQtPCAsumm<-summary(log2LFQtPCA)
plot(prcomp(log2LFQt))
plot(log2LFQtPCA$x[,5], log2LFQtPCA$x[,6], pch = 16, col = factor(rownames(log2LFQt)),xlab = paste0("PC1 (", round(100*log2LFQtPCAsumm$importance[2,5],1), "%)"), ylab = paste0("PC2 (", round(100*log2LFQtPCAsumm$importance[2,6],1), "%)"),main=paste("PCA 1/2 with 0 containing proteinGroups imputed","\nProtein groups", dim(log2LFQt)[2],"across samples",dim(log2LFQt)[1]))
op <- par(cex = 1)
legend("bottomright", col = factor(rownames(log2LFQt)), legend = factor(rownames(log2LFQt)), pch = 16)
```

```{r PCA4/1, echo = FALSE}
dataHighNormLog2<-dataHighLog2[,2:7]
dataHighNormLog2[dataHighNormLog2==-Inf]=0
log2LFQt<-t(dataHighNormLog2)
row.names(log2LFQt)<-colnames(dataHighNormLog2)
log2LFQtPCA<-prcomp(log2LFQt)
log2LFQtPCAsumm<-summary(log2LFQtPCA)
plot(prcomp(log2LFQt))
plot(log2LFQtPCA$x[,4], log2LFQtPCA$x[,1], pch = 16, col = factor(rownames(log2LFQt)),xlab = paste0("PC4 (", round(100*log2LFQtPCAsumm$importance[2,4],1), "%)"), ylab = paste0("PC1 (", round(100*log2LFQtPCAsumm$importance[2,1],1), "%)"),main=paste("PCA 4/1 with 0 containing proteinGroups imputed","\nProtein groups", dim(log2LFQt)[2],"across samples",dim(log2LFQt)[1]))
op <- par(cex = 1)
legend("topleft", col = factor(rownames(log2LFQt)), legend = factor(rownames(log2LFQt)), pch = 16)
```

```{r select, echo = FALSE}
sel<-grep("LFQ",names(data))
dataHigh<-data[data$`Q-value`==0,]
dataHighNorm<-dataHigh[,..sel]
#summary(dataHighNorm)
dataHighNormLog2<-log2(dataHighNorm)
#dataHighNormLog2[is.na(dataHighNormLog2)]<-rnorm(1)
#summary(dataHighNormLog2)
hist(as.matrix(dataHighNormLog2))
```

```{r corHC}
#corrplot::corrplot(cor(log2LFQ))
#log2LFQ0=log2LFQ
#log2LFQ0[log2LFQ0==NA]=0
#pheatmap::pheatmap(log2LFQ0,clustering_distance_rows = "binary",clustering_distance_cols = "correlation",fontsize_row=4,cluster_cols=FALSE,cluster_rows=T,color = my_palette,fontsize_col  = 4)
log2LFQ<-dataHighNormLog2
log2LFQ[log2LFQ==-Inf]=NA
scale=3
log2LFQimp<-matrix(rnorm(dim(log2LFQ)[1]*dim(log2LFQ)[2],mean=mean(log2LFQ,na.rm = T)-scale,sd=sd(log2LFQ,na.rm = T)/(scale)), dim(log2LFQ)[1],dim(log2LFQ)[2])
log2LFQimp[log2LFQimp<0]<-0
bk1 <- c(seq(-3,-0.01,by=0.01))
bk2 <- c(seq(0.01,3,by=0.01))
bk <- c(bk1,bk2)  #combine the break limits for purpose of graphing
my_palette <- c(colorRampPalette(colors = c("darkblue", "white"))(n = length(bk1)-1),
              "gray", "gray",
              c(colorRampPalette(colors = c("white","darkred"))(n = length(bk2)-1)))
colnames(log2LFQimp)<-colnames(log2LFQ)
#pheatmap::pheatmap(log2LFQimp,clustering_distance_rows = "binary",clustering_distance_cols = "correlation",fontsize_row=8,cluster_cols=T,cluster_rows=T,color = my_palette,fontsize_col  = 8)
#pheatmap::pheatmap(log2LFQimp,clustering_distance_rows = "correlation",clustering_distance_cols = "correlation",fontsize_row=1,cluster_cols=T,cluster_rows=T,fontsize_col  = 8)
log2LFQimpCorr<-cor(log2LFQ,use="pairwise.complete.obs",method="pearson")*cor(log2LFQ,use="pairwise.complete.obs",method="pearson")
colnames(log2LFQimpCorr)<-colnames(log2LFQ)
rownames(log2LFQimpCorr)<-colnames(log2LFQ)
svgPHC<-pheatmap::pheatmap(log2LFQimpCorr,clustering_distance_rows = "euclidean",clustering_distance_cols = "euclidean",fontsize_row=8,cluster_cols=T,cluster_rows=T,fontsize_col  = 8)
D#pheatmap::pheatmap(log2LFQimpCorr,clustering_distance_rows = "euclidean",clustering_distance_cols = "euclidean",fontsize_row=4,cluster_cols=T,cluster_rows=T,fontsize_col  = 4,labels_col = label$Sample.Number,labels_row = label$Cell.Type_Sample.Group)
svgPHC<-pheatmap::pheatmap(log2LFQimpCorr,clustering_distance_rows = "euclidean",clustering_distance_cols = "euclidean",fontsize_row=6,cluster_cols=T,cluster_rows=T,fontsize_col  = 6,labels_row = paste(label$RawFnum,label$ID_ROLF,label$Tank,label$Diet,label$Fish))
ggplot2::ggsave(file=paste0(inpF,selection,"log2spearClust.svg"),plot=svgPHC)#,  
assign(paste0(selection,"clusterData"),log2LFQimpCorr)
write.csv(cbind(rownames(log2LFQimpCorr),log2LFQimpCorr),paste0(inpF,selection,"log2spearClust.csv"),row.names=F)
```




```{r vennDiagram, echo = FALSE}
limma::vennDiagram(dataHighNormLog2[,1:4]>30)
#ggplot::ggsave(file=paste0(inpF,"venn.svg"),plot=vplot)#,  width=6, height=6)
```

```{r PCA, echo = FALSE}
dataHighNormLog2<-dataHighNormLog2[,1:4]
dataHighNormLog2[dataHighNormLog2==-Inf]=0
log2LFQt<-t(dataHighNormLog2)
row.names(log2LFQt)<-colnames(dataHighNormLog2)
log2LFQtPCA<-prcomp(log2LFQt)
log2LFQtPCAsumm<-summary(log2LFQtPCA)
plot(prcomp(log2LFQt))
plot(log2LFQtPCA$x[,1], log2LFQtPCA$x[,2], pch = 16, col = factor(rownames(log2LFQt)),xlab = paste0("PC1 (", round(100*log2LFQtPCAsumm$importance[2,1],1), "%)"), ylab = paste0("PC2 (", round(100*log2LFQtPCAsumm$importance[2,2],1), "%)"),main=paste("PCA 1/2 with 0 containing proteinGroups imputed","\nProtein groups", dim(log2LFQt)[2],"across samples",dim(log2LFQt)[1]))
op <- par(cex = 1)
legend("bottomright", col = factor(rownames(log2LFQt)), legend = factor(rownames(log2LFQt)), pch = 16)
```


```{r react, echo = FALSE}
inputPanel(shiny::selectInput("lfq", label = "LFQ", choices = c(sel)))
output<-shiny::reactive({input$lfq})
```


