```{r data}
inpD<-"F:/GD/"
inpF<-paste0(inpD,"Log2LFQwithBasicStats - 05.04.20 (676 protein groups) - to Animesh.xlsx")
#install.packages("readxl")
library(readxl)
data<-read_xlsx(inpF)#,header=T,sep="\t",row.names = 1)
data<-data[1:676,]

gn<-gsub("^(.*?);.*", "\\1",data[["T: T: Gene names"]])
gn<-paste(sapply(gn, "[", 1))
pn<-gsub("^(.*?);.*", "\\1",data[["T: T: Protein IDs"]])
pn<-paste(sapply(pn, "[", 1))
pnm<-gsub("^(.*?);.*", "\\1",data[["T: T: Protein names"]])
pnm<-paste(sapply(pnm, "[", 1))
sMQ<-gsub("^(.*?);.*", "\\1",data[["N: N: Score"]])
sMQ<-paste(sapply(sMQ, "[", 1))
pepMQ<-gsub("^(.*?);.*", "\\1",data[["N: N: Peptides"]])
pepMQ<-paste(sapply(pepMQ, "[", 1))

row.names(data)<-paste(row.names(data),gn,pn,pnm,sMQ,pepMQ,sep=";")
summary(data)
```

```{r write-excel, echo = FALSE}
#install.packages("writexl")
library("writexl")
inpW<-paste0(inpD,"Copy of Log2LFQwithBasicStats - 15.10.18 (cut off 18) Label.write.xlsx")
write_xlsx(data,inpW)
```

```{r label}
inpL<-paste0(inpD,"Copy of Log2LFQwithBasicStats - 15.10.18 (cut off 18) Label.xlsx")
label<-read_xlsx(inpL)#read.table(inpL,header=T,row.names=1,sep="\t")#, colClasses=c(rep("factor",3)))
#colnames(label)=sub("\\-[0-9]+","",colnames(label))
#colnames(label)
summary(label)
rownames(label)<-label[['Name']]
rownames(label)
```

```{r clean, echo = FALSE}
#decoyPrefix="REV__"
#dfNoRev<-data[-grep(decoyPrefix, rownames(data)),]
#dataClean = data[!data$Reverse=="+",]
dataClean = data[!data[["Reverse"]]=="+",]
#setdiff(rownames(dfNoRev),rownames(dataClean))
dataClean = dataClean[!dataClean[["Potential.contaminant"]]=="+",]
dataClean = dataClean[!dataClean[["Only.identified.by.site"]]=="+",]
summary(dataClean)
```

```{r select}
hdr="LFQ.intensity."
#dataSel=as.matrix(data[,grep(hdr,colnames(data))])
dataSel=as.matrix(dataClean[,grep(hdr,colnames(dataClean))])
#dataSel=as.matrix(dataSel[,grep("pass",colnames(dataSel))])
colnames(dataSel)<-sub(hdr,"Log2_",colnames(dataSel))
colnames(dataSel)
summary(dataSel)
```

```{r log-tranform}
dataSellog2<-log2(dataSel)
dataSellog2[dataSellog2==-Inf]=NA
summary(dataSellog2)
```

```{r impute, echo = FALSE}
#install.packages('mice')
library(mice)
#install.packages('randomForest')
library(randomForest)
dataNormImp=mice(dataSellog2, method="rf")
dataNormImpCom <- complete(dataNormImp,1)
row.names(dataNormImpCom)<-row.names(dataNorm)
summary(dataNormImpCom)
```

```{r write-output, echo = FALSE}
write.csv(dataNormImpCom,file=paste0(inpD,"log2dataImp.csv"))
#write.csv(factors,file=paste0(inpD,"dataNormImpComFactor.csv"))
dataNormImpCom <- read.csv(paste0(inpD,"log2dataImp.csv"),row.names=1,header = T)
#factors<-read.csv(paste0(inpD,"dataNormImpComFactor.csv"))
#dump(dataNorm,file=paste0(inpD,"dataNorm.R"))
```

```{r t-test, echo = FALSE}
library(ggplot2)
library(svglite)
for(cnt in seq(4)){
  eCol<-cnt*3;
  sCol<-cnt*3-2;
  mCol<-3;#round((eCol-sCol+1)/2);
  cat(paste(cnt,sCol,eCol,mCol,"\n"));
  dataSellog2grpTtest<-dataSellog2[,c(sCol:eCol,16:18)]
#}
  pValNA = apply(
  dataSellog2grpTtest, 1, function(x)
    if(sum(!is.na(x[c(1:mCol)]))<2&sum(!is.na(x[c((mCol+1):6)]))<2){1}
    else if(sum(!is.na(x[c(1:mCol)]))>=2&sum(!is.na(x[c((mCol+1):6)]))==1){1}
    else if(sum(!is.na(x[c(1:mCol)]))==1&sum(!is.na(x[c((mCol+1):6)]))>=2){1}
    else if(sum(!is.na(x[c(1:mCol)]))>1&sum(!is.na(x[c((mCol+1):6)]))<1){0}
    else if(sum(!is.na(x[c(1:mCol)]))<1&sum(!is.na(x[c((mCol+1):6)]))>1){0}
    else{t.test(as.numeric(x[c(1:mCol)]),as.numeric(x[c((mCol+1):6)]),na.rm=T,var.equal=T)$p.value})
  hist(pValNA)
  pValNAminusLog10 = -log10(pValNA+.Machine$double.xmin)
  hist(pValNAminusLog10)
  library(scales)
  pValNAminusLog10=squish(pValNAminusLog10,c(0,5))
  hist(pValNAminusLog10)
  pValBHna = p.adjust(pValNA,method = "BH")
  hist(pValBHna)
  pValBHnaMinusLog10 = -log10(pValBHna+.Machine$double.xmin)
  hist(pValBHnaMinusLog10)
  logFCmedianGrp1 = matrixStats::rowMedians(dataSellog2grpTtest[,c(1:mCol)],na.rm=T)
  logFCmedianGrp2 = matrixStats::rowMedians(dataSellog2grpTtest[,c((mCol+1):6)],na.rm=T)
  logFCmedianGrp1[is.nan(logFCmedianGrp1)]=0
  logFCmedianGrp2[is.nan(logFCmedianGrp2)]=0
  logFCmedian = logFCmedianGrp1-logFCmedianGrp2
  hist(logFCmedian)
  logFCmedianFC = 2^(logFCmedian+.Machine$double.xmin)
  hist(logFCmedianFC)
  logFCmedianFC=squish(logFCmedianFC,c(0.01,100))
  hist(logFCmedianFC)
  log2FCmedianFC=log2(logFCmedianFC)
  hist(log2FCmedianFC)
  rownames(dataSellog2grpTtest)
  rowName<-strsplit(rownames(dataSellog2grpTtest), ";")
  rowName<-paste(sapply(rowName, "[", 1))
  rowName<-strsplit(rowName, "-")
  rowName<-paste(sapply(rowName, "[", 1))
  #https://stackoverflow.com/a/44400007/1137129
  ttest.results = data.frame(Uniprot=rowName,PValueMinusLog10=pValNAminusLog10,FoldChanglog2median=logFCmedianFC,CorrectedPValueBH=pValBHna,TtestPval=pValNA,dataSellog2grpTtest,Log2MedianChange=logFCmedian)
  write.csv(ttest.results,file=paste(inpF,hdr,sCol,eCol,cnt,"tTestBHgrp.csv",sep="."))
  dsub=subset(ttest.results,ttest.results$TtestPval<0.05&abs(ttest.results$Log2MedianChange)>0.58)
  protNum<-1:nrow(dsub)
  row.names(dsub) <- paste(dsub[["Uniprot"]],protNum,sep="_")
  g = ggplot(ttest.results,aes(Log2MedianChange,PValueMinusLog10))+geom_point(aes(color=CorrectedPValueBH),size=0.15) + theme_bw(base_size=10) +geom_text(data=dsub,aes(label=row.names(dsub)), vjust=0.5, size=1.5) + xlab(paste("Log2 Fold Change",sCol,eCol))  + ylab("-Log10 P-value") + ggtitle("Differentially Expressed Protein Groups") + scale_size_area()+scale_color_gradient(low="#FF9933", high="#99CC66") 
  plot(g)#+ geom_jitter())
  #install.packages("svglite")
  ggsave(file=paste(inpF,hdr,sCol,eCol,cnt,"volcanoPlotgrp.svg",sep="."),plot=g)#,  width=6, height=6)
}
```

```{r test, echo = FALSE}
#lc1<-data[,label[label[["Comparisons"]]=="1",1]]
#dplyr::select(data,unlist(label[(label$Comparisons=="1")&(!is.na(label$Comparisons)),1]))
dataSellog2grpTtest<-data[,unlist(label[(label$Comparisons=="1")&(!is.na(label$Comparisons)),1])]
dataSellog2grpTtest
dataSellog2grpTtest<-as.matrix(dataSellog2grpTtest[,c(1,2,6,7,3,4,5)])
dataSellog2grpTtest<-gsub("NaN", NA, dataSellog2grpTtest)
dataSellog2grpTtest<-gsub("NA", NA, dataSellog2grpTtest)
row.names(dataSellog2grpTtest)<-row.names(data)
#dataSellog2grpTtest<-dataSellog2grpTtest[rowSums(is.na(dataSellog2grpTtest)) != ncol(dataSellog2grpTtest), ]
dataSellog2grpTtest
sCol<-1
eCol<-7
mCol<-4
t.test(as.numeric(dataSellog2grpTtest[1,c(1:mCol)]),as.numeric(dataSellog2grpTtest[1,c((mCol+1):eCol)]),na.rm=T)$p.value
chkr<-1#nrow(dataSellog2grpTtest)
dataSellog2grpTtest[chkr,c(1:mCol)]
dataSellog2grpTtest[chkr,c((mCol+1):eCol)]
sum(!is.na(dataSellog2grpTtest[chkr,c(1:eCol)]))
dim(dataSellog2grpTtest)
dim(dataSellog2grpTtest)[1]
apply(dataSellog2grpTtest[chkr,], 1, function(x) if(sum(!is.na(x[c(1:mCol)]))<2&sum(!is.na(x[c((mCol+1):eCol)]))<2){1} #if(sum(!is.na(x[c(1:eCol)]))>2){1} #else{t.test(as.numeric(x[c(1:mCol)]),as.numeric(x[c((mCol+1):eCol)]),na.rm=T,var.equal=T)$p.value}
      )
pValNA = apply(
  dataSellog2grpTtest, 1, function(x)
    if(sum(!is.na(x[c(1:eCol)]))<2){1}
    else if(sum(!is.na(x[c(1:mCol)]))<2&sum(!is.na(x[c((mCol+1):eCol)]))<2){1}
    else if(sum(!is.na(x[c(1:mCol)]))>=2&sum(!is.na(x[c((mCol+1):eCol)]))==1){1}
    else if(sum(!is.na(x[c(1:mCol)]))==1&sum(!is.na(x[c((mCol+1):eCol)]))>=2){1}
    else if(sum(!is.na(x[c(1:mCol)]))>1&sum(!is.na(x[c((mCol+1):eCol)]))<1){0}
    else if(sum(!is.na(x[c(1:mCol)]))<1&sum(!is.na(x[c((mCol+1):eCol)]))>1){0}
    else{t.test(as.numeric(x[c(1:mCol)]),as.numeric(x[c((mCol+1):eCol)]),na.rm=T,var.equal=T)$p.value})
hist(pValNA)
pValNAminusLog10 = -log10(pValNA+.Machine$double.xmin)
hist(pValNAminusLog10)
library(scales)
pValNAminusLog10=squish(pValNAminusLog10,c(0,5))
hist(pValNAminusLog10)
pValBHna = p.adjust(pValNA,method = "BH")
hist(pValBHna)
pValBHnaMinusLog10 = -log10(pValBHna+.Machine$double.xmin)
hist(pValBHnaMinusLog10)
dataSellog2grpTtestNum<-apply(dataSellog2grpTtest, 2,as.numeric)
logFCmedianGrp1 = matrixStats::rowMedians(dataSellog2grpTtestNum[,c(1:mCol)],na.rm=T)
logFCmedianGrp2 = matrixStats::rowMedians(dataSellog2grpTtestNum[,c((mCol+1):eCol)],na.rm=T)
logFCmedianGrp1[is.nan(logFCmedianGrp1)]=0
logFCmedianGrp2[is.nan(logFCmedianGrp2)]=0
logFCmedian = logFCmedianGrp1-logFCmedianGrp2
hist(logFCmedian)
logFCmedianFC = 2^(logFCmedian+.Machine$double.xmin)
hist(logFCmedianFC)
logFCmedianFC=squish(logFCmedianFC,c(0.01,100))
hist(logFCmedianFC)
log2FCmedianFC=log2(logFCmedianFC)
hist(log2FCmedianFC)
rownames(dataSellog2grpTtest)
rowName<-strsplit(rownames(dataSellog2grpTtest), ";")
rowName<-paste(sapply(rowName, "[", 3))
rowName<-strsplit(rowName, "-")
rowName<-paste(sapply(rowName, "[", 1))
#https://stackoverflow.com/a/44400007/1137129
ttest.results = data.frame(Uniprot=rowName,PValueMinusLog10=pValNAminusLog10,FoldChanglog2median=logFCmedianFC,CorrectedPValueBH=pValBHna,TtestPval=pValNA,dataSellog2grpTtest,Log2MedianChange=logFCmedian)
write.csv(ttest.results,file=paste0(inpF,hdr,sCol,eCol,"tTestBHgrp.csv"))
```

```{r w-test-AT/E, echo = FALSE}
#lc1<-data[,label[label[["Comparisons"]]=="1",1]]
#dplyr::select(data,unlist(label[(label$Comparisons=="1")&(!is.na(label$Comparisons)),1]))
dataSellog2grpTtest<-data[,unlist(label[(label$Comparisons=="1")&(!is.na(label$Comparisons)),1])]
#dataSellog2grpTtest
dataSellog2grpTtest<-as.matrix(dataSellog2grpTtest[,c(1,2,6,7,3,4,5)])
dataSellog2grpTtest<-gsub("NaN", NA, dataSellog2grpTtest)
dataSellog2grpTtest<-gsub("NA", NA, dataSellog2grpTtest)
row.names(dataSellog2grpTtest)<-row.names(data)
#dataSellog2grpTtest<-dataSellog2grpTtest[rowSums(is.na(dataSellog2grpTtest)) != ncol(dataSellog2grpTtest), ]
#dataSellog2grpTtest
sCol<-1
eCol<-7
mCol<-4
t.test(as.numeric(dataSellog2grpTtest[1,c(1:mCol)]),as.numeric(dataSellog2grpTtest[1,c((mCol+1):eCol)]),na.rm=T)$p.value
chkr<-1#nrow(dataSellog2grpTtest)
dataSellog2grpTtest[chkr,c(1:mCol)]
dataSellog2grpTtest[chkr,c((mCol+1):eCol)]
sum(!is.na(dataSellog2grpTtest[chkr,c(1:eCol)]))
dim(dataSellog2grpTtest)
dim(dataSellog2grpTtest)[1]
pValNA = apply(
  dataSellog2grpTtest, 1, function(x)
    if(sum(!is.na(x[c(1:eCol)]))<2){1}
    else if(sum(!is.na(x[c(1:mCol)]))<2&sum(!is.na(x[c((mCol+1):eCol)]))<2){1}
    else if(sum(!is.na(x[c(1:mCol)]))>=2&sum(!is.na(x[c((mCol+1):eCol)]))==1&((quantile(as.numeric(x[c(1:mCol)]),probs=c(.025,.975),na.rm=T)[1])>max(as.numeric(x[c((mCol+1):eCol)]),na.rm=T))){0}
    else if(sum(!is.na(x[c(1:mCol)]))>=2&sum(!is.na(x[c((mCol+1):eCol)]))==1&((quantile(as.numeric(x[c(1:mCol)]),probs=c(.025,.975),na.rm=T)[2])<min(as.numeric(x[c((mCol+1):eCol)]),na.rm=T))){0}
    else if(sum(!is.na(x[c(1:mCol)]))>=2&sum(!is.na(x[c((mCol+1):eCol)]))==1){1}
    else if(sum(!is.na(x[c(1:mCol)]))==1&sum(!is.na(x[c((mCol+1):eCol)]))>=2&((quantile(as.numeric(x[c((mCol+1):eCol)]),probs=c(.025,.975),na.rm=T)[1])>max(as.numeric(x[c(1:mCol)]),na.rm=T))){0}
    else if(sum(!is.na(x[c(1:mCol)]))>=2&sum(!is.na(x[c((mCol+1):eCol)]))==1&((quantile(as.numeric(x[c((mCol+1):eCol)]),probs=c(.025,.975),na.rm=T)[2])<min(as.numeric(x[c(1:mCol)]),na.rm=T))){0}
    else if(sum(!is.na(x[c(1:mCol)]))==1&sum(!is.na(x[c((mCol+1):eCol)]))>=2){1}
    else if(sum(!is.na(x[c(1:mCol)]))>1&sum(!is.na(x[c((mCol+1):eCol)]))<1){0}
    else if(sum(!is.na(x[c(1:mCol)]))<1&sum(!is.na(x[c((mCol+1):eCol)]))>1){0}
    else{t.test(as.numeric(x[c(1:mCol)]),as.numeric(x[c((mCol+1):eCol)]),na.rm=T,var.equal=F)$p.value})
hist(pValNA)
pValNAminusLog10 = -log10(pValNA+.Machine$double.xmin)
hist(pValNAminusLog10)
library(scales)
pValNAminusLog10=squish(pValNAminusLog10,c(0,5))
hist(pValNAminusLog10)
pValBHna = p.adjust(pValNA,method = "BH")
hist(pValBHna)
pValBHnaMinusLog10 = -log10(pValBHna+.Machine$double.xmin)
hist(pValBHnaMinusLog10)
dataSellog2grpTtestNum<-apply(dataSellog2grpTtest, 2,as.numeric)
logFCmedianGrp1 = matrixStats::rowMedians(dataSellog2grpTtestNum[,c(1:mCol)],na.rm=T)
logFCmedianGrp2 = matrixStats::rowMedians(dataSellog2grpTtestNum[,c((mCol+1):eCol)],na.rm=T)
logFCmedianGrp1[is.nan(logFCmedianGrp1)]=0
logFCmedianGrp2[is.nan(logFCmedianGrp2)]=0
logFCmedian = logFCmedianGrp1-logFCmedianGrp2
hist(logFCmedian)
logFCmedianFC = 2^(logFCmedian+.Machine$double.xmin)
hist(logFCmedianFC)
logFCmedianFC=squish(logFCmedianFC,c(0.01,100))
hist(logFCmedianFC)
log2FCmedianFC=log2(logFCmedianFC)
hist(log2FCmedianFC)
#rownames(dataSellog2grpTtest)
rowName<-strsplit(rownames(dataSellog2grpTtest), ";")
rowName<-paste(sapply(rowName, "[", 3))
rowName<-strsplit(rowName, "-")
rowName<-paste(sapply(rowName, "[", 1))
#https://stackoverflow.com/a/44400007/1137129
ttest.results = data.frame(Uniprot=rowName,PValueMinusLog10=pValNAminusLog10,FoldChanglog2median=logFCmedianFC,CorrectedPValueBH=pValBHna,TtestPval=pValNA,dataSellog2grpTtest,Log2MedianChange=logFCmedian,RowGeneUniProtScorePeps=rownames(dataSellog2grpTtest))
#write.csv(ttest.results,file=paste0(inpF,hdr,sCol,eCol,"wTestBHgrp.csv"))
write_xlsx(ttest.results,paste0(inpF,hdr,sCol,eCol,"wTestBHgrp.xlsx"))
```

```{r w-test-SAE/T, echo = FALSE}
#lc1<-data[,label[label[["Comparisons"]]=="1",1]]
#dplyr::select(data,unlist(label[(label$Comparisons=="1")&(!is.na(label$Comparisons)),1]))
dataSellog2grpTtest<-data[,unlist(label[(label$Comparisons=="2")&(!is.na(label$Comparisons)),1])]
dataSellog2grpTtest
dataSellog2grpTtest<-as.matrix(dataSellog2grpTtest[,c(1,2,3,4,5,6)])
dataSellog2grpTtest<-gsub("NaN", NA, dataSellog2grpTtest)
dataSellog2grpTtest<-gsub("NA", NA, dataSellog2grpTtest)
row.names(dataSellog2grpTtest)<-row.names(data)
#dataSellog2grpTtest<-dataSellog2grpTtest[rowSums(is.na(dataSellog2grpTtest)) != ncol(dataSellog2grpTtest), ]
dataSellog2grpTtest
sCol<-1
eCol<-6
mCol<-4
t.test(as.numeric(dataSellog2grpTtest[1,c(1:mCol)]),as.numeric(dataSellog2grpTtest[1,c((mCol+1):eCol)]),na.rm=T)$p.value
chkr<-1#nrow(dataSellog2grpTtest)
dataSellog2grpTtest[chkr,c(1:mCol)]
dataSellog2grpTtest[chkr,c((mCol+1):eCol)]
sum(!is.na(dataSellog2grpTtest[chkr,c(1:eCol)]))
dim(dataSellog2grpTtest)
dim(dataSellog2grpTtest)[1]
pValNA = apply(
  dataSellog2grpTtest, 1, function(x)
    if(sum(!is.na(x[c(1:eCol)]))<2){1}
    else if(sum(!is.na(x[c(1:mCol)]))<2&sum(!is.na(x[c((mCol+1):eCol)]))<2){1}
    else if(sum(!is.na(x[c(1:mCol)]))>=2&sum(!is.na(x[c((mCol+1):eCol)]))==1&((quantile(as.numeric(x[c(1:mCol)]),probs=c(.025,.975),na.rm=T)[1])>max(as.numeric(x[c((mCol+1):eCol)]),na.rm=T))){0}
    else if(sum(!is.na(x[c(1:mCol)]))>=2&sum(!is.na(x[c((mCol+1):eCol)]))==1&((quantile(as.numeric(x[c(1:mCol)]),probs=c(.025,.975),na.rm=T)[2])<min(as.numeric(x[c((mCol+1):eCol)]),na.rm=T))){0}
    else if(sum(!is.na(x[c(1:mCol)]))>=2&sum(!is.na(x[c((mCol+1):eCol)]))==1){1}
    else if(sum(!is.na(x[c(1:mCol)]))==1&sum(!is.na(x[c((mCol+1):eCol)]))>=2&((quantile(as.numeric(x[c((mCol+1):eCol)]),probs=c(.025,.975),na.rm=T)[1])>max(as.numeric(x[c(1:mCol)]),na.rm=T))){0}
    else if(sum(!is.na(x[c(1:mCol)]))>=2&sum(!is.na(x[c((mCol+1):eCol)]))==1&((quantile(as.numeric(x[c((mCol+1):eCol)]),probs=c(.025,.975),na.rm=T)[2])<min(as.numeric(x[c(1:mCol)]),na.rm=T))){0}
    else if(sum(!is.na(x[c(1:mCol)]))==1&sum(!is.na(x[c((mCol+1):eCol)]))>=2){1}
    else if(sum(!is.na(x[c(1:mCol)]))>1&sum(!is.na(x[c((mCol+1):eCol)]))<1){0}
    else if(sum(!is.na(x[c(1:mCol)]))<1&sum(!is.na(x[c((mCol+1):eCol)]))>1){0}
    else{t.test(as.numeric(x[c(1:mCol)]),as.numeric(x[c((mCol+1):eCol)]),na.rm=T,var.equal=F)$p.value})
hist(pValNA)
pValNAminusLog10 = -log10(pValNA+.Machine$double.xmin)
hist(pValNAminusLog10)
library(scales)
pValNAminusLog10=squish(pValNAminusLog10,c(0,5))
hist(pValNAminusLog10)
pValBHna = p.adjust(pValNA,method = "BH")
hist(pValBHna)
pValBHnaMinusLog10 = -log10(pValBHna+.Machine$double.xmin)
hist(pValBHnaMinusLog10)
dataSellog2grpTtestNum<-apply(dataSellog2grpTtest, 2,as.numeric)
logFCmedianGrp1 = matrixStats::rowMedians(dataSellog2grpTtestNum[,c(1:mCol)],na.rm=T)
logFCmedianGrp2 = matrixStats::rowMedians(dataSellog2grpTtestNum[,c((mCol+1):eCol)],na.rm=T)
logFCmedianGrp1[is.nan(logFCmedianGrp1)]=0
logFCmedianGrp2[is.nan(logFCmedianGrp2)]=0
logFCmedian = logFCmedianGrp1-logFCmedianGrp2
hist(logFCmedian)
logFCmedianFC = 2^(logFCmedian+.Machine$double.xmin)
hist(logFCmedianFC)
logFCmedianFC=squish(logFCmedianFC,c(0.01,100))
hist(logFCmedianFC)
log2FCmedianFC=log2(logFCmedianFC)
hist(log2FCmedianFC)
#rownames(dataSellog2grpTtest)
rowName<-strsplit(rownames(dataSellog2grpTtest), ";")
rowName<-paste(sapply(rowName, "[", 3))
rowName<-strsplit(rowName, "-")
rowName<-paste(sapply(rowName, "[", 1))
#https://stackoverflow.com/a/44400007/1137129
ttest.results = data.frame(Uniprot=rowName,PValueMinusLog10=pValNAminusLog10,FoldChanglog2median=logFCmedianFC,CorrectedPValueBH=pValBHna,TtestPval=pValNA,dataSellog2grpTtest,Log2MedianChange=logFCmedian,RowGeneUniProtScorePeps=rownames(dataSellog2grpTtest))
#write.csv(ttest.results,file=paste0(inpF,hdr,sCol,eCol,"wTestBHgrp.csv"))
write_xlsx(ttest.results,paste0(inpF,hdr,sCol,eCol,"wTestBHgrp.xlsx"))
```

```{r w-test-APE/T, echo = FALSE}
#lc1<-data[,label[label[["Comparisons"]]=="1",1]]
#dplyr::select(data,unlist(label[(label$Comparisons=="1")&(!is.na(label$Comparisons)),1]))
dataSellog2grpTtest<-data[,unlist(label[(label$Comparisons=="3")&(!is.na(label$Comparisons)),1])]
dataSellog2grpTtest
dataSellog2grpTtest<-as.matrix(dataSellog2grpTtest[,c(1,2,3,4,5,6,7,8,9)])
dataSellog2grpTtest<-gsub("NaN", NA, dataSellog2grpTtest)
dataSellog2grpTtest<-gsub("NA", NA, dataSellog2grpTtest)
row.names(dataSellog2grpTtest)<-row.names(data)
#dataSellog2grpTtest<-dataSellog2grpTtest[rowSums(is.na(dataSellog2grpTtest)) != ncol(dataSellog2grpTtest), ]
dataSellog2grpTtest
sCol<-1
eCol<-9
mCol<-4
t.test(as.numeric(dataSellog2grpTtest[1,c(1:mCol)]),as.numeric(dataSellog2grpTtest[1,c((mCol+1):eCol)]),na.rm=T)$p.value
chkr<-1#nrow(dataSellog2grpTtest)
dataSellog2grpTtest[chkr,c(1:mCol)]
dataSellog2grpTtest[chkr,c((mCol+1):eCol)]
sum(!is.na(dataSellog2grpTtest[chkr,c(1:eCol)]))
dim(dataSellog2grpTtest)
dim(dataSellog2grpTtest)[1]
pValNA = apply(
  dataSellog2grpTtest, 1, function(x)
    if(sum(!is.na(x[c(1:eCol)]))<2){1}
    else if(sum(!is.na(x[c(1:mCol)]))<2&sum(!is.na(x[c((mCol+1):eCol)]))<2){1}
    else if(sum(!is.na(x[c(1:mCol)]))>=2&sum(!is.na(x[c((mCol+1):eCol)]))==1&((quantile(as.numeric(x[c(1:mCol)]),probs=c(.025,.975),na.rm=T)[1])>max(as.numeric(x[c((mCol+1):eCol)]),na.rm=T))){0}
    else if(sum(!is.na(x[c(1:mCol)]))>=2&sum(!is.na(x[c((mCol+1):eCol)]))==1&((quantile(as.numeric(x[c(1:mCol)]),probs=c(.025,.975),na.rm=T)[2])<min(as.numeric(x[c((mCol+1):eCol)]),na.rm=T))){0}
    else if(sum(!is.na(x[c(1:mCol)]))>=2&sum(!is.na(x[c((mCol+1):eCol)]))==1){1}
    else if(sum(!is.na(x[c(1:mCol)]))==1&sum(!is.na(x[c((mCol+1):eCol)]))>=2&((quantile(as.numeric(x[c((mCol+1):eCol)]),probs=c(.025,.975),na.rm=T)[1])>max(as.numeric(x[c(1:mCol)]),na.rm=T))){0}
    else if(sum(!is.na(x[c(1:mCol)]))>=2&sum(!is.na(x[c((mCol+1):eCol)]))==1&((quantile(as.numeric(x[c((mCol+1):eCol)]),probs=c(.025,.975),na.rm=T)[2])<min(as.numeric(x[c(1:mCol)]),na.rm=T))){0}
    else if(sum(!is.na(x[c(1:mCol)]))==1&sum(!is.na(x[c((mCol+1):eCol)]))>=2){1}
    else if(sum(!is.na(x[c(1:mCol)]))>1&sum(!is.na(x[c((mCol+1):eCol)]))<1){0}
    else if(sum(!is.na(x[c(1:mCol)]))<1&sum(!is.na(x[c((mCol+1):eCol)]))>1){0}
    else{t.test(as.numeric(x[c(1:mCol)]),as.numeric(x[c((mCol+1):eCol)]),na.rm=T,var.equal=F)$p.value})
hist(pValNA)
pValNAminusLog10 = -log10(pValNA+.Machine$double.xmin)
hist(pValNAminusLog10)
library(scales)
pValNAminusLog10=squish(pValNAminusLog10,c(0,5))
hist(pValNAminusLog10)
pValBHna = p.adjust(pValNA,method = "BH")
hist(pValBHna)
pValBHnaMinusLog10 = -log10(pValBHna+.Machine$double.xmin)
hist(pValBHnaMinusLog10)
dataSellog2grpTtestNum<-apply(dataSellog2grpTtest, 2,as.numeric)
logFCmedianGrp1 = matrixStats::rowMedians(dataSellog2grpTtestNum[,c(1:mCol)],na.rm=T)
logFCmedianGrp2 = matrixStats::rowMedians(dataSellog2grpTtestNum[,c((mCol+1):eCol)],na.rm=T)
logFCmedianGrp1[is.nan(logFCmedianGrp1)]=0
logFCmedianGrp2[is.nan(logFCmedianGrp2)]=0
logFCmedian = logFCmedianGrp1-logFCmedianGrp2
hist(logFCmedian)
logFCmedianFC = 2^(logFCmedian+.Machine$double.xmin)
hist(logFCmedianFC)
logFCmedianFC=squish(logFCmedianFC,c(0.01,100))
hist(logFCmedianFC)
log2FCmedianFC=log2(logFCmedianFC)
hist(log2FCmedianFC)
#rownames(dataSellog2grpTtest)
rowName<-strsplit(rownames(dataSellog2grpTtest), ";")
rowName<-paste(sapply(rowName, "[", 3))
rowName<-strsplit(rowName, "-")
rowName<-paste(sapply(rowName, "[", 1))
#https://stackoverflow.com/a/44400007/1137129
ttest.results = data.frame(Uniprot=rowName,PValueMinusLog10=pValNAminusLog10,FoldChanglog2median=logFCmedianFC,CorrectedPValueBH=pValBHna,TtestPval=pValNA,dataSellog2grpTtest,Log2MedianChange=logFCmedian,RowGeneUniProtScorePeps=rownames(dataSellog2grpTtest))
#write.csv(ttest.results,file=paste0(inpF,hdr,sCol,eCol,"wTestBHgrp.csv"))
write_xlsx(ttest.results,paste0(inpF,hdr,sCol,eCol,"wTestBHgrp.xlsx"))
```

```{r w-test-T/SA, echo = FALSE}
#lc1<-data[,label[label[["Comparisons"]]=="1",1]]
#dplyr::select(data,unlist(label[(label$Comparisons=="1")&(!is.na(label$Comparisons)),1]))
dataSellog2grpTtest<-data[,unlist(label[(label$`Comparisons beads...10`=="1")&(!is.na(label$`Comparisons beads...10`)),1])]
dataSellog2grpTtest
dataSellog2grpTtest<-as.matrix(dataSellog2grpTtest[,c(1,2,9:13,3:8)])
dataSellog2grpTtest<-gsub("NaN", NA, dataSellog2grpTtest)
dataSellog2grpTtest<-gsub("NA", NA, dataSellog2grpTtest)
row.names(dataSellog2grpTtest)<-row.names(data)
#dataSellog2grpTtest<-dataSellog2grpTtest[rowSums(is.na(dataSellog2grpTtest)) != ncol(dataSellog2grpTtest), ]
dataSellog2grpTtest
sCol<-1
eCol<-13
mCol<-7
t.test(as.numeric(dataSellog2grpTtest[1,c(1:mCol)]),as.numeric(dataSellog2grpTtest[1,c((mCol+1):eCol)]),na.rm=T)$p.value
chkr<-1#nrow(dataSellog2grpTtest)
dataSellog2grpTtest[chkr,c(1:mCol)]
dataSellog2grpTtest[chkr,c((mCol+1):eCol)]
sum(!is.na(dataSellog2grpTtest[chkr,c(1:eCol)]))
dim(dataSellog2grpTtest)
dim(dataSellog2grpTtest)[1]
pValNA = apply(
  dataSellog2grpTtest, 1, function(x)
    if(sum(!is.na(x[c(1:eCol)]))<2){1}
    else if(sum(!is.na(x[c(1:mCol)]))<2&sum(!is.na(x[c((mCol+1):eCol)]))<2){1}
    else if(sum(!is.na(x[c(1:mCol)]))>=2&sum(!is.na(x[c((mCol+1):eCol)]))==1&((quantile(as.numeric(x[c(1:mCol)]),probs=c(.025,.975),na.rm=T)[1])>max(as.numeric(x[c((mCol+1):eCol)]),na.rm=T))){0}
    else if(sum(!is.na(x[c(1:mCol)]))>=2&sum(!is.na(x[c((mCol+1):eCol)]))==1&((quantile(as.numeric(x[c(1:mCol)]),probs=c(.025,.975),na.rm=T)[2])<min(as.numeric(x[c((mCol+1):eCol)]),na.rm=T))){0}
    else if(sum(!is.na(x[c(1:mCol)]))>=2&sum(!is.na(x[c((mCol+1):eCol)]))==1){1}
    else if(sum(!is.na(x[c(1:mCol)]))==1&sum(!is.na(x[c((mCol+1):eCol)]))>=2&((quantile(as.numeric(x[c((mCol+1):eCol)]),probs=c(.025,.975),na.rm=T)[1])>max(as.numeric(x[c(1:mCol)]),na.rm=T))){0}
    else if(sum(!is.na(x[c(1:mCol)]))>=2&sum(!is.na(x[c((mCol+1):eCol)]))==1&((quantile(as.numeric(x[c((mCol+1):eCol)]),probs=c(.025,.975),na.rm=T)[2])<min(as.numeric(x[c(1:mCol)]),na.rm=T))){0}
    else if(sum(!is.na(x[c(1:mCol)]))==1&sum(!is.na(x[c((mCol+1):eCol)]))>=2){1}
    else if(sum(!is.na(x[c(1:mCol)]))>1&sum(!is.na(x[c((mCol+1):eCol)]))<1){0}
    else if(sum(!is.na(x[c(1:mCol)]))<1&sum(!is.na(x[c((mCol+1):eCol)]))>1){0}
    else{t.test(as.numeric(x[c(1:mCol)]),as.numeric(x[c((mCol+1):eCol)]),na.rm=T,var.equal=F)$p.value})
hist(pValNA)
pValNAminusLog10 = -log10(pValNA+.Machine$double.xmin)
hist(pValNAminusLog10)
library(scales)
pValNAminusLog10=squish(pValNAminusLog10,c(0,5))
hist(pValNAminusLog10)
pValBHna = p.adjust(pValNA,method = "BH")
hist(pValBHna)
pValBHnaMinusLog10 = -log10(pValBHna+.Machine$double.xmin)
hist(pValBHnaMinusLog10)
dataSellog2grpTtestNum<-apply(dataSellog2grpTtest, 2,as.numeric)
logFCmedianGrp1 = matrixStats::rowMedians(dataSellog2grpTtestNum[,c(1:mCol)],na.rm=T)
logFCmedianGrp2 = matrixStats::rowMedians(dataSellog2grpTtestNum[,c((mCol+1):eCol)],na.rm=T)
logFCmedianGrp1[is.nan(logFCmedianGrp1)]=0
logFCmedianGrp2[is.nan(logFCmedianGrp2)]=0
logFCmedian = logFCmedianGrp1-logFCmedianGrp2
hist(logFCmedian)
logFCmedianFC = 2^(logFCmedian+.Machine$double.xmin)
hist(logFCmedianFC)
logFCmedianFC=squish(logFCmedianFC,c(0.01,100))
hist(logFCmedianFC)
log2FCmedianFC=log2(logFCmedianFC)
hist(log2FCmedianFC)
#rownames(dataSellog2grpTtest)
rowName<-strsplit(rownames(dataSellog2grpTtest), ";")
rowName<-paste(sapply(rowName, "[", 3))
rowName<-strsplit(rowName, "-")
rowName<-paste(sapply(rowName, "[", 1))
#https://stackoverflow.com/a/44400007/1137129
ttest.results = data.frame(Uniprot=rowName,PValueMinusLog10=pValNAminusLog10,FoldChanglog2median=logFCmedianFC,CorrectedPValueBH=pValBHna,TtestPval=pValNA,dataSellog2grpTtest,Log2MedianChange=logFCmedian,RowGeneUniProtScorePeps=rownames(dataSellog2grpTtest))
#write.csv(ttest.results,file=paste0(inpF,hdr,sCol,eCol,"wTestBHgrp.csv"))
write_xlsx(ttest.results,paste0(inpF,hdr,sCol,eCol,"wTestBHgrp.xlsx"))
```
```{r w-test-SA/AP, echo = FALSE}
#lc1<-data[,label[label[["Comparisons"]]=="1",1]]
#dplyr::select(data,unlist(label[(label$Comparisons=="1")&(!is.na(label$Comparisons)),1]))
dataSellog2grpTtest<-data[,unlist(label[(label$`Comparisons beads...11`=="2")&(!is.na(label$`Comparisons beads...11`)),1])]
dataSellog2grpTtest
dataSellog2grpTtest<-as.matrix(dataSellog2grpTtest[,c(1:6,7:15)])
dataSellog2grpTtest<-gsub("NaN", NA, dataSellog2grpTtest)
dataSellog2grpTtest<-gsub("NA", NA, dataSellog2grpTtest)
row.names(dataSellog2grpTtest)<-row.names(data)
#dataSellog2grpTtest<-dataSellog2grpTtest[rowSums(is.na(dataSellog2grpTtest)) != ncol(dataSellog2grpTtest), ]
dataSellog2grpTtest
sCol<-1
eCol<-15
mCol<-6
t.test(as.numeric(dataSellog2grpTtest[1,c(1:mCol)]),as.numeric(dataSellog2grpTtest[1,c((mCol+1):eCol)]),na.rm=T)$p.value
chkr<-1#nrow(dataSellog2grpTtest)
dataSellog2grpTtest[chkr,c(1:mCol)]
dataSellog2grpTtest[chkr,c((mCol+1):eCol)]
sum(!is.na(dataSellog2grpTtest[chkr,c(1:eCol)]))
dim(dataSellog2grpTtest)
dim(dataSellog2grpTtest)[1]
pValNA = apply(
  dataSellog2grpTtest, 1, function(x)
    if(sum(!is.na(x[c(1:eCol)]))<2){1}
    else if(sum(!is.na(x[c(1:mCol)]))<2&sum(!is.na(x[c((mCol+1):eCol)]))<2){1}
    else if(sum(!is.na(x[c(1:mCol)]))>=2&sum(!is.na(x[c((mCol+1):eCol)]))==1&((quantile(as.numeric(x[c(1:mCol)]),probs=c(.025,.975),na.rm=T)[1])>max(as.numeric(x[c((mCol+1):eCol)]),na.rm=T))){0}
    else if(sum(!is.na(x[c(1:mCol)]))>=2&sum(!is.na(x[c((mCol+1):eCol)]))==1&((quantile(as.numeric(x[c(1:mCol)]),probs=c(.025,.975),na.rm=T)[2])<min(as.numeric(x[c((mCol+1):eCol)]),na.rm=T))){0}
    else if(sum(!is.na(x[c(1:mCol)]))>=2&sum(!is.na(x[c((mCol+1):eCol)]))==1){1}
    else if(sum(!is.na(x[c(1:mCol)]))==1&sum(!is.na(x[c((mCol+1):eCol)]))>=2&((quantile(as.numeric(x[c((mCol+1):eCol)]),probs=c(.025,.975),na.rm=T)[1])>max(as.numeric(x[c(1:mCol)]),na.rm=T))){0}
    else if(sum(!is.na(x[c(1:mCol)]))>=2&sum(!is.na(x[c((mCol+1):eCol)]))==1&((quantile(as.numeric(x[c((mCol+1):eCol)]),probs=c(.025,.975),na.rm=T)[2])<min(as.numeric(x[c(1:mCol)]),na.rm=T))){0}
    else if(sum(!is.na(x[c(1:mCol)]))==1&sum(!is.na(x[c((mCol+1):eCol)]))>=2){1}
    else if(sum(!is.na(x[c(1:mCol)]))>1&sum(!is.na(x[c((mCol+1):eCol)]))<1){0}
    else if(sum(!is.na(x[c(1:mCol)]))<1&sum(!is.na(x[c((mCol+1):eCol)]))>1){0}
    else{t.test(as.numeric(x[c(1:mCol)]),as.numeric(x[c((mCol+1):eCol)]),na.rm=T,var.equal=F)$p.value})
hist(pValNA)
pValNAminusLog10 = -log10(pValNA+.Machine$double.xmin)
hist(pValNAminusLog10)
library(scales)
pValNAminusLog10=squish(pValNAminusLog10,c(0,5))
hist(pValNAminusLog10)
pValBHna = p.adjust(pValNA,method = "BH")
hist(pValBHna)
pValBHnaMinusLog10 = -log10(pValBHna+.Machine$double.xmin)
hist(pValBHnaMinusLog10)
dataSellog2grpTtestNum<-apply(dataSellog2grpTtest, 2,as.numeric)
logFCmedianGrp1 = matrixStats::rowMedians(dataSellog2grpTtestNum[,c(1:mCol)],na.rm=T)
logFCmedianGrp2 = matrixStats::rowMedians(dataSellog2grpTtestNum[,c((mCol+1):eCol)],na.rm=T)
logFCmedianGrp1[is.nan(logFCmedianGrp1)]=0
logFCmedianGrp2[is.nan(logFCmedianGrp2)]=0
logFCmedian = logFCmedianGrp1-logFCmedianGrp2
hist(logFCmedian)
logFCmedianFC = 2^(logFCmedian+.Machine$double.xmin)
hist(logFCmedianFC)
logFCmedianFC=squish(logFCmedianFC,c(0.01,100))
hist(logFCmedianFC)
log2FCmedianFC=log2(logFCmedianFC)
hist(log2FCmedianFC)
#rownames(dataSellog2grpTtest)
rowName<-strsplit(rownames(dataSellog2grpTtest), ";")
rowName<-paste(sapply(rowName, "[", 3))
rowName<-strsplit(rowName, "-")
rowName<-paste(sapply(rowName, "[", 1))
#https://stackoverflow.com/a/44400007/1137129
ttest.results = data.frame(Uniprot=rowName,PValueMinusLog10=pValNAminusLog10,FoldChanglog2median=logFCmedianFC,CorrectedPValueBH=pValBHna,TtestPval=pValNA,dataSellog2grpTtest,Log2MedianChange=logFCmedian,RowGeneUniProtScorePeps=rownames(dataSellog2grpTtest))
#write.csv(ttest.results,file=paste0(inpF,hdr,sCol,eCol,"wTestBHgrp.csv"))
write_xlsx(ttest.results,paste0(inpF,hdr,sCol,eCol,"wTestBHgrp.xlsx"))
```

```{r w-test-T/AP, echo = FALSE}
#lc1<-data[,label[label[["Comparisons"]]=="1",1]]
#dplyr::select(data,unlist(label[(label$Comparisons=="1")&(!is.na(label$Comparisons)),1]))
dataSellog2grpTtest<-data[,unlist(label[(label$`Comparisons beads...12`=="3")&(!is.na(label$`Comparisons beads...12`)),1])]
dataSellog2grpTtest
dataSellog2grpTtest<-as.matrix(dataSellog2grpTtest[,c(1,2,12:16,3:11)])
dataSellog2grpTtest<-gsub("NaN", NA, dataSellog2grpTtest)
dataSellog2grpTtest<-gsub("NA", NA, dataSellog2grpTtest)
row.names(dataSellog2grpTtest)<-row.names(data)
#dataSellog2grpTtest<-dataSellog2grpTtest[rowSums(is.na(dataSellog2grpTtest)) != ncol(dataSellog2grpTtest), ]
dataSellog2grpTtest
sCol<-1
eCol<-16
mCol<-7
t.test(as.numeric(dataSellog2grpTtest[1,c(1:mCol)]),as.numeric(dataSellog2grpTtest[1,c((mCol+1):eCol)]),na.rm=T)$p.value
chkr<-1#nrow(dataSellog2grpTtest)
dataSellog2grpTtest[chkr,c(1:mCol)]
dataSellog2grpTtest[chkr,c((mCol+1):eCol)]
sum(!is.na(dataSellog2grpTtest[chkr,c(1:eCol)]))
dim(dataSellog2grpTtest)
dim(dataSellog2grpTtest)[1]
pValNA = apply(
  dataSellog2grpTtest, 1, function(x)
    if(sum(!is.na(x[c(1:eCol)]))<2){1}
    else if(sum(!is.na(x[c(1:mCol)]))<2&sum(!is.na(x[c((mCol+1):eCol)]))<2){1}
    else if(sum(!is.na(x[c(1:mCol)]))>=2&sum(!is.na(x[c((mCol+1):eCol)]))==1&((quantile(as.numeric(x[c(1:mCol)]),probs=c(.025,.975),na.rm=T)[1])>max(as.numeric(x[c((mCol+1):eCol)]),na.rm=T))){0}
    else if(sum(!is.na(x[c(1:mCol)]))>=2&sum(!is.na(x[c((mCol+1):eCol)]))==1&((quantile(as.numeric(x[c(1:mCol)]),probs=c(.025,.975),na.rm=T)[2])<min(as.numeric(x[c((mCol+1):eCol)]),na.rm=T))){0}
    else if(sum(!is.na(x[c(1:mCol)]))>=2&sum(!is.na(x[c((mCol+1):eCol)]))==1){1}
    else if(sum(!is.na(x[c(1:mCol)]))==1&sum(!is.na(x[c((mCol+1):eCol)]))>=2&((quantile(as.numeric(x[c((mCol+1):eCol)]),probs=c(.025,.975),na.rm=T)[1])>max(as.numeric(x[c(1:mCol)]),na.rm=T))){0}
    else if(sum(!is.na(x[c(1:mCol)]))>=2&sum(!is.na(x[c((mCol+1):eCol)]))==1&((quantile(as.numeric(x[c((mCol+1):eCol)]),probs=c(.025,.975),na.rm=T)[2])<min(as.numeric(x[c(1:mCol)]),na.rm=T))){0}
    else if(sum(!is.na(x[c(1:mCol)]))==1&sum(!is.na(x[c((mCol+1):eCol)]))>=2){1}
    else if(sum(!is.na(x[c(1:mCol)]))>1&sum(!is.na(x[c((mCol+1):eCol)]))<1){0}
    else if(sum(!is.na(x[c(1:mCol)]))<1&sum(!is.na(x[c((mCol+1):eCol)]))>1){0}
    else{t.test(as.numeric(x[c(1:mCol)]),as.numeric(x[c((mCol+1):eCol)]),na.rm=T,var.equal=F)$p.value})
hist(pValNA)
pValNAminusLog10 = -log10(pValNA+.Machine$double.xmin)
hist(pValNAminusLog10)
library(scales)
pValNAminusLog10=squish(pValNAminusLog10,c(0,5))
hist(pValNAminusLog10)
pValBHna = p.adjust(pValNA,method = "BH")
hist(pValBHna)
pValBHnaMinusLog10 = -log10(pValBHna+.Machine$double.xmin)
hist(pValBHnaMinusLog10)
dataSellog2grpTtestNum<-apply(dataSellog2grpTtest, 2,as.numeric)
logFCmedianGrp1 = matrixStats::rowMedians(dataSellog2grpTtestNum[,c(1:mCol)],na.rm=T)
logFCmedianGrp2 = matrixStats::rowMedians(dataSellog2grpTtestNum[,c((mCol+1):eCol)],na.rm=T)
logFCmedianGrp1[is.nan(logFCmedianGrp1)]=0
logFCmedianGrp2[is.nan(logFCmedianGrp2)]=0
logFCmedian = logFCmedianGrp1-logFCmedianGrp2
hist(logFCmedian)
logFCmedianFC = 2^(logFCmedian+.Machine$double.xmin)
hist(logFCmedianFC)
logFCmedianFC=squish(logFCmedianFC,c(0.01,100))
hist(logFCmedianFC)
log2FCmedianFC=log2(logFCmedianFC)
hist(log2FCmedianFC)
#rownames(dataSellog2grpTtest)
rowName<-strsplit(rownames(dataSellog2grpTtest), ";")
rowName<-paste(sapply(rowName, "[", 3))
rowName<-strsplit(rowName, "-")
rowName<-paste(sapply(rowName, "[", 1))
#https://stackoverflow.com/a/44400007/1137129
ttest.results = data.frame(Uniprot=rowName,PValueMinusLog10=pValNAminusLog10,FoldChanglog2median=logFCmedianFC,CorrectedPValueBH=pValBHna,TtestPval=pValNA,dataSellog2grpTtest,Log2MedianChange=logFCmedian,RowGeneUniProtScorePeps=rownames(dataSellog2grpTtest))
#write.csv(ttest.results,file=paste0(inpF,hdr,sCol,eCol,"wTestBHgrp.csv"))
write_xlsx(ttest.results,paste0(inpF,hdr,sCol,eCol,"wTestBHgrp.xlsx"))
```

```{r T/SA/AP-PC, echo = FALSE}
#lc1<-data[,label[label[["Comparisons"]]=="1",1]]
#dplyr::select(data,unlist(label[(label$Comparisons=="1")&(!is.na(label$Comparisons)),1]))
#dataSellog2grpTtest<-data[,unlist(label[(label$`Plasma comparison`=="1")&(!is.na(label$`Plasma comparison`)),1])]
dataSellog2grpTtest<-data[,unlist(label[(!is.na(label$`Plasma comparison`)),1])]
dataSellog2grpTtest
dataSellog2grpTtest<-as.matrix(dataSellog2grpTtest[,c(20,1,2,22,23,18,19,21,3:8,9:17)])
dataSellog2grpTtest[,1]<-gsub("NaN", 0, dataSellog2grpTtest[,1])
dataSellog2grpTtest[,1]<-gsub("NA", 0, dataSellog2grpTtest[,1])
dataSellog2grpTtest<-gsub("NaN", NA, dataSellog2grpTtest)
dataSellog2grpTtest<-gsub("NA", NA, dataSellog2grpTtest)
row.names(dataSellog2grpTtest)<-row.names(data)
dataSellog2grpTtest
sCol<-1
eCol<-23
mCol<-2
t.test(as.numeric(dataSellog2grpTtest[1,c(1:mCol)]),as.numeric(dataSellog2grpTtest[1,c((mCol+1):eCol)]),na.rm=T)$p.value
chkr<-1#nrow(dataSellog2grpTtest)
dataSellog2grpTtest[chkr,c(1:mCol)]
dataSellog2grpTtest[chkr,c((mCol+1):eCol)]
sum(!is.na(dataSellog2grpTtest[chkr,c(1:eCol)]))
dim(dataSellog2grpTtest)
dim(dataSellog2grpTtest)[1]
dataSellog2grpTtestNum<-apply(dataSellog2grpTtest, 2,as.numeric)
dataSellog2grpTtestNum<-dataSellog2grpTtestNum-dataSellog2grpTtestNum[,1]
dataSellog2grpTtestNum[dataSellog2grpTtestNum==0]<-NA
hist(dataSellog2grpTtestNum)
dataSellog2grpTtestNum<-dataSellog2grpTtestNum[,-1]
plot(sort(dataSellog2grpTtestNum[,1],decreasing=T))
grpBrk<-c(4,7,11,13,17,22)
dTT<-matrixStats::rowMedians(dataSellog2grpTtestNum[,1:4],na.rm=T)
dTE<-matrixStats::rowMedians(dataSellog2grpTtestNum[,5:7],na.rm=T)
dSAE<-matrixStats::rowMedians(dataSellog2grpTtestNum[,8:11],na.rm=T)
dSAT<-matrixStats::rowMedians(dataSellog2grpTtestNum[,12:13],na.rm=T)
dAPE<-matrixStats::rowMedians(dataSellog2grpTtestNum[,14:17],na.rm=T)
dAPT<-matrixStats::rowMedians(dataSellog2grpTtestNum[,18:22],na.rm=T)
plot(sort(dTT,decreasing=T))
dPC<-as.numeric(dataSellog2grpTtest[,1])
dPC[order(dPC,decreasing=T)]
dTE[order(dPC,decreasing=T)]
plot(dTT[order(dTT,decreasing=T)])
plot(dTT[order(dPC,decreasing=T)])
plot(dTE[order(dPC,decreasing=T)])
plot(dTT[order(dPC,decreasing=T)],dTE[order(dPC,decreasing=T)])
plot(dSAT[order(dPC,decreasing=T)],dSAE[order(dPC,decreasing=T)])
plot(sort(dTE,decreasing=T))
dTTsd<-matrixStats::rowSds(dataSellog2grpTtestNum[,1:4],na.rm=T)
dTEsd<-matrixStats::rowSds(dataSellog2grpTtestNum[,5:7],na.rm=T)
dSAEsd<-matrixStats::rowSds(dataSellog2grpTtestNum[,8:11],na.rm=T)
dSATsd<-matrixStats::rowSds(dataSellog2grpTtestNum[,12:13],na.rm=T)
dAPEsd<-matrixStats::rowSds(dataSellog2grpTtestNum[,14:17],na.rm=T)
dAPTsd<-matrixStats::rowSds(dataSellog2grpTtestNum[,18:22],na.rm=T)
plot(sort(dTTsd,decreasing=T))
plot(sort(dTEsd,decreasing=T))
plot(dTT)
arrows(dTT-dTTsd,dTT+dTTsd,dTT-dTTsd,dTT+dTTsd)#,length=0.05, angle=90, code=3)
plot(dTT-dTTsd,dTT+dTTsd)#,length=0.05, angle=90, code=3)
plot(dTT,dTTsd)#,length=0.05, angle=90, code=3)
plot(dTE,dTEsd)#,length=0.05, angle=90, code=3)
```

```{r t-test-TT, echo = FALSE}
sCol<-1
eCol<-4
pc=as.numeric(dataSellog2grpTtest[,1])
dData=dataSellog2grpTtest[,(sCol+1):(eCol+1)]
dTTd<-dataSellog2grpTtestNum[,sCol:eCol]+.Machine$double.xmin
dTTd<-cbind(dTTd,pc)
row.names(dTTd)<-row.names(data)
t.test(dTTd[1,],na.rm=T)$p.value
chkr<-1#nrow(dataSellog2grpTtest)
dTTd[chkr,]
sum(!is.na(dTTd[chkr,]))
dim(dTTd)
dim(dTTd)[1]
xxx<-c(-12.8099,-12.8091,NA)
#xxx<-c(-12.8099,NA,NA)
sd(xxx,na.rm=T)
xxx<-rbind(xxx,xxx)
t.test(xxx)
max(xxx,na.rm=T)
min(xxx,na.rm=T)
length(xxx)
sum(is.na(xxx))
apply(xxx,1,function(x) if(min(x,na.rm=T)==max(x,na.rm=T)){0})
max(xxx)
pValNA = apply(dTTd,1,function(x) 
  if(sum(is.na(x))==length(x)){1}
  else if(sum(!is.na(x[-length(x)]))<1&x[length(x)]>0){0}
  else if(sum(!is.na(x[-length(x)]))<1&x[length(x)]<=0){NA}
  else if(sum(!is.na(x[-length(x)]))==1){NA}
  else if(sum(!is.na(x[-length(x)]))>1&sd(x[-length(x)],na.rm=T)<(.Machine$double.xmin)){NA}
  else{t.test(x[-length(x)],na.rm=T)$p.value}
  )
hist(pValNA)
pValNAminusLog10 = -log10(pValNA+.Machine$double.xmin)
hist(pValNAminusLog10)
library(scales)
pValNAminusLog10=squish(pValNAminusLog10,c(0,5))
hist(pValNAminusLog10)
pVal<-pValNA
#pVal[pVal==0]=NA
#pVal[pVal==1]=NA
#pValBHna = p.adjust(pValNA,method = "BH")
pValBHna = p.adjust(pVal,method = "BH")
hist(pValBHna)
#pValBHna[is.na(pValBHna)]<-1
pValBHnaMinusLog10 = -log10(pValBHna+.Machine$double.xmin)
hist(pValBHnaMinusLog10)
logFCmedian = matrixStats::rowMedians(dTTd[,-ncol(dTTd)],na.rm=T)
logFCmedian[is.na(logFCmedian)]<-(pc[is.na(logFCmedian)]*-1)
hist(logFCmedian)
logFCmedianFC = 2^(logFCmedian+.Machine$double.xmin)
hist(logFCmedianFC)
logFCmedianFC=squish(logFCmedianFC,c(0.01,100))
hist(logFCmedianFC)
log2FCmedianFC=log2(logFCmedianFC)
hist(log2FCmedianFC)
#rownames(dTTd)
rowName<-strsplit(rownames(dTTd), ";")
rowName<-paste(sapply(rowName, "[", 3))
rowName<-strsplit(rowName, "-")
rowName<-paste(sapply(rowName, "[", 1))
#https://stackoverflow.com/a/44400007/1137129
#dataSellog2grpTtest[,1]
dTTd<-cbind(dTTd,dData)
ttest.results = data.frame(Uniprot=rowName,PValueMinusLog10=pValNAminusLog10,FoldChanglog2median=logFCmedianFC,CorrectedPValueBH=pValBHna,TtestPval=pValNA,dTTd,Log2MedianChange=logFCmedian,RowGeneUniProtScorePeps=rownames(dTTd))
#write.csv(ttest.results,file=paste0(inpF,hdr,sCol,eCol,"tTestBHgrp.csv"))
write_xlsx(ttest.results,paste0(inpF,hdr,sCol,eCol,"tTestBHvPlasma.xlsx"))
```

```{r t-test-TE, echo = FALSE}
sCol<-5
eCol<-7
pc=as.numeric(dataSellog2grpTtest[,1])
dData=dataSellog2grpTtest[,(sCol+1):(eCol+1)]
dTTd<-dataSellog2grpTtestNum[,sCol:eCol]+.Machine$double.xmin
dTTd<-cbind(dTTd,pc)
row.names(dTTd)<-row.names(data)
t.test(dTTd[1,],na.rm=T)$p.value
chkr<-1#nrow(dataSellog2grpTtest)
dTTd[chkr,]
sum(!is.na(dTTd[chkr,]))
dim(dTTd)
dim(dTTd)[1]
xxx<-c(-12.8099,-12.8091,NA)
#xxx<-c(-12.8099,NA,NA)
sd(xxx,na.rm=T)
xxx<-rbind(xxx,xxx)
t.test(xxx)
max(xxx,na.rm=T)
min(xxx,na.rm=T)
length(xxx)
sum(is.na(xxx))
apply(xxx,1,function(x) if(min(x,na.rm=T)==max(x,na.rm=T)){0})
max(xxx)
pValNA = apply(dTTd,1,function(x) 
  if(sum(is.na(x))==length(x)){1}
  else if(sum(!is.na(x[-length(x)]))<1&x[length(x)]>0){0}
  else if(sum(!is.na(x[-length(x)]))<1&x[length(x)]<=0){NA}
  else if(sum(!is.na(x[-length(x)]))==1){NA}
  else if(sum(!is.na(x[-length(x)]))>1&sd(x[-length(x)],na.rm=T)<(.Machine$double.xmin)){NA}
  else{t.test(x[-length(x)],na.rm=T)$p.value}
  )
hist(pValNA)
pValNAminusLog10 = -log10(pValNA+.Machine$double.xmin)
hist(pValNAminusLog10)
library(scales)
pValNAminusLog10=squish(pValNAminusLog10,c(0,5))
hist(pValNAminusLog10)
pVal<-pValNA
#pVal[pVal==0]=NA
#pVal[pVal==1]=NA
#pValBHna = p.adjust(pValNA,method = "BH")
pValBHna = p.adjust(pVal,method = "BH")
hist(pValBHna)
#pValBHna[is.na(pValBHna)]<-1
pValBHnaMinusLog10 = -log10(pValBHna+.Machine$double.xmin)
hist(pValBHnaMinusLog10)
logFCmedian = matrixStats::rowMedians(dTTd[,-ncol(dTTd)],na.rm=T)
logFCmedian[is.na(logFCmedian)]<-(pc[is.na(logFCmedian)]*-1)
hist(logFCmedian)
logFCmedianFC = 2^(logFCmedian+.Machine$double.xmin)
hist(logFCmedianFC)
logFCmedianFC=squish(logFCmedianFC,c(0.01,100))
hist(logFCmedianFC)
log2FCmedianFC=log2(logFCmedianFC)
hist(log2FCmedianFC)
#rownames(dTTd)
rowName<-strsplit(rownames(dTTd), ";")
rowName<-paste(sapply(rowName, "[", 3))
rowName<-strsplit(rowName, "-")
rowName<-paste(sapply(rowName, "[", 1))
#https://stackoverflow.com/a/44400007/1137129
#dataSellog2grpTtest[,1]
dTTd<-cbind(dTTd,dData)
ttest.results = data.frame(Uniprot=rowName,PValueMinusLog10=pValNAminusLog10,FoldChanglog2median=logFCmedianFC,CorrectedPValueBH=pValBHna,TtestPval=pValNA,dTTd,Log2MedianChange=logFCmedian,RowGeneUniProtScorePeps=rownames(dTTd))
#write.csv(ttest.results,file=paste0(inpF,hdr,sCol,eCol,"tTestBHgrp.csv"))
write_xlsx(ttest.results,paste0(inpF,hdr,sCol,eCol,"tTestBHvPlasma.xlsx"))
```

```{r t-test-SAT, echo = FALSE}
sCol<-12
eCol<-13
pc=as.numeric(dataSellog2grpTtest[,1])
dData=dataSellog2grpTtest[,(sCol+1):(eCol+1)]
dTTd<-dataSellog2grpTtestNum[,sCol:eCol]+.Machine$double.xmin
dTTd<-cbind(dTTd,pc)
row.names(dTTd)<-row.names(data)
t.test(dTTd[1,],na.rm=T)$p.value
chkr<-1#nrow(dataSellog2grpTtest)
dTTd[chkr,]
sum(!is.na(dTTd[chkr,]))
dim(dTTd)
dim(dTTd)[1]
xxx<-c(-12.8099,-12.8091,NA)
#xxx<-c(-12.8099,NA,NA)
sd(xxx,na.rm=T)
xxx<-rbind(xxx,xxx)
t.test(xxx)
max(xxx,na.rm=T)
min(xxx,na.rm=T)
length(xxx)
sum(is.na(xxx))
apply(xxx,1,function(x) if(min(x,na.rm=T)==max(x,na.rm=T)){0})
max(xxx)
pValNA = apply(dTTd,1,function(x) 
  if(sum(is.na(x))==length(x)){1}
  else if(sum(!is.na(x[-length(x)]))<1&x[length(x)]>0){0}
  else if(sum(!is.na(x[-length(x)]))<1&x[length(x)]<=0){NA}
  else if(sum(!is.na(x[-length(x)]))==1){NA}
  else if(sum(!is.na(x[-length(x)]))>1&sd(x[-length(x)],na.rm=T)<(.Machine$double.xmin)){NA}
  else{t.test(x[-length(x)],na.rm=T)$p.value}
  )
hist(pValNA)
pValNAminusLog10 = -log10(pValNA+.Machine$double.xmin)
hist(pValNAminusLog10)
library(scales)
pValNAminusLog10=squish(pValNAminusLog10,c(0,5))
hist(pValNAminusLog10)
pVal<-pValNA
#pVal[pVal==0]=NA
#pVal[pVal==1]=NA
#pValBHna = p.adjust(pValNA,method = "BH")
pValBHna = p.adjust(pVal,method = "BH")
hist(pValBHna)
#pValBHna[is.na(pValBHna)]<-1
pValBHnaMinusLog10 = -log10(pValBHna+.Machine$double.xmin)
hist(pValBHnaMinusLog10)
logFCmedian = matrixStats::rowMedians(dTTd[,-ncol(dTTd)],na.rm=T)
logFCmedian[is.na(logFCmedian)]<-(pc[is.na(logFCmedian)]*-1)
hist(logFCmedian)
logFCmedianFC = 2^(logFCmedian+.Machine$double.xmin)
hist(logFCmedianFC)
logFCmedianFC=squish(logFCmedianFC,c(0.01,100))
hist(logFCmedianFC)
log2FCmedianFC=log2(logFCmedianFC)
hist(log2FCmedianFC)
#rownames(dTTd)
rowName<-strsplit(rownames(dTTd), ";")
rowName<-paste(sapply(rowName, "[", 3))
rowName<-strsplit(rowName, "-")
rowName<-paste(sapply(rowName, "[", 1))
#https://stackoverflow.com/a/44400007/1137129
#dataSellog2grpTtest[,1]
dTTd<-cbind(dTTd,dData)
ttest.results = data.frame(Uniprot=rowName,PValueMinusLog10=pValNAminusLog10,FoldChanglog2median=logFCmedianFC,CorrectedPValueBH=pValBHna,TtestPval=pValNA,dTTd,Log2MedianChange=logFCmedian,RowGeneUniProtScorePeps=rownames(dTTd))
#write.csv(ttest.results,file=paste0(inpF,hdr,sCol,eCol,"tTestBHgrp.csv"))
write_xlsx(ttest.results,paste0(inpF,hdr,sCol,eCol,"tTestBHvPlasma.xlsx"))
```

```{r t-test-SAE, echo = FALSE}
sCol<-8
eCol<-11
pc=as.numeric(dataSellog2grpTtest[,1])
dData=dataSellog2grpTtest[,(sCol+1):(eCol+1)]
dTTd<-dataSellog2grpTtestNum[,sCol:eCol]+.Machine$double.xmin
dTTd<-cbind(dTTd,pc)
row.names(dTTd)<-row.names(data)
t.test(dTTd[1,],na.rm=T)$p.value
chkr<-1#nrow(dataSellog2grpTtest)
dTTd[chkr,]
sum(!is.na(dTTd[chkr,]))
dim(dTTd)
dim(dTTd)[1]
xxx<-c(-12.8099,-12.8091,NA)
#xxx<-c(-12.8099,NA,NA)
sd(xxx,na.rm=T)
xxx<-rbind(xxx,xxx)
t.test(xxx)
max(xxx,na.rm=T)
min(xxx,na.rm=T)
length(xxx)
sum(is.na(xxx))
apply(xxx,1,function(x) if(min(x,na.rm=T)==max(x,na.rm=T)){0})
max(xxx)
pValNA = apply(dTTd,1,function(x) 
  if(sum(is.na(x))==length(x)){1}
  else if(sum(!is.na(x[-length(x)]))<1&x[length(x)]>0){0}
  else if(sum(!is.na(x[-length(x)]))<1&x[length(x)]<=0){NA}
  else if(sum(!is.na(x[-length(x)]))==1){NA}
  else if(sum(!is.na(x[-length(x)]))>1&sd(x[-length(x)],na.rm=T)<(.Machine$double.xmin)){NA}
  else{t.test(x[-length(x)],na.rm=T)$p.value}
  )
hist(pValNA)
pValNAminusLog10 = -log10(pValNA+.Machine$double.xmin)
hist(pValNAminusLog10)
library(scales)
pValNAminusLog10=squish(pValNAminusLog10,c(0,5))
hist(pValNAminusLog10)
pVal<-pValNA
#pVal[pVal==0]=NA
#pVal[pVal==1]=NA
#pValBHna = p.adjust(pValNA,method = "BH")
pValBHna = p.adjust(pVal,method = "BH")
hist(pValBHna)
#pValBHna[is.na(pValBHna)]<-1
pValBHnaMinusLog10 = -log10(pValBHna+.Machine$double.xmin)
hist(pValBHnaMinusLog10)
logFCmedian = matrixStats::rowMedians(dTTd[,-ncol(dTTd)],na.rm=T)
logFCmedian[is.na(logFCmedian)]<-(pc[is.na(logFCmedian)]*-1)
hist(logFCmedian)
logFCmedianFC = 2^(logFCmedian+.Machine$double.xmin)
hist(logFCmedianFC)
logFCmedianFC=squish(logFCmedianFC,c(0.01,100))
hist(logFCmedianFC)
log2FCmedianFC=log2(logFCmedianFC)
hist(log2FCmedianFC)
#rownames(dTTd)
rowName<-strsplit(rownames(dTTd), ";")
rowName<-paste(sapply(rowName, "[", 3))
rowName<-strsplit(rowName, "-")
rowName<-paste(sapply(rowName, "[", 1))
#https://stackoverflow.com/a/44400007/1137129
#dataSellog2grpTtest[,1]
dTTd<-cbind(dTTd,dData)
ttest.results = data.frame(Uniprot=rowName,PValueMinusLog10=pValNAminusLog10,FoldChanglog2median=logFCmedianFC,CorrectedPValueBH=pValBHna,TtestPval=pValNA,dTTd,Log2MedianChange=logFCmedian,RowGeneUniProtScorePeps=rownames(dTTd))
#write.csv(ttest.results,file=paste0(inpF,hdr,sCol,eCol,"tTestBHgrp.csv"))
write_xlsx(ttest.results,paste0(inpF,hdr,sCol,eCol,"tTestBHvPlasma.xlsx"))
```

```{r t-test-APE, echo = FALSE}
sCol<-14
eCol<-17
pc=as.numeric(dataSellog2grpTtest[,1])
dData=dataSellog2grpTtest[,(sCol+1):(eCol+1)]
dTTd<-dataSellog2grpTtestNum[,sCol:eCol]+.Machine$double.xmin
dTTd<-cbind(dTTd,pc)
row.names(dTTd)<-row.names(data)
t.test(dTTd[1,],na.rm=T)$p.value
chkr<-1#nrow(dataSellog2grpTtest)
dTTd[chkr,]
sum(!is.na(dTTd[chkr,]))
dim(dTTd)
dim(dTTd)[1]
xxx<-c(-12.8099,-12.8091,NA)
#xxx<-c(-12.8099,NA,NA)
sd(xxx,na.rm=T)
xxx<-rbind(xxx,xxx)
t.test(xxx)
max(xxx,na.rm=T)
min(xxx,na.rm=T)
length(xxx)
sum(is.na(xxx))
apply(xxx,1,function(x) if(min(x,na.rm=T)==max(x,na.rm=T)){0})
max(xxx)
pValNA = apply(dTTd,1,function(x) 
  if(sum(is.na(x))==length(x)){1}
  else if(sum(!is.na(x[-length(x)]))<1&x[length(x)]>0){0}
  else if(sum(!is.na(x[-length(x)]))<1&x[length(x)]<=0){NA}
  else if(sum(!is.na(x[-length(x)]))==1){NA}
  else if(sum(!is.na(x[-length(x)]))>1&sd(x[-length(x)],na.rm=T)<(.Machine$double.xmin)){NA}
  else{t.test(x[-length(x)],na.rm=T)$p.value}
  )
hist(pValNA)
pValNAminusLog10 = -log10(pValNA+.Machine$double.xmin)
hist(pValNAminusLog10)
library(scales)
pValNAminusLog10=squish(pValNAminusLog10,c(0,5))
hist(pValNAminusLog10)
pVal<-pValNA
#pVal[pVal==0]=NA
#pVal[pVal==1]=NA
#pValBHna = p.adjust(pValNA,method = "BH")
pValBHna = p.adjust(pVal,method = "BH")
hist(pValBHna)
#pValBHna[is.na(pValBHna)]<-1
pValBHnaMinusLog10 = -log10(pValBHna+.Machine$double.xmin)
hist(pValBHnaMinusLog10)
logFCmedian = matrixStats::rowMedians(dTTd[,-ncol(dTTd)],na.rm=T)
logFCmedian[is.na(logFCmedian)]<-(pc[is.na(logFCmedian)]*-1)
hist(logFCmedian)
logFCmedianFC = 2^(logFCmedian+.Machine$double.xmin)
hist(logFCmedianFC)
logFCmedianFC=squish(logFCmedianFC,c(0.01,100))
hist(logFCmedianFC)
log2FCmedianFC=log2(logFCmedianFC)
hist(log2FCmedianFC)
#rownames(dTTd)
rowName<-strsplit(rownames(dTTd), ";")
rowName<-paste(sapply(rowName, "[", 3))
rowName<-strsplit(rowName, "-")
rowName<-paste(sapply(rowName, "[", 1))
#https://stackoverflow.com/a/44400007/1137129
#dataSellog2grpTtest[,1]
dTTd<-cbind(dTTd,dData)
ttest.results = data.frame(Uniprot=rowName,PValueMinusLog10=pValNAminusLog10,FoldChanglog2median=logFCmedianFC,CorrectedPValueBH=pValBHna,TtestPval=pValNA,dTTd,Log2MedianChange=logFCmedian,RowGeneUniProtScorePeps=rownames(dTTd))
#write.csv(ttest.results,file=paste0(inpF,hdr,sCol,eCol,"tTestBHgrp.csv"))
write_xlsx(ttest.results,paste0(inpF,hdr,sCol,eCol,"tTestBHvPlasma.xlsx"))
```

```{r t-test-APT, echo = FALSE}
sCol<-18
eCol<-22
pc=as.numeric(dataSellog2grpTtest[,1])
dData=dataSellog2grpTtest[,(sCol+1):(eCol+1)]
dTTd<-dataSellog2grpTtestNum[,sCol:eCol]+.Machine$double.xmin
dTTd<-cbind(dTTd,pc)
row.names(dTTd)<-row.names(data)
t.test(dTTd[1,],na.rm=T)$p.value
chkr<-1#nrow(dataSellog2grpTtest)
dTTd[chkr,]
sum(!is.na(dTTd[chkr,]))
dim(dTTd)
dim(dTTd)[1]
xxx<-c(-12.8099,-12.8091,NA)
#xxx<-c(-12.8099,NA,NA)
sd(xxx,na.rm=T)
xxx<-rbind(xxx,xxx)
t.test(xxx)
max(xxx,na.rm=T)
min(xxx,na.rm=T)
length(xxx)
sum(is.na(xxx))
apply(xxx,1,function(x) if(min(x,na.rm=T)==max(x,na.rm=T)){0})
max(xxx)
pValNA = apply(dTTd,1,function(x) 
  if(sum(is.na(x))==length(x)){1}
  else if(sum(!is.na(x[-length(x)]))<1&x[length(x)]>0){0}
  else if(sum(!is.na(x[-length(x)]))<1&x[length(x)]<=0){NA}
  else if(sum(!is.na(x[-length(x)]))==1){NA}
  else if(sum(!is.na(x[-length(x)]))>1&sd(x[-length(x)],na.rm=T)<(.Machine$double.xmin)){NA}
  else{t.test(x[-length(x)],na.rm=T)$p.value}
  )
hist(pValNA)
pValNAminusLog10 = -log10(pValNA+.Machine$double.xmin)
hist(pValNAminusLog10)
library(scales)
pValNAminusLog10=squish(pValNAminusLog10,c(0,5))
hist(pValNAminusLog10)
pVal<-pValNA
#pVal[pVal==0]=NA
#pVal[pVal==1]=NA
#pValBHna = p.adjust(pValNA,method = "BH")
pValBHna = p.adjust(pVal,method = "BH")
hist(pValBHna)
#pValBHna[is.na(pValBHna)]<-1
pValBHnaMinusLog10 = -log10(pValBHna+.Machine$double.xmin)
hist(pValBHnaMinusLog10)
logFCmedian = matrixStats::rowMedians(dTTd[,-ncol(dTTd)],na.rm=T)
logFCmedian[is.na(logFCmedian)]<-(pc[is.na(logFCmedian)]*-1)
hist(logFCmedian)
logFCmedianFC = 2^(logFCmedian+.Machine$double.xmin)
hist(logFCmedianFC)
logFCmedianFC=squish(logFCmedianFC,c(0.01,100))
hist(logFCmedianFC)
log2FCmedianFC=log2(logFCmedianFC)
hist(log2FCmedianFC)
#rownames(dTTd)
rowName<-strsplit(rownames(dTTd), ";")
rowName<-paste(sapply(rowName, "[", 3))
rowName<-strsplit(rowName, "-")
rowName<-paste(sapply(rowName, "[", 1))
#https://stackoverflow.com/a/44400007/1137129
#dataSellog2grpTtest[,1]
dTTd<-cbind(dTTd,dData)
ttest.results = data.frame(Uniprot=rowName,PValueMinusLog10=pValNAminusLog10,FoldChanglog2median=logFCmedianFC,CorrectedPValueBH=pValBHna,TtestPval=pValNA,dTTd,Log2MedianChange=logFCmedian,RowGeneUniProtScorePeps=rownames(dTTd))
#write.csv(ttest.results,file=paste0(inpF,hdr,sCol,eCol,"tTestBHgrp.csv"))
write_xlsx(ttest.results,paste0(inpF,hdr,sCol,eCol,"tTestBHvPlasma.xlsx"))
```

```{r w-test-AT/E, echo = FALSE}
#lc1<-data[,label[label[["Comparisons"]]=="1",1]]
#dplyr::select(data,unlist(label[(label$Comparisons=="1")&(!is.na(label$Comparisons)),1]))
dataSellog2grpTtest<-data[,unlist(label[(label$Comparisons=="1")&(!is.na(label$Comparisons)),1])]
dataSellog2grpTtest
dataSellog2grpTtest<-as.matrix(dataSellog2grpTtest[,c(1,2,6,7,3,4,5)])
dataSellog2grpTtest<-gsub("NaN", NA, dataSellog2grpTtest)
dataSellog2grpTtest<-gsub("NA", NA, dataSellog2grpTtest)
row.names(dataSellog2grpTtest)<-row.names(data)
#dataSellog2grpTtest<-dataSellog2grpTtest[rowSums(is.na(dataSellog2grpTtest)) != ncol(dataSellog2grpTtest), ]
dataSellog2grpTtest
sCol<-1
eCol<-7
mCol<-4
t.test(as.numeric(dataSellog2grpTtest[1,c(1:mCol)]),as.numeric(dataSellog2grpTtest[1,c((mCol+1):eCol)]),na.rm=T)$p.value
chkr<-1#nrow(dataSellog2grpTtest)
dataSellog2grpTtest[chkr,c(1:mCol)]
dataSellog2grpTtest[chkr,c((mCol+1):eCol)]
sum(!is.na(dataSellog2grpTtest[chkr,c(1:eCol)]))
dim(dataSellog2grpTtest)
dim(dataSellog2grpTtest)[1]
apply(dataSellog2grpTtest[chkr,], 1, function(x) if(sum(!is.na(x[c(1:mCol)]))<2&sum(!is.na(x[c((mCol+1):eCol)]))<2){1} #if(sum(!is.na(x[c(1:eCol)]))>2){1} #else{t.test(as.numeric(x[c(1:mCol)]),as.numeric(x[c((mCol+1):eCol)]),na.rm=T,var.equal=T)$p.value}
      )
pValNA = apply(
  dataSellog2grpTtest, 1, function(x)
    if(sum(!is.na(x[c(1:eCol)]))<2){1}
    else if(sum(!is.na(x[c(1:mCol)]))<2&sum(!is.na(x[c((mCol+1):eCol)]))<2){1}
    else if(sum(!is.na(x[c(1:mCol)]))>=2&sum(!is.na(x[c((mCol+1):eCol)]))==1){1}
    else if(sum(!is.na(x[c(1:mCol)]))==1&sum(!is.na(x[c((mCol+1):eCol)]))>=2){1}
    else if(sum(!is.na(x[c(1:mCol)]))>1&sum(!is.na(x[c((mCol+1):eCol)]))<1){0}
    else if(sum(!is.na(x[c(1:mCol)]))<1&sum(!is.na(x[c((mCol+1):eCol)]))>1){0}
    else{t.test(as.numeric(x[c(1:mCol)]),as.numeric(x[c((mCol+1):eCol)]),na.rm=T,var.equal=F)$p.value})
hist(pValNA)
pValNAminusLog10 = -log10(pValNA+.Machine$double.xmin)
hist(pValNAminusLog10)
library(scales)
pValNAminusLog10=squish(pValNAminusLog10,c(0,5))
hist(pValNAminusLog10)
pValBHna = p.adjust(pValNA,method = "BH")
hist(pValBHna)
pValBHnaMinusLog10 = -log10(pValBHna+.Machine$double.xmin)
hist(pValBHnaMinusLog10)
dataSellog2grpTtestNum<-apply(dataSellog2grpTtest, 2,as.numeric)
logFCmedianGrp1 = matrixStats::rowMedians(dataSellog2grpTtestNum[,c(1:mCol)],na.rm=T)
logFCmedianGrp2 = matrixStats::rowMedians(dataSellog2grpTtestNum[,c((mCol+1):eCol)],na.rm=T)
logFCmedianGrp1[is.nan(logFCmedianGrp1)]=0
logFCmedianGrp2[is.nan(logFCmedianGrp2)]=0
logFCmedian = logFCmedianGrp1-logFCmedianGrp2
hist(logFCmedian)
logFCmedianFC = 2^(logFCmedian+.Machine$double.xmin)
hist(logFCmedianFC)
logFCmedianFC=squish(logFCmedianFC,c(0.01,100))
hist(logFCmedianFC)
log2FCmedianFC=log2(logFCmedianFC)
hist(log2FCmedianFC)
rownames(dataSellog2grpTtest)
rowName<-strsplit(rownames(dataSellog2grpTtest), ";")
rowName<-paste(sapply(rowName, "[", 3))
rowName<-strsplit(rowName, "-")
rowName<-paste(sapply(rowName, "[", 1))
#https://stackoverflow.com/a/44400007/1137129
ttest.results = data.frame(Uniprot=rowName,PValueMinusLog10=pValNAminusLog10,FoldChanglog2median=logFCmedianFC,CorrectedPValueBH=pValBHna,TtestPval=pValNA,dataSellog2grpTtest,Log2MedianChange=logFCmedian)
write.csv(ttest.results,file=paste0(inpF,hdr,sCol,eCol,"tTestBH1way.csv"))
```


```{r volcanoPlot}
library(ggplot2)
dsub=subset(ttest.results,ttest.results$TtestPval<0.05&abs(ttest.results$Log2MedianChange)>0.58)
row.names(dsub) <- dsub[["Uniprot"]]
g = ggplot(ttest.results,aes(Log2MedianChange,PValueMinusLog10))+geom_point(aes(color=CorrectedPValueBH),size=0.15) + theme_bw(base_size=10) +geom_text(data=dsub,aes(label=row.names(dsub)), vjust=0.5, size=1.5) + xlab(paste("Log2 Fold Change",sCol,eCol))  + ylab("-Log10 P-value") + ggtitle("Differentially Expressed Protein Groups") + scale_size_area()+scale_color_gradient(low="#FF9933", high="#99CC66") 
plot(g)#+ geom_jitter())
#install.packages("svglite")
library(svglite)
ggsave(file=paste0(inpF,hdr,sCol,eCol,"volcanoPlotgrp.svg"),plot=g)#,  width=6, height=6)
```

```{r t-test, echo = FALSE}
sCol<-7:9
eCol<-13:15
dataSellog2grpTtest<-dataSellog2[,c(sCol,eCol)]
mCol<-ncol(dataSellog2grpTtest)/2
#pValNA = t.test(as.numeric(dataSellog2grpTtest[c(1:mCol)]),as.numeric(dataSellog2grpTtest[c((mCol+1):6)]),na.rm=T)$p.value
pValNA = apply(
  dataSellog2grpTtest, 1, function(x)
    if(sum(!is.na(x[c(1:mCol)]))<2&sum(!is.na(x[c((mCol+1):6)]))<2){1}
    else if(sum(!is.na(x[c(1:mCol)]))>=2&sum(!is.na(x[c((mCol+1):6)]))==1){1}
    else if(sum(!is.na(x[c(1:mCol)]))==1&sum(!is.na(x[c((mCol+1):6)]))>=2){1}
    else if(sum(!is.na(x[c(1:mCol)]))>1&sum(!is.na(x[c((mCol+1):6)]))<1){0}
    else if(sum(!is.na(x[c(1:mCol)]))<1&sum(!is.na(x[c((mCol+1):6)]))>1){0}
    else{t.test(as.numeric(x[c(1:mCol)]),as.numeric(x[c((mCol+1):6)]),na.rm=T,var.equal=T)$p.value})
hist(pValNA)
pValNAminusLog10 = -log10(pValNA+.Machine$double.xmin)
hist(pValNAminusLog10)
library(scales)
pValNAminusLog10=squish(pValNAminusLog10,c(0,5))
hist(pValNAminusLog10)
pValBHna = p.adjust(pValNA,method = "BH")
hist(pValBHna)
pValBHnaMinusLog10 = -log10(pValBHna+.Machine$double.xmin)
hist(pValBHnaMinusLog10)
logFCmedianGrp1 = matrixStats::rowMedians(dataSellog2grpTtest[,c(1:mCol)],na.rm=T)
logFCmedianGrp2 = matrixStats::rowMedians(dataSellog2grpTtest[,c((mCol+1):6)],na.rm=T)
logFCmedianGrp1[is.nan(logFCmedianGrp1)]=0
logFCmedianGrp2[is.nan(logFCmedianGrp2)]=0
logFCmedian = logFCmedianGrp1-logFCmedianGrp2
hist(logFCmedian)
logFCmedianFC = 2^(logFCmedian+.Machine$double.xmin)
hist(logFCmedianFC)
logFCmedianFC=squish(logFCmedianFC,c(0.01,100))
hist(logFCmedianFC)
log2FCmedianFC=log2(logFCmedianFC)
hist(log2FCmedianFC)
rownames(dataSellog2grpTtest)
rowName<-strsplit(rownames(dataSellog2grpTtest), ";")
rowName<-paste(sapply(rowName, "[", 1))
rowName<-strsplit(rowName, "-")
rowName<-paste(sapply(rowName, "[", 1))
#https://stackoverflow.com/a/44400007/1137129
  ttest.results = data.frame(Uniprot=rowName,PValueMinusLog10=pValNAminusLog10,FoldChanglog2median=logFCmedianFC,CorrectedPValueBH=pValBHna,TtestPval=pValNA,dataSellog2grpTtest,Log2MedianChange=logFCmedian)
write.csv(ttest.results,file=paste0(inpF,hdr,paste(sCol,eCol,collapse=" "),"tTestBHgrp.csv"))
```

```{r volcanoPlot}
library(ggplot2)
dsub=subset(ttest.results,ttest.results$TtestPval<0.05&abs(ttest.results$Log2MedianChange)>0.58)
row.names(dsub) <- dsub[["Uniprot"]]
g = ggplot(ttest.results,aes(Log2MedianChange,PValueMinusLog10))+geom_point(aes(color=CorrectedPValueBH),size=0.15) + theme_bw(base_size=10) +geom_text(data=dsub,aes(label=row.names(dsub)), vjust=0.5, size=1.5) + xlab(paste("Log2 Fold Change",sCol,eCol))  + ylab("-Log10 P-value") + ggtitle("Differentially Expressed Protein Groups") + scale_size_area()+scale_color_gradient(low="#FF9933", high="#99CC66") 
plot(g)#+ geom_jitter())
#install.packages("svglite")
library(svglite)
ggsave(file=paste0(inpF,hdr,paste(sCol,eCol,collapse=" "),"volcanoPlotgrp.svg"),plot=g)#,  width=6, height=6)
```

```{r t-test, echo = FALSE}
sCol<-1:3
eCol<-7:9
dataSellog2grpTtest<-dataSellog2[,c(sCol,eCol)]
mCol<-ncol(dataSellog2grpTtest)/2
#pValNA = t.test(as.numeric(dataSellog2grpTtest[c(1:mCol)]),as.numeric(dataSellog2grpTtest[c((mCol+1):6)]),na.rm=T)$p.value
pValNA = apply(
  dataSellog2grpTtest, 1, function(x)
    if(sum(!is.na(x[c(1:mCol)]))<2&sum(!is.na(x[c((mCol+1):6)]))<2){1}
    else if(sum(!is.na(x[c(1:mCol)]))>=2&sum(!is.na(x[c((mCol+1):6)]))==1){1}
    else if(sum(!is.na(x[c(1:mCol)]))==1&sum(!is.na(x[c((mCol+1):6)]))>=2){1}
    else if(sum(!is.na(x[c(1:mCol)]))>1&sum(!is.na(x[c((mCol+1):6)]))<1){0}
    else if(sum(!is.na(x[c(1:mCol)]))<1&sum(!is.na(x[c((mCol+1):6)]))>1){0}
    else{t.test(as.numeric(x[c(1:mCol)]),as.numeric(x[c((mCol+1):6)]),na.rm=T,var.equal=T)$p.value})
hist(pValNA)
pValNAminusLog10 = -log10(pValNA+.Machine$double.xmin)
hist(pValNAminusLog10)
library(scales)
pValNAminusLog10=squish(pValNAminusLog10,c(0,5))
hist(pValNAminusLog10)
pValBHna = p.adjust(pValNA,method = "BH")
hist(pValBHna)
pValBHnaMinusLog10 = -log10(pValBHna+.Machine$double.xmin)
hist(pValBHnaMinusLog10)
logFCmedianGrp1 = matrixStats::rowMedians(dataSellog2grpTtest[,c(1:mCol)],na.rm=T)
logFCmedianGrp2 = matrixStats::rowMedians(dataSellog2grpTtest[,c((mCol+1):6)],na.rm=T)
logFCmedianGrp1[is.nan(logFCmedianGrp1)]=0
logFCmedianGrp2[is.nan(logFCmedianGrp2)]=0
logFCmedian = logFCmedianGrp1-logFCmedianGrp2
hist(logFCmedian)
logFCmedianFC = 2^(logFCmedian+.Machine$double.xmin)
hist(logFCmedianFC)
logFCmedianFC=squish(logFCmedianFC,c(0.01,100))
hist(logFCmedianFC)
log2FCmedianFC=log2(logFCmedianFC)
hist(log2FCmedianFC)
rownames(dataSellog2grpTtest)
rowName<-strsplit(rownames(dataSellog2grpTtest), ";")
rowName<-paste(sapply(rowName, "[", 1))
rowName<-strsplit(rowName, "-")
rowName<-paste(sapply(rowName, "[", 1))
#https://stackoverflow.com/a/44400007/1137129
  ttest.results = data.frame(Uniprot=rowName,PValueMinusLog10=pValNAminusLog10,FoldChanglog2median=logFCmedianFC,CorrectedPValueBH=pValBHna,TtestPval=pValNA,dataSellog2grpTtest,Log2MedianChange=logFCmedian)
write.csv(ttest.results,file=paste0(inpF,hdr,paste(sCol,eCol,collapse=" "),"tTestBHgrp.csv"))
```

```{r volcanoPlot}
library(ggplot2)
dsub=subset(ttest.results,ttest.results$TtestPval<0.05&abs(ttest.results$Log2MedianChange)>0.58)
protNum<-1:nrow(dsub)
row.names(dsub) <- paste(dsub[["Uniprot"]],protNum,sep="_")
g = ggplot(ttest.results,aes(Log2MedianChange,PValueMinusLog10))+geom_point(aes(color=CorrectedPValueBH),size=0.15) + theme_bw(base_size=10) +geom_text(data=dsub,aes(label=row.names(dsub)), vjust=0.5, size=1.5) + xlab(paste("Log2 Fold Change",sCol,eCol))  + ylab("-Log10 P-value") + ggtitle("Differentially Expressed Protein Groups") + scale_size_area()+scale_color_gradient(low="#FF9933", high="#99CC66") 
plot(g)#+ geom_jitter())
#install.packages("svglite")
library(svglite)
ggsave(file=paste0(inpF,hdr,paste(sCol,eCol,collapse=" "),"volcanoPlotgrp.svg"),plot=g)#,  width=6, height=6)
```

```{r scale}
dataSellog2scale<-scale(dataSellog2)
for(coln in 1:dim(dataSellog2scale)[2]){
  hist(dataSellog2scale[,coln])
  print(var(dataSellog2scale[!is.na(dataSellog2scale[,coln]),coln]))
  print(mean(dataSellog2scale[!is.na(dataSellog2scale[,coln]),coln]))
}
```

```{r compare}
plot(dataSellog2scale,dataSellog2)
coln=1
power.t.test(n = dim(dataSellog2scale)[2]/2, delta = 1, sd = var(dataSellog2scale[!is.na(dataSellog2scale[,coln]),coln]),sig.level=0.05,power=NULL,type="two.sample",alternative="two.sided",strict = FALSE)
```

```{r FPR}
#http://fpr-calc.ucl.ac.uk/
#https://www.tandfonline.com/doi/full/10.1080/00031305.2018.1529622
#https://www.tandfonline.com/doi/suppl/10.1080/00031305.2018.1529622/suppl_file/utas_a_1529622_sm1508.zip
for(coln in 1:dim(dataSellog2)[2]){
  hist(dataSellog2[,coln])
  print(sd(dataSellog2[!is.na(dataSellog2[,coln]),coln]))
  print(mean(dataSellog2[!is.na(dataSellog2[,coln]),coln]))
}
```


```{r groups}
dataSellog2grp<-dataSellog2[,grep("M.L.",colnames(dataSellog2))]
dataSellog2grp<-dataSellog2grp[,-1]
summary(dataSellog2grp)
plot(dataSellog2grp)
```

```{r t-test, echo = FALSE}
dataSellog2grpTtest<-dataSellog2grp
pValNA = apply(dataSellog2grpTtest, 1, function(x) if(sum(!is.na(x[c(1:6)]))<2){NaN} else{t.test(as.numeric(x[c(1:6)]),na.rm=T)$p.value})
hist(pValNA)
pVal1 = apply(dataSellog2grpTtest, 1, function(x) if(sum(!is.na(x[c(1:6)]))<2){1} else{t.test(as.numeric(x[c(1:6)]),na.rm=T)$p.value})
hist(pVal1)
pValBHna = p.adjust(pValNA,method = "BH")
hist(pValBHna)
pValBH1 = p.adjust(pVal1,method = "BH")
hist(pValBH1)
plot(pValBH1-pValBHna,pVal1-pValNA)
logFC = rowMeans(dataSellog2grpTtest[,c(1:6)])#-rowMeans(yyt[,c(6,5,4,3,2,1)])
hist(logFC)
plot(logFC,-log10(pVal1))
plot(logFC,-log10(pValNA))
plot(logFC,-log10(pValBHna),col="orange")

logFCmedian = matrixStats::rowMedians(dataSellog2grpTtest[,c(1:6)])#-rowMeans(yyt[,c(6,5,4,3,2,1)])
hist(logFCmedian)

ttest.results = data.frame(logFC=logFC,logFCmedian=logFCmedian,P.Value = pValNA, adj.pval.BH = pValBHna) 
#ttest.results$PSMcount = psm.count.table[ttest.results$gene,"count"]
#ttest.results = ttest.results[with(ttest.results, order(P.Value)), ]
#head(ttest.results)
write.csv(ttest.results,file=paste0(inpF,hdr,"tTestBHgrp.csv"))
```

```{r volcanoPlot}
library(ggplot2)
ttest.results<-ttest.results7
dsub=subset(ttest.results,ttest.results$P.Value<0.05&abs(ttest.results$logFC)>0.58)
rn<-strsplit(rownames(dsub), ';')
row.names(dsub) <- sapply(rn, "[", 1)#rn[[1]]
g = ggplot(ttest.results,aes(logFC,-log10(P.Value)))+geom_point(aes(color=adj.pval.BH),size=0.15) + theme_bw(base_size=10) +geom_text(data=dsub,aes(label=row.names(dsub)), vjust=0.5, size=1.5) + xlab("Log2 Fold Change (NRF2/sNRF2NT)")  + ylab("-Log10 P-value") + ggtitle("Differentially Expressed Protein groups") + scale_size_area()+scale_color_gradient(low="#FF9933", high="#99CC66")
plot(g)
#install.packages("svglite")
library(svglite)
ggsave(file=paste0(inpF,hdr,"volcanoPlotgrp7.svg"),plot=g)#,  width=6, height=6)
```

```{r t-test, echo = FALSE}
dataSellog2grpTtest<-dataSellog2grp11

pValNA = apply(dataSellog2grpTtest, 1, function(x) if(sum(!is.na(x[c(1:6)]))<2){NaN} else{t.test(as.numeric(x[c(1:6)]),na.rm=T)$p.value})
hist(pValNA)
pVal1 = apply(dataSellog2grpTtest, 1, function(x) if(sum(!is.na(x[c(1:6)]))<2){1} else{t.test(as.numeric(x[c(1:6)]),na.rm=T)$p.value})
hist(pVal1)
pValBHna = p.adjust(pValNA,method = "BH")
hist(pValBHna)
pValBH1 = p.adjust(pVal1,method = "BH")
hist(pValBH1)

plot(pValBH1-pValBHna,pVal1-pValNA)

logFC = rowMeans(dataSellog2grpTtest[,c(1:6)])#-rowMeans(yyt[,c(6,5,4,3,2,1)])
hist(logFC)
plot(logFC,-log10(pVal1))
plot(logFC,-log10(pValNA))
plot(logFC,-log10(pValBHna),col="orange")

logFCmedian = matrixStats::rowMedians(dataSellog2grpTtest[,c(1:6)])#-rowMeans(yyt[,c(6,5,4,3,2,1)])
hist(logFCmedian)

ttest.results11 = data.frame(logFC=logFC,logFCmedian=logFCmedian,P.Value = pValNA, adj.pval.BH = pValBHna) 
#ttest.results$PSMcount = psm.count.table[ttest.results$gene,"count"]
#ttest.results = ttest.results[with(ttest.results, order(P.Value)), ]
#head(ttest.results)
write.csv(ttest.results11,file=paste0(inpF,hdr,"tTestBHgrp11.csv"))
```

```{r volcanoPlot}
ttest.results<-ttest.results11
dsub=subset(ttest.results,ttest.results$P.Value<0.05&abs(ttest.results$logFC)>0.58)
rn<-strsplit(rownames(dsub), ';')
row.names(dsub) <- sapply(rn, "[", 1)#rn[[1]]
g = ggplot(ttest.results,aes(logFC,-log10(P.Value)))+geom_point(aes(color=adj.pval.BH),size=0.15) + theme_bw(base_size=10) +geom_text(data=dsub,aes(label=row.names(dsub)), vjust=0.5, size=1.5) + xlab("Log2 Fold Change (p62/sp62NT)")  + ylab("-Log10 P-value") + ggtitle("Differentially Expressed Protein groups") + scale_size_area()+scale_color_gradient(low="#FF9933", high="#99CC66")
plot(g)
#install.packages("svglite")
ggsave(file=paste0(inpF,hdr,"volcanoPlotgrp11.svg"),plot=g)#,  width=6, height=6)
```


```{r remNA}
#yyt[is.na(yyt)]<-1 #for equal ratio
dataSellog2remNA<-dataSellog2
dataSellog2remNA[is.na(dataSellog2remNA)]<-0
#y<-yyt[,-(which(colSums(yyt) == 0))] 
dataSellog2remNA<-dataSellog2remNA[-(which(rowSums(dataSellog2remNA) == 0)),] 
summary(dataSellog2remNA)
#yyt<-yyt[,rownames(label)]
#colnames(dataSellog2remNA)
#yyt[,9]=as.factor(yyt[,9])
```

```{r heatmap}
#install.packages('pheatmap')
library(pheatmap)
#?pheatmap
svgPHC<-pheatmap(yyt,scale="row",clustering_distance_rows = "correlation",clustering_distance_cols = "correlation",fontsize_row=6,annotation_col = label,show_rownames=F)
#ggsave(file=paste0(inpF,"corrcoefED.svg"), plot=svgPHC, width=6, height=6)
plot(svgPHC)
```


```{r scale}
#install.packages('quantable')
library(quantable)
y=robustscale(yyt)
y$data[is.na(y$data)]<-0
y$data<-y$data[-(which(rowSums(y$data) == 0)),] 
summary(y$data)
#names(y$data)=sub("X","",names(y$data))
pheatmap(y$data,scale="row",clustering_distance_rows = "manhattan",clustering_distance_cols = "manhattan",fontsize_row=6,annotation_col = label,show_rownames=F)
```

```{r PCA}
library(ggfortify)
#log.yyt=log(yyt[,1:8]+1)
#yyt.pca=prcomp(log.yyt,center=TRUE,scale.=TRUE) 
yyt.pca=prcomp(t(yyt),center=TRUE,scale.=TRUE) 
autoplot(yyt.pca,data=t(yyt),colour=as.numeric(label$Location))
autoplot(yyt.pca,data=t(yyt),colour=as.numeric(label$Treatment))
#biplot(yyt.pca)
```


```{r norm, echo = FALSE}
hdr="LFQ.intensity."
dataNorm=log2(dataClean[,grep(hdr, names(dataClean))])
summary(dataNorm)
hist(as.matrix(dataNorm))
```

```{r select, echo = FALSE}
dataNormFilter<-dataNorm
dataNormFilter[dataNormFilter==-Inf]=NA
colnames(dataNormFilter)<-sub(hdr,"",colnames(dataNormFilter))
summary(dataNormFilter)
selThr<-4
dataNormFilter$INRTI = apply(dataNormFilter,1,function(x) sum(is.na(x[1:5])))
dataNormFilter$IRTI = apply(dataNormFilter,1,function(x) sum(is.na(x[6:10])))
dataNormFilter$HCTI = apply(dataNormFilter,1,function(x) sum(is.na(x[11:15])))
dataNormFilter$INRSI = apply(dataNormFilter,1,function(x) sum(is.na(x[16:20])))
dataNormFilter$IRSI = apply(dataNormFilter,1,function(x) sum(is.na(x[21:25])))
dataNormFilter$HCSI = apply(dataNormFilter,1,function(x) sum(is.na(x[26:30])))

dataNormFilter.SelectINRTIIR = dataNormFilter[(dataNormFilter$INRTI < selThr & dataNormFilter$IRTI  < selThr )|(dataNormFilter$IRTI < selThr & dataNormFilter$INRTI  < selThr ),1:10]
summary(dataNormFilter.SelectINRTIIR)
dataNormFilter.SelectINRTIIR
write.csv(dataNormFilter.SelectINRTIIR,file=paste0(inpF,hdr,selThr,"dataNormFilter.INRIR.TI.csv"))

dataNormFilter.SelectINRTIHC = dataNormFilter[(dataNormFilter$INRTI < selThr & dataNormFilter$HCTI  < selThr )|(dataNormFilter$HCTI < selThr & dataNormFilter$INRTI  < selThr ),c(1:5,11:15)]
summary(dataNormFilter.SelectINRTIHC)
dataNormFilter.SelectINRTIHC
write.csv(dataNormFilter.SelectINRTIHC,file=paste0(inpF,hdr,selThr,"dataNormFilter.INRHC.TI.csv"))

dataNormFilter.SelectIRTIHC = dataNormFilter[(dataNormFilter$IRTI < selThr & dataNormFilter$HCTI  < selThr )|(dataNormFilter$HCTI < selThr & dataNormFilter$IRTI  < selThr ),6:15]
summary(dataNormFilter.SelectIRTIHC)
dataNormFilter.SelectIRTIHC
write.csv(dataNormFilter.SelectIRTIHC,file=paste0(inpF,hdr,selThr,"dataNormFilter.IRHC.TI.csv"))

dataNormFilter.SelectINRSIIR = dataNormFilter[(dataNormFilter$INRSI < selThr & dataNormFilter$IRSI  < selThr )|(dataNormFilter$IRSI < selThr & dataNormFilter$INRSI  < selThr ),16:25]
summary(dataNormFilter.SelectINRSIIR)
dataNormFilter.SelectINRSIIR
write.csv(dataNormFilter.SelectINRSIIR,file=paste0(inpF,hdr,selThr,"dataNormFilter.INRIR.SI.csv"))

dataNormFilter.SelectINRSIHC = dataNormFilter[(dataNormFilter$INRSI < selThr & dataNormFilter$HCSI  < selThr )|(dataNormFilter$HCSI < selThr & dataNormFilter$INRSI  < selThr ),c(16:20,26:30)]
summary(dataNormFilter.SelectINRSIHC)
dataNormFilter.SelectINRSIHC
write.csv(dataNormFilter.SelectINRSIHC,file=paste0(inpF,hdr,selThr,"dataNormFilter.INRHC.SI.csv"))

dataNormFilter.SelectIRSIHC = dataNormFilter[(dataNormFilter$IRSI < selThr & dataNormFilter$HCSI  < selThr )|(dataNormFilter$HCSI < selThr & dataNormFilter$IRSI  < selThr ),21:30]
summary(dataNormFilter.SelectIRSIHC)
dataNormFilter.SelectIRSIHC
write.csv(dataNormFilter.SelectIRSIHC,file=paste0(inpF,hdr,selThr,"dataNormFilter.IRHC.SI.csv"))
```

```{r ROTS-dataNormFilter.SelectIRSIHC, echo = FALSE}
#BiocManager::install("ROTS")#, version = "3.8")
dataNormImpCom<-dataNormFilter.SelectIRSIHC#[is.na(dataNormImpCom)]=5
summary(dataNormImpCom)
factors<-c(1,1,1,1,1,2,2,2,2,2)
library(ROTS)
results = ROTS(data = dataNormImpCom, groups = factors , B = 250 , K = 250 , seed = 42)
write.csv(summary(results, fdr = 1),file=paste0(inpF,hdr,selThr,"dataNormFilter.SelectIRSIHC.rots.csv"))
names(results) 
summary(results, fdr = 0.05)
plot(results, fdr = 0.2, type = "pca")
plot(results, type = "volcano",fdr = 0.05)
plot(results, fdr = 0.2, type = "heatmap")#,na.rm=T)#,col=rainbow(4))
```

```{r ROTS-dataNormFilter.SelectINRSIHC, echo = FALSE}
#BiocManager::install("ROTS")#, version = "3.8")
dataNormImpCom<-dataNormFilter.SelectINRSIHC#[is.na(dataNormImpCom)]=5
summary(dataNormImpCom)
factors<-c(1,1,1,1,1,2,2,2,2,2)
library(ROTS)
results = ROTS(data = dataNormImpCom, groups = factors , B = 250 , K = 250 , seed = 42)
write.csv(summary(results, fdr = 1),file=paste0(inpF,hdr,selThr,"dataNormFilter.SelectINRSIHC.rots.csv"))
names(results) 
summary(results, fdr = 0.05)
plot(results, fdr = 0.2, type = "pca")
plot(results, type = "volcano",fdr = 0.05)
plot(results, fdr = 0.2, type = "heatmap")#,na.rm=T)#,col=rainbow(4))
```

```{r ROTS-dataNormFilter.SelectINRSIIR, echo = FALSE}
#BiocManager::install("ROTS")#, version = "3.8")
dataNormImpCom<-dataNormFilter.SelectINRSIIR#[is.na(dataNormImpCom)]=5
summary(dataNormImpCom)
factors<-c(1,1,1,1,1,2,2,2,2,2)
library(ROTS)
results = ROTS(data = dataNormImpCom, groups = factors , B = 250 , K = 250 , seed = 42)
write.csv(summary(results, fdr = 1),file=paste0(inpF,hdr,selThr,"dataNormFilter.SelectINRSIIR.rots.csv"))
names(results) 
summary(results, fdr = 0.05)
plot(results, fdr = 0.2, type = "pca")
plot(results, type = "volcano",fdr = 0.05)
plot(results, fdr = 0.2, type = "heatmap")#,na.rm=T)#,col=rainbow(4))
```


```{r ROTS-dataNormFilter.SelectIRTIHC, echo = FALSE}
#BiocManager::install("ROTS")#, version = "3.8")
dataNormImpCom<-dataNormFilter.SelectIRTIHC#[is.na(dataNormImpCom)]=5
summary(dataNormImpCom)
factors<-c(1,1,1,1,1,2,2,2,2,2)
library(ROTS)
results = ROTS(data = dataNormImpCom, groups = factors , B = 250 , K = 250 , seed = 42)
write.csv(summary(results, fdr = 1),file=paste0(inpF,hdr,selThr,"dataNormFilter.SelectIRTIHC.rots.csv"))
names(results) 
summary(results, fdr = 0.05)
plot(results, fdr = 0.2, type = "pca")
plot(results, type = "volcano",fdr = 0.05)
plot(results, fdr = 0.2, type = "heatmap")#,na.rm=T)#,col=rainbow(4))
```

```{r ROTS-dataNormFilter.SelectINRTIHC, echo = FALSE}
#BiocManager::install("ROTS")#, version = "3.8")
dataNormImpCom<-dataNormFilter.SelectINRTIHC#[is.na(dataNormImpCom)]=5
summary(dataNormImpCom)
factors<-c(1,1,1,1,1,2,2,2,2,2)
library(ROTS)
results = ROTS(data = dataNormImpCom, groups = factors , B = 250 , K = 250 , seed = 42)
write.csv(summary(results, fdr = 1),file=paste0(inpF,hdr,selThr,"dataNormFilter.SelectINRTIHC.rots.csv"))
names(results) 
summary(results, fdr = 0.05)
plot(results, fdr = 0.2, type = "pca")
plot(results, type = "volcano",fdr = 0.05)
plot(results, fdr = 0.2, type = "heatmap")#,na.rm=T)#,col=rainbow(4))
```

```{r ROTS-dataNormFilter.SelectINRTIIR, echo = FALSE}
#BiocManager::install("ROTS")#, version = "3.8")
dataNormImpCom<-dataNormFilter.SelectINRTIIR#[is.na(dataNormImpCom)]=5
summary(dataNormImpCom)
factors<-c(1,1,1,1,1,2,2,2,2,2)
library(ROTS)
results = ROTS(data = dataNormImpCom, groups = factors , B = 250 , K = 250 , seed = 42)
write.csv(summary(results, fdr = 1),file=paste0(inpF,hdr,selThr,"dataNormFilter.SelectINRTIIR.rots.csv"))
names(results) 
summary(results, fdr = 0.05)
plot(results, fdr = 0.2, type = "pca")
plot(results, type = "volcano",fdr = 0.05)
plot(results, fdr = 0.2, type = "heatmap")#,na.rm=T)#,col=rainbow(4))
```



```{r select-impute, echo = FALSE}
dataNormFilter<-dataNorm
dataNormFilter[dataNormFilter==-Inf]=NA
colnames(dataNormFilter)<-sub(hdr,"",colnames(dataNormFilter))
summary(dataNormFilter)
selThr<-3
dataNormFilter$INRTI = apply(dataNormFilter,1,function(x) sum(is.na(x[1:5])))
dataNormFilter$IRTI = apply(dataNormFilter,1,function(x) sum(is.na(x[6:10])))
dataNormFilter$HCTI = apply(dataNormFilter,1,function(x) sum(is.na(x[11:15])))
dataNormFilter$INRSI = apply(dataNormFilter,1,function(x) sum(is.na(x[16:20])))
dataNormFilter$IRSI = apply(dataNormFilter,1,function(x) sum(is.na(x[21:25])))
dataNormFilter$HCSI = apply(dataNormFilter,1,function(x) sum(is.na(x[26:30])))

set.seed(1)
dataNormFilter[is.na(dataNormFilter)]<-rnorm(sum(dataNorm==-Inf),mean=mean(dataNorm[dataNorm!=-Inf])-10,sd=sd(dataNorm[dataNorm!=-Inf])/10)
summary(dataNormFilter)
hist(as.matrix(dataNormFilter))

dataNormFilter.SelectINRTIIR = dataNormFilter[(dataNormFilter$INRTI < selThr & dataNormFilter$IRTI == 5)|(dataNormFilter$IRTI < selThr & dataNormFilter$INRTI  == 5),1:10]
summary(dataNormFilter.SelectINRTIIR)
dataNormFilter.SelectINRTIIR
write.csv(dataNormFilter.SelectINRTIIR,file=paste0(inpF,hdr,selThr,"dataNormFilter.INRIR.TI.csv"))

dataNormFilter.SelectINRTIHC = dataNormFilter[(dataNormFilter$INRTI < selThr & dataNormFilter$HCTI == 5)|(dataNormFilter$HCTI < selThr & dataNormFilter$INRTI  == 5),c(1:5,11:15)]
summary(dataNormFilter.SelectINRTIHC)
dataNormFilter.SelectINRTIHC
write.csv(dataNormFilter.SelectINRTIHC,file=paste0(inpF,hdr,selThr,"dataNormFilter.INRHC.TI.csv"))

dataNormFilter.SelectIRTIHC = dataNormFilter[(dataNormFilter$IRTI < selThr & dataNormFilter$HCTI == 5)|(dataNormFilter$HCTI < selThr & dataNormFilter$IRTI  == 5),6:15]
summary(dataNormFilter.SelectIRTIHC)
dataNormFilter.SelectIRTIHC
write.csv(dataNormFilter.SelectIRTIHC,file=paste0(inpF,hdr,selThr,"dataNormFilter.IRHC.TI.csv"))

dataNormFilter.SelectINRSIIR = dataNormFilter[(dataNormFilter$INRSI < selThr & dataNormFilter$IRSI == 5)|(dataNormFilter$IRSI < selThr & dataNormFilter$INRSI  == 5),16:25]
summary(dataNormFilter.SelectINRSIIR)
dataNormFilter.SelectINRSIIR
write.csv(dataNormFilter.SelectINRSIIR,file=paste0(inpF,hdr,selThr,"dataNormFilter.INRIR.SI.csv"))

dataNormFilter.SelectINRSIHC = dataNormFilter[(dataNormFilter$INRSI < selThr & dataNormFilter$HCSI == 5)|(dataNormFilter$HCSI < selThr & dataNormFilter$INRSI  == 5),c(16:20,26:30)]
summary(dataNormFilter.SelectINRSIHC)
dataNormFilter.SelectINRSIHC
write.csv(dataNormFilter.SelectINRSIHC,file=paste0(inpF,hdr,selThr,"dataNormFilter.INRHC.SI.csv"))

dataNormFilter.SelectIRSIHC = dataNormFilter[(dataNormFilter$IRSI < selThr & dataNormFilter$HCSI == 5)|(dataNormFilter$HCSI < selThr & dataNormFilter$IRSI  == 5),21:30]
summary(dataNormFilter.SelectIRSIHC)
dataNormFilter.SelectIRSIHC
write.csv(dataNormFilter.SelectIRSIHC,file=paste0(inpF,hdr,selThr,"dataNormFilter.IRHC.SI.csv"))
```

```{r ROTS-dataNormFilter.SelectIRSIHC, echo = FALSE}
#BiocManager::install("ROTS")#, version = "3.8")
dataNormImpCom<-dataNormFilter.SelectIRSIHC#[is.na(dataNormImpCom)]=5
summary(dataNormImpCom)
factors<-c(1,1,1,1,1,2,2,2,2,2)
library(ROTS)
results = ROTS(data = dataNormImpCom, groups = factors , B = 250 , K = 250 , seed = 42)
write.csv(summary(results, fdr = 1),file=paste0(inpF,hdr,selThr,"dataNormFilter.SelectIRSIHC.rots.csv"))
names(results) 
summary(results, fdr = 0.05)
plot(results, fdr = 0.2, type = "pca")
plot(results, type = "volcano",fdr = 0.05)
plot(results, fdr = 0.2, type = "heatmap")#,na.rm=T)#,col=rainbow(4))
```

```{r ROTS-dataNormFilter.SelectINRSIHC, echo = FALSE}
#BiocManager::install("ROTS")#, version = "3.8")
dataNormImpCom<-dataNormFilter.SelectINRSIHC#[is.na(dataNormImpCom)]=5
summary(dataNormImpCom)
factors<-c(1,1,1,1,1,2,2,2,2,2)
library(ROTS)
results = ROTS(data = dataNormImpCom, groups = factors , B = 250 , K = 250 , seed = 42)
write.csv(summary(results, fdr = 1),file=paste0(inpF,hdr,selThr,"dataNormFilter.SelectINRSIHC.rots.csv"))
names(results) 
summary(results, fdr = 0.05)
plot(results, fdr = 0.2, type = "pca")
plot(results, type = "volcano",fdr = 0.05)
plot(results, fdr = 0.2, type = "heatmap")#,na.rm=T)#,col=rainbow(4))
```

```{r ROTS-dataNormFilter.SelectINRSIIR, echo = FALSE}
#BiocManager::install("ROTS")#, version = "3.8")
dataNormImpCom<-dataNormFilter.SelectINRSIIR#[is.na(dataNormImpCom)]=5
summary(dataNormImpCom)
factors<-c(1,1,1,1,1,2,2,2,2,2)
library(ROTS)
results = ROTS(data = dataNormImpCom, groups = factors , B = 250 , K = 250 , seed = 42)
write.csv(summary(results, fdr = 1),file=paste0(inpF,hdr,selThr,"dataNormFilter.SelectINRSIIR.rots.csv"))
names(results) 
summary(results, fdr = 0.05)
plot(results, fdr = 0.2, type = "pca")
plot(results, type = "volcano",fdr = 0.05)
plot(results, fdr = 0.2, type = "heatmap")#,na.rm=T)#,col=rainbow(4))
```


```{r ROTS-dataNormFilter.SelectIRTIHC, echo = FALSE}
#BiocManager::install("ROTS")#, version = "3.8")
dataNormImpCom<-dataNormFilter.SelectIRTIHC#[is.na(dataNormImpCom)]=5
summary(dataNormImpCom)
factors<-c(1,1,1,1,1,2,2,2,2,2)
library(ROTS)
results = ROTS(data = dataNormImpCom, groups = factors , B = 250 , K = 250 , seed = 42)
write.csv(summary(results, fdr = 1),file=paste0(inpF,hdr,selThr,"dataNormFilter.SelectIRTIHC.rots.csv"))
names(results) 
summary(results, fdr = 0.05)
plot(results, fdr = 0.2, type = "pca")
plot(results, type = "volcano",fdr = 0.05)
plot(results, fdr = 0.2, type = "heatmap")#,na.rm=T)#,col=rainbow(4))
```

```{r ROTS-dataNormFilter.SelectINRTIHC, echo = FALSE}
#BiocManager::install("ROTS")#, version = "3.8")
dataNormImpCom<-dataNormFilter.SelectINRTIHC#[is.na(dataNormImpCom)]=5
summary(dataNormImpCom)
factors<-c(1,1,1,1,1,2,2,2,2,2)
library(ROTS)
results = ROTS(data = dataNormImpCom, groups = factors , B = 250 , K = 250 , seed = 42)
write.csv(summary(results, fdr = 1),file=paste0(inpF,hdr,selThr,"dataNormFilter.SelectINRTIHC.rots.csv"))
names(results) 
summary(results, fdr = 0.05)
plot(results, fdr = 0.2, type = "pca")
plot(results, type = "volcano",fdr = 0.05)
plot(results, fdr = 0.2, type = "heatmap")#,na.rm=T)#,col=rainbow(4))
```

```{r ROTS-dataNormFilter.SelectINRTIIR, echo = FALSE}
#BiocManager::install("ROTS")#, version = "3.8")
dataNormImpCom<-dataNormFilter.SelectINRTIIR#[is.na(dataNormImpCom)]=5
summary(dataNormImpCom)
factors<-c(1,1,1,1,1,2,2,2,2,2)
library(ROTS)
results = ROTS(data = dataNormImpCom, groups = factors , B = 250 , K = 250 , seed = 42)
write.csv(summary(results, fdr = 1),file=paste0(inpF,hdr,selThr,"dataNormFilter.SelectINRTIIR.rots.csv"))
names(results) 
summary(results, fdr = 0.05)
plot(results, fdr = 0.2, type = "pca")
plot(results, type = "volcano",fdr = 0.05)
plot(results, fdr = 0.2, type = "heatmap")#,na.rm=T)#,col=rainbow(4))
```



```{r euler,echo=F}
#install.packages('eulerr')
library(eulerr)

euler(dataNormFilter[,31:33]<selThr,shape="ellipse")$original.values
plot(euler(dataNormFilter[,31:33]<selThr,shape="ellipse"),quantities=TRUE, main="Identified Protein Groups in TI")
vplot<-plot(euler(dataNormFilter[,31:33]<selThr,shape="ellipse"),quantities=TRUE, main="Identified Protein Groups in TI")
ggsave(file=paste0(inpF,hdr,"venn.TI.svg"),plot=vplot)#,  width=6, height=6)

euler(dataNormFilter[,34:36]<selThr,shape="ellipse")$original.values
plot(euler(dataNormFilter[,34:36]<selThr,shape="ellipse"),quantities=TRUE, main="Identified Protein Groups in TI")
vplot<-plot(euler(dataNormFilter[,34:36]<selThr,shape="ellipse"),quantities=TRUE, main="Identified Protein Groups in TI")
ggsave(file=paste0(inpF,hdr,"venn.SI.svg"),plot=vplot)#,  width=6, height=6)
```




```{r imputeFilter, echo = FALSE}
dataNormImpFilter<-dataNormFilter.Select
summary(dataNormImpFilter)
set.seed(1)
#dataNormImpFilter[is.na(dataNormImpFilter)]<-rnorm(sum(is.na(dataNormImpFilter)),mean=mean(dataNormImpFilter[!is.na(dataNormImpFilter)])-3,sd=sd(!is.na(dataNormImpFilter))/3)
dataNormImpFilter[is.na(dataNormImpFilter)]<-rnorm(sum(is.na(dataNormImpFilter)),mean=mean(dataNormImpFilter[!is.na(dataNormImpFilter)])-12,sd=sd(!is.na(dataNormImpFilter))/12)
summary(dataNormImpFilter)
hist(as.matrix(dataNormImpFilter))
```

```{r PCA, echo = FALSE}
dataNormImpCom<-dataNormImpFilter
plot(princomp(dataNormImpCom))
biplot(prcomp(as.matrix(t(dataNormImpCom)),scale = T))
biplot(prcomp(dataNormImpCom,scale = F))
biplot(prcomp(dataNormImpCom,scale = T),col=c(1,8), cex=c(0.5, 0.4))
```


```{r t-test, echo = FALSE}
pVal = apply(dataNormImpFilter, 1, function(x) t.test(as.numeric(x[c(3:5)]),as.numeric(x[c(1,2,6)]),var.equal=T)$p.value)
logFC = rowMeans(dataNormImpFilter[,c(3:5)])-rowMeans(dataNormImpFilter[,c(1,2,6)])
ttest.results = data.frame(gene=rownames(dataNormImpFilter),logFC=logFC,P.Value = pVal, adj.pval = p.adjust(pVal,method = "BH")) 
#ttest.results$PSMcount = psm.count.table[ttest.results$gene,"count"]
ttest.results = ttest.results[with(ttest.results, order(P.Value)), ]
head(ttest.results)
write.csv(ttest.results,file=paste0(inpD,hdr,"tTestBH.csv"))
plot(logFC,-log10(pVal))
plot(logFC,-log10(pVal),col="orange",)
dsub=subset(ttest.results,ttest.results$P.Value<0.05&abs(ttest.results$logFC)>0.58)
#rn<-do.call(rbind, strsplit(rownames(dsub), '\\.'))
rn<-strsplit(rownames(dsub), ';')
row.names(dsub) <- sapply(rn, "[", 1)#rn[[1]]
#g = ggplot(ttest.results,aes(logFC,-log10(P.Value)))+geom_point(aes(color=adj.pval)) + theme_bw(base_size=10) +geom_text(data=dsub,aes(label=row.names(dsub)),position = position_dodge(width=0.5), vjust=0.5, size=1) + xlab("Log2 Fold Change")  + ylab("-Log10 P-value") + ggtitle("Differentially expressed proteins") + scale_size_area()+scale_color_gradientn(colours = rainbow(4))
#g = ggplot(ttest.results,aes(logFC,-log10(P.Value)))+geom_point(aes(color=adj.pval)) + theme_bw(base_size=10) +geom_text(data=dsub,aes(label=row.names(dsub)), vjust=0.5, size=2) + xlab("Log2 Fold Change (Red-White)")  + ylab("-Log10 P-value") + ggtitle("Differentially expressed proteins") + scale_size_area()+scale_color_gradient(low="#FF9933", high="#99CC66")
#g = ggplot(ttest.results,aes(logFC,-log10(P.Value)))+geom_point(aes(color=adj.pval)) + theme_bw(base_size=10) +geom_text(data=dsub,aes(label=row.names(dsub)), vjust=0.5, size=2) + xlab("Log2 Fold Change (Red-White)")  + ylab("-Log10 P-value") + ggtitle("Differentially expressed proteins") + scale_size_area()+scale_color_gradient(low="#FF9933", high="#FFFFFF")+geom_point(alpha = 0.05)
g = ggplot(ttest.results,aes(logFC,-log10(P.Value)))+geom_point(aes(color=adj.pval),size=0.15) + theme_bw(base_size=10) +geom_text(data=dsub,aes(label=row.names(dsub)), vjust=0.5, size=1.5) + xlab("Log2 Fold Change (Red-White)")  + ylab("-Log10 P-value") + ggtitle("Differentially expressed proteins") + scale_size_area()+scale_color_gradient(low="#FF9933", high="#99CC66")
plot(g)
#install.packages("svglite")
#library(svglite)
ggsave(file=paste0(inpD,hdr,"volcanoPlot.svg"),plot=g)#,  width=6, height=6)
```



```{r imputeFilter-ttest, echo = FALSE}
pairwise.t.test(as.matrix(dataNormImpFilter),c(0,0,1,1,1,0))#[1,3:5],dataNormImpFilter[1,c(1,2,6)])
```

```{r write-output, echo = FALSE}
write.table(dataNorm,file=paste0(inpD,"log2data.txt"), sep = "\t")
#dump(dataNorm,file=paste0(inpD,"dataNorm.R"))
```




```{r DEqMS}
#https://rdrr.io/bioc/DEqMS/f/vignettes/DEqMS-package-vignette.Rmd
#install.packages("BiocManager")
#BiocManager::install("DEqMS")
library(DEqMS)
dat.log=dataNormImpFilter
boxplot(dat.log,las=2,main="")
cond = as.factor(c("w","w","r","r","r","w"))
design = model.matrix(~0+cond) # 0 means no intercept for the linear model
colnames(design) = gsub("cond","",colnames(design))
x <- c("r-w")
contrast =  makeContrasts(contrasts=x,levels=design)
fit1 <- lmFit(dat.log, design)
fit2 <- contrasts.fit(fit1,contrasts = contrast)
fit3 <- eBayes(fit2)
df.prot=dataClean[dataNormFilter$Red<selThr | dataNormFilter$White<selThr,]
library(matrixStats)
count_columns = "MS.MS.count."
#psm.count.table = data.frame(count = rowMins(as.matrix(df.prot[,grep(count_columns, names(df.prot))])))+1
#rownames(fit3$coefficients)
fit3$count = rowMins(as.matrix(df.prot[,grep(count_columns, names(df.prot))]))+1
fit4 = spectraCounteBayes(fit3)
# n=30 limits the boxplot to show only proteins quantified by <= 30 PSMs.
VarianceBoxplot(fit4,n=30,main=inpD,xlab="PSM count")
VarianceScatterplot(fit4,main=inpD)
DEqMS.results = outputResult(fit4,coef_col = 1)
#if you are not sure which coef_col refers to the specific contrast,type
head(fit4$coefficients)
# a quick look on the DEqMS results table
head(DEqMS.results)
# Save it into a tabular text file
write.table(DEqMS.results,paste0(inpD,hdr,"DEqMS.results.txt"),sep = "\t",row.names = F,quote=F)
#install.packages("ggrepel")
library(ggrepel)
# Use ggplot2 allows more flexibility in plotting
DEqMS.results$log.sca.pval = -log10(DEqMS.results$sca.P.Value)
ggplot(DEqMS.results, aes(x = logFC, y =log.sca.pval )) + 
    geom_point(size=0.5 )+
    theme_bw(base_size = 16) + # change theme
    xlab(expression("log2(red/white)")) + # x-axis label
    ylab(expression(" -log10(P-value)")) + # y-axis label
    geom_vline(xintercept = c(-1,1), colour = "red") + # Add fold change cutoffs
    geom_hline(yintercept = 2, colour = "red") + # Add significance cutoffs
    geom_vline(xintercept = 0, colour = "black") + # Add 0 lines
    scale_colour_gradient(low = "black", high = "black", guide = FALSE)+
    geom_text_repel(data=subset(DEqMS.results, abs(logFC)>1&log.sca.pval > 2),
                    aes( logFC, log.sca.pval ,label=gene)) # add gene label

#fit4$p.value = fit4$sca.p
#volcanoplot(fit4,coef=1, style = "p-value", highlight = 10,names=rownames(fit4$coefficients))
```

```{r DEqMS-peptides}
fit3$count = rowMins(as.matrix(df.prot[,grepl("^Peptides\\.[0-9]+", names(df.prot))]))+1
min(fit3$count)

fit4 = spectraCounteBayes(fit3)
VarianceBoxplot(fit4, n=20, main = hdr,xlab="peptide count + 1")
DEqMS.results = outputResult(fit4,coef_col = 1)
DEqMS.results$Gene.name = df.prot[DEqMS.results$gene,]$Gene.names
head(DEqMS.results)
write.table(DEqMS.results,paste0(inpD,hdr,"R-W.DEqMS.pep.results.txt"),sep = "\t",row.names = F,quote=F)
head(DEqMS.results)
VarianceBoxplot(fit4,n=20)
#peptideProfilePlot(dat=df.prot)#,col=2,gene="TGFBR2")
VarianceScatterplot(fit4, xlab="log2(LFQ)")
limma.prior = fit4$s2.prior
abline(h = log(limma.prior),col="green",lwd=3 )
legend("topright",legend=c("DEqMS prior variance","Limma prior variance"),
        col=c("red","green"),lwd=3)
op <- par(mfrow=c(1,2), mar=c(4,4,4,1), oma=c(0.5,0.5,0.5,0))
Residualplot(fit4,  xlab="log2(PSM count)",main="DEqMS")
x = fit3$count
y = log(limma.prior) - log(fit3$sigma^2)
plot(log2(x),y,ylim=c(-6,2),ylab="Variance(estimated-observed)", pch=20, cex=0.5,
     xlab = "log2(PSMcount)",main="Limma")
#install.packages("LSD")
library(LSD)
op <- par(mfrow=c(1,2), mar=c(4,4,4,1), oma=c(0.5,0.5,0.5,0))
x = fit3$count
y = fit3$s2.post
heatscatter(log2(x),log(y),pch=20, xlab = "log2(PSMcount)", 
     ylab="log(Variance)",
     main="Posterior Variance in Limma")

y = fit4$sca.postvar
heatscatter(log2(x),log(y),pch=20, xlab = "log2(PSMcount)",
     ylab="log(Variance)", 
     main="Posterior Variance in DEqMS")

```


```{r MSstats, echo = FALSE}
#https://bioconductor.org/packages/3.3/bioc/vignettes/MSstats/inst/doc/MSstats-manual.pdf
library('MSstats')
QuantData<-dataProcess(SRMRawData)
head(QuantData$ProcessedData)
## based on multiple comparisons (T1 vs T3; T1 vs T7; T1 vs T9)
comparison1<-matrix(c(-1,0,1,0,0,0,0,0,0,0),nrow=1)
comparison2<-matrix(c(-1,0,0,0,0,0,1,0,0,0),nrow=1)
comparison3<-matrix(c(-1,0,0,0,0,0,0,0,1,0),nrow=1)
comparison<-rbind(comparison1,comparison2, comparison3)
row.names(comparison)<-c("T3-T1","T7-T1","T9-T1")
testResultMultiComparisons<-groupComparison(contrast.matrix=comparison,data=QuantData)
## Calculate sample size for future experiments:
#(1) Minimal number of biological replicates per condition
designSampleSize(data=testResultMultiComparisons$fittedmodel,numSample=TRUE,
desiredFC=c(1.25,1.75),FDR=0.05,power=0.8)
#(2) Power calculation
designSampleSize(data=testResultMultiComparisons$fittedmodel,numSample=2,
desiredFC=c(1.25,1.75),FDR=0.05,power=TRUE)```
```

```{r SAM, echo = FALSE}
#https://github.com/MikeJSeo/SAM
install.packages(c("samr", "matrixStats", "GSA", "shiny", "shinyFiles", "openxlsx"))
source("http://bioconductor.org/biocLite.R")
biocLite("impute")
library(shiny)
library(shinyFiles)
runGitHub("SAM", "MikeJSeo")
```




```{r NA}
#impute(data, method = "mixed",randna = fData(naset)$randna,mar = "knn", mnar = "min")
md.pattern(datasel)
dataimp <- mice(datasel,m=length(colnames(datasel))/2,maxit=length(colnames(datasel)),meth='pmm',seed=1)
dataimp <- complete(dataimp,length(colnames(datasel))/2)
heatmap(as.matrix(dataimp),col=colscl)
```

```{r Scale}
datascale=t(scale(t(dataimp))) # takes away the polynomial in YFP data
heatmap(as.matrix(datascale),col=colscl)
```

```{r DistCor}
dataasmat<-data.matrix(datascale)
cor(data)
dissimilarityc <- 1 - cor(dataasmat,method = "s")
distancec <- as.dist(dissimilarityc)
col.clus <- hclust(distancec, "aver")
dissimilarityr <- 1 - cor(t(dataasmat),method = "s")
distancer <- as.dist(dissimilarityr)
row.clus <- hclust(distancer, "aver")
heatmap(as.matrix(datascale),col=colscl)
cr <- rainbow(nrow(dataasmat))
cc <- rainbow(ncol(dataasmat))
heatmap((na.omit(dataasmat)), RowSideColors = cr, ColSideColors = cc,Rowv = as.dendrogram(row.clus), Colv = as.dendrogram(col.clus),cexRow=1.5,cexCol=1.5 )
```


```{r Quantile}
dataasmat<-normalize.quantiles(dataasmat)
rn<-rownames(dataasmat)
cn<-colnames(dataasmat)
colnames(dataasmat)<-cn
rownames(dataasmat)<-rn
```

```{r AdjPval}
p.adjust(10^(-data$X.log10P),method = c("hochberg"), n = length(data$X.log10P))
p.adjust(data$pv,method = c("hochberg"), n = length(data$pv))
```



```{r ROTS, echo = FALSE}
#install.packages("BiocManager")
#BiocManager::install("ROTS", version = "3.8")
#BiocManager::install("ROTS")
dataNormImpCom<-yyt
#dataNormImpCom[dataNormImpCom==0]=5
summary(dataNormImpCom)
library(ROTS)
input = dataNormImpCom
#colnames(dataNormImpCom)<-sub("X","",colnames(dataNormImpCom))
colnames(dataNormImpCom)
groups = label#$Code
groups
results = ROTS(data = dataNormImpCom, groups = as.numeric(groups$Location) , B = 250 , K = 1000 , seed = 42)
names(results) 
fdrThr<-0.01
uniP<-summary(results, fdr = fdrThr)
#?plot
#plot(results, fdr = fdrThr, type = "volcano")
plot(results, fdr = fdrThr, type = "heatmap")
```






```{r randomtree}
set.seed(42)
yy<-rbind(y$data,label$Treatment)
yyt<-t(yy)
summary(yyt)

yyt=as.data.frame(yyt)
colnames(yyt) <- gsub(";", "_", colnames(yyt))
colnames(yyt) <- gsub(":", "__", colnames(yyt))
colnames(yyt) <- gsub("-", "___", colnames(yyt))
summary(yyt)
ind=sample(2,nrow(yyt),replace=TRUE,prob=c(0.75,0.25))
yyt.training=yyt[ind==1,]
yyt.test=yyt[ind==2,]

library("rpart")
library("rpart.plot")
tree=rpart(data=yyt.training,V4500~.,method="class",control=rpart.control(minsplit=10,minbucket=5),parms=list(split="information"))
rpart.plot(tree,main="Classification tree for the yyt data (using 75% of data as training set)",extra=101)


library(randomForest)
set.seed(42)
#yyt=as.data.frame(yyt)
random_forest=randomForest(data=yyt.training,V4500~.,impurity='gini',ntree=200,replace=TRUE)
print(random_forest)

plot(random_forest)
legend("top",cex=0.8,legend=colnames(random_forest$err.rate),lty=c(1,2,3),col=c(1,2,3),horiz=T)

predictions=predict(random_forest,newdata=yyt.training,type="class")
actuals=yyt.training$V4500
table(actuals,predictions)

accuracy=sum(diag(confusion.matrix))/sum(confusion.matrix)
print(accuracy)

sort(importance(random_forest))
varImpPlot(random_forest)
#qplot(RCN1,GALNT2,data=yyt,colour=class,size=I(3))
```


```{r write}
#install.packages('dplyr')
#library(dplyr)
colnames(y$data)
yy<-rbind(y$data,label$Treatment)
yy<-t(yy)
write.csv(yy,paste0(inpF,".scaleWithclass.csv"))
```

